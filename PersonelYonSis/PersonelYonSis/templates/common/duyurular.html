<div class="card shadow-sm h-100" id="duyurularCard" data-page-size="10" data-active-app="{{ aktif_uygulama|default_if_none:'' }}">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">
      <i class="bi bi-megaphone"></i>
      Duyurular ve Güncellemeler
    </h5>
    <div class="d-flex gap-2 align-items-center flex-nowrap">
      <select id="appFilter" class="form-select form-select-sm" style="min-width: 160px;">
        <option value="">Tümü</option>
        {% for app in uygulama_listesi %}
          <option value="{{ app }}" {% if aktif_uygulama == app %}selected{% endif %}>{{ app }}</option>
        {% endfor %}
      </select>
      {% if can_add_duyuru %}
      <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#duyuruModal">
        <i class="bi bi-plus-circle"></i>
        Duyuru Ekle
      </button>
      {% endif %}
    </div>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th style="width: 140px;">Uygulama</th>
            <th>Duyuru</th>
            <th style="width: 140px;">Oluşturan</th>
            <th style="width: 140px;">Tarih</th>
          </tr>
        </thead>
        <tbody id="duyurularTableBody" data-announcement-table>
          {% for d in duyurular %}
          <tr data-announcement-row data-app="{{ d.uygulama }}">
            <td class="fw-semibold text-uppercase">{{ d.uygulama }}</td>
            <td>{{ d.duyuru_metni }}</td>
            <td>{{ d.olusturan|default:"-" }}</td>
            <td>{{ d.olusturma_tarihi|date:"d.m.Y H:i" }}</td>
          </tr>
          {% empty %}
          <tr data-empty-row>
            <td colspan="4" class="text-center text-muted py-4">Henüz duyuru bulunmuyor.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <div class="card-footer bg-white border-top">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-center gap-2">
      <small class="text-muted" data-duyuru-counter></small>
      <nav aria-label="Duyuru sayfalama">
        <ul class="pagination pagination-sm mb-0" id="duyuruPagination" data-pagination></ul>
      </nav>
    </div>
  </div>
</div>

<div class="modal fade" id="duyuruModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title">
          <i class="bi bi-plus-circle"></i>
          Yeni Duyuru
        </h5>
        <button class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        <form id="duyuruForm">
          {% csrf_token %}
          <label class="form-label">Uygulama</label>
          <input name="uygulama" class="form-control" placeholder="Örn: mercis657" required maxlength="100">
          <label class="form-label mt-3">Duyuru Metni</label>
          <textarea name="duyuru_metni" class="form-control" rows="4" required></textarea>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">İptal</button>
        <button class="btn btn-success" id="duyuruKaydetBtn">
          <i class="bi bi-check"></i>
          Kaydet
        </button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  if (window.__duyurularWidgetInitialized) {
    return;
  }
  window.__duyurularWidgetInitialized = true;

  const card = document.getElementById("duyurularCard");
  if (!card) {
    return;
  }

  const PAGE_SIZE = parseInt(card.dataset.pageSize || "10", 10);
  const tbody = card.querySelector("[data-announcement-table]");
  const rows = Array.from(tbody.querySelectorAll("[data-announcement-row]"));
  const emptyRow = card.querySelector("[data-empty-row]");
  const counterEl = card.querySelector("[data-duyuru-counter]");
  const paginationEl = card.querySelector("[data-pagination]");
  const appFilter = document.getElementById("appFilter");
  const activeApp = card.dataset.activeApp || "";

  let filteredRows = [...rows];
  let currentPage = 1;

  function updateCounter() {
    if (!counterEl) {
      return;
    }
    if (!filteredRows.length) {
      counterEl.textContent = "Kayıt bulunamadı.";
      return;
    }
    counterEl.textContent = `${filteredRows.length} duyuru listeleniyor.`;
  }

  function showRows() {
    rows.forEach(row => row.classList.add("d-none"));
    const start = (currentPage - 1) * PAGE_SIZE;
    const pageSlice = filteredRows.slice(start, start + PAGE_SIZE);
    pageSlice.forEach(row => row.classList.remove("d-none"));
    if (emptyRow) {
      emptyRow.classList.toggle("d-none", Boolean(pageSlice.length));
      if (!pageSlice.length) {
        emptyRow.querySelector("td").textContent = filteredRows.length ? "Bu sayfada kayıt bulunmuyor." : "Henüz duyuru bulunmuyor.";
      }
    }
  }

  function buildPageButton(label, targetPage, disabled = false, active = false) {
    const li = document.createElement("li");
    li.className = `page-item${disabled ? " disabled" : ""}${active ? " active" : ""}`;
    const btn = document.createElement("button");
    btn.className = "page-link";
    btn.type = "button";
    btn.textContent = label;
    btn.addEventListener("click", function () {
      if (disabled || active || targetPage === currentPage) return;
      currentPage = targetPage;
      refreshTable();
    });
    li.appendChild(btn);
    return li;
  }

  function renderPagination() {
    if (!paginationEl) {
      return;
    }
    paginationEl.innerHTML = "";
    const totalPages = Math.max(1, Math.ceil(filteredRows.length / PAGE_SIZE));
    if (totalPages <= 1) {
      paginationEl.parentElement.classList.add("invisible");
      return;
    }
    paginationEl.parentElement.classList.remove("invisible");

    paginationEl.appendChild(buildPageButton("«", Math.max(1, currentPage - 1), currentPage === 1));

    const maxVisible = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let endPage = startPage + maxVisible - 1;
    if (endPage > totalPages) {
      endPage = totalPages;
      startPage = Math.max(1, endPage - maxVisible + 1);
    }

    for (let page = startPage; page <= endPage; page++) {
      paginationEl.appendChild(buildPageButton(page.toString(), page, false, page === currentPage));
    }

    paginationEl.appendChild(buildPageButton("»", Math.min(totalPages, currentPage + 1), currentPage === totalPages));
  }

  function updateHistory(value) {
    const url = new URL(window.location.href);
    if (value) {
      url.searchParams.set("uygulama", value);
    } else {
      url.searchParams.delete("uygulama");
    }
    window.history.replaceState({}, "", url);
  }

  function applyFilter(value) {
    filteredRows = value ? rows.filter(row => row.dataset.app === value) : [...rows];
    currentPage = 1;
    refreshTable();
    updateHistory(value);
  }

  function refreshTable() {
    updateCounter();
    renderPagination();
    showRows();
  }

  if (activeApp && appFilter) {
    appFilter.value = activeApp;
    applyFilter(activeApp);
  } else {
    refreshTable();
  }

  if (appFilter) {
    appFilter.addEventListener("change", function () {
      applyFilter(this.value);
    });
  }

  const duyuruForm = document.getElementById("duyuruForm");
  const duyuruKaydetBtn = document.getElementById("duyuruKaydetBtn");
  const duyuruModalEl = document.getElementById("duyuruModal");

  function getCookie(name) {
    const cookies = document.cookie ? document.cookie.split("; ") : [];
    for (let i = 0; i < cookies.length; i++) {
      const parts = cookies[i].split("=");
      const key = decodeURIComponent(parts[0]);
      if (key === name) {
        return decodeURIComponent(parts[1]);
      }
    }
    return null;
  }

  if (duyuruKaydetBtn && duyuruForm) {
    duyuruKaydetBtn.addEventListener("click", function (event) {
      event.preventDefault();
      if (duyuruKaydetBtn.disabled) {
        return;
      }

      const formData = new FormData(duyuruForm);
      duyuruKaydetBtn.disabled = true;
      duyuruKaydetBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Kaydediliyor';

      fetch("/duyurular/ekle/", {
        method: "POST",
        body: formData,
        credentials: "same-origin",
        headers: {
          "X-CSRFToken": getCookie("csrftoken") || ""
        }
      })
      .then(response => response.json().then(data => ({ ok: response.ok, data })))
      .then(({ ok, data }) => {
        if (!ok || data.status !== "success") {
          throw new Error(data.message || "Duyuru kaydedilemedi.");
        }

        const modalInstance = window.bootstrap ? window.bootstrap.Modal.getInstance(duyuruModalEl) || new window.bootstrap.Modal(duyuruModalEl) : null;
        if (modalInstance) {
          modalInstance.hide();
        }
        duyuruForm.reset();
        Swal.fire("Başarılı", data.message, "success").then(() => window.location.reload());
      })
      .catch(error => {
        Swal.fire("Hata", error.message || "Beklenmedik bir hata oluştu.", "error");
      })
      .finally(() => {
        duyuruKaydetBtn.disabled = false;
        duyuruKaydetBtn.innerHTML = '<i class="bi bi-check"></i> Kaydet';
      });
    });
  }
});
</script>

