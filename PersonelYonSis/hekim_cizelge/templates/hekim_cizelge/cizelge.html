<!-- hekim_cizelge/templates/hekim_cizelge/cizelge.html -->
{% extends "base.html" %}
{% load static %}
{% load hekim_filters %}
{% block title %}Hekim Çizelge İşlemleri{% endblock %}

{% block content %}
<br>
<div class="container-fluid">
    <!-- Üst Kısım: Ay, Yıl ve Birim Seçimi -->
    <div class="row mb-n1">
        <div class="col-md-1">
            <label for="selectYear">Yıl Seçimi</label>
            <select id="selectYear" class="form-control">
                {% for year in years %}
                <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-1">
            <label for="selectMonth">Ay Seçimi</label>
            <select id="selectMonth" class="form-control">
                {% for month in months %}
                <option value="{{ month.value }}" {% if month.value == current_month %}selected{% endif %}>
                    {{ month.label }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label for="selectBirim">Birim Seçimi</label>
            <select id="selectBirim" class="form-control">
                {% for birim in birimler %}
                <option value="{{ birim.BirimID }}" {% if birim.BirimID == selected_birim.BirimID %}selected{% endif %}>
                    {{ birim.BirimAdi }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-1 text-end">
            <br>
            <button class="btn btn-primary" id="filterButton">Sorgula</button>
        </div>
        
        <!-- Hizmet, İzin ve Hekim seçimi (approval modda gizli) -->
        {% if not is_approval_mode %}
        <div class="col-md-3">
            <div class="row">
                <div class="col-6">
                    <div id="hizmetSelectionDiv">
                        <label for="hizmetSelection">Hizmet Seçimi</label>
                        <select id="hizmetSelection" class="form-control">
                            <option value="">Hizmet Seçin</option>
                            {% for hizmet in hizmetler %}
                                <option value="{{ hizmet.HizmetID }}" data-varsayilan-sunulur="{{ hizmet.VarsayilanHizmetleSunulur|yesno:'true,false' }}">{{ hizmet.HizmetName }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-6">
                    <div id="izinSelectionDiv">
                        <label for="izinSelection">İzin Seçimi</label>
                        <select id="izinSelection" class="form-control">
                            <option value="">İzin Seçin</option>
                            {% for izin in izinler %}
                                <option value="{{ izin.IzinID }}" data-color="{{ izin.IzinRenk }}">{{ izin.IzinTipi }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div id="hekimSelectionDiv" style="display: none;">
                    <label for="hekimSelection">Hekim Seçimi</label>
                    <select id="hekimSelection" class="form-control">
                        <option value="">Hekim Seçin</option>
                        {% for personel in personeller %}
                            <option value="{{ personel.PersonelID }}">{{ personel.PersonelName }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <!-- Alanı boşalt seçeneği -->
            <div class="form-check form-switch mt-2">
                <input class="form-check-input" type="checkbox" id="clearSelection">
                <label class="form-check-label" for="clearSelection">
                    Alanı boşalt
                </label>
            </div>
        </div>
        {% endif %}
        
        <div class="col-md-4 text-end">
            <br>
            {% if not is_approval_mode %}
            <button class="btn btn-info me-2 btn-sm" id="autoFillDefault">
                <i class="bi bi-calendar-plus"></i> Varsayılan Hizmet Doldur
            </button>
            <button class="btn btn-warning me-2 btn-sm" id="checkConsistency">
                <i class="bi bi-shield-check"></i> Tutarlılık Kontrolü
            </button>
            <button class="btn btn-primary btn-sm" id="toggleView">
                <i class="bi bi-arrow-repeat"></i> Görünümü Değiştir
            </button>
            {% else %}
            <button class="btn btn-primary" id="topluOnayButton">
                <i class="bi bi-check-all"></i> Tüm Değişiklikleri Onayla
            </button>
            {% endif %}
            <button class="btn btn-success btn-sm" id="saveButton">Kaydet</button>
        </div>
    </div>

    <!-- Üst kısma onay durumu göstergesi ekleyelim -->
    <div class="row mb-2">
        <div class="col-md-2">
            <div id="onayDurumu" class="alert alert-info" style="display: none;">
                Onay Durumu: <span id="onayDurumuText"></span>
            </div>
        </div>
    </div>

    <div class="row mb-2 align-items-center">
        <!-- Seçilen Birim ve Checkbox yan yana -->
        <div class="col-auto d-flex align-items-center gap-3">
            <div id="selectedBirim" class="mb-0 me-3">
                {% if selected_birim %}
                    Seçilen Birim: {{ selected_birim.BirimAdi }} (<span id="viewModeText">Hekim Bazlı Görünüm</span>)
                {% endif %}
            </div>
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" id="showApprovalIcons">
                <label class="form-check-label" for="showApprovalIcons">
                    Liste Değişiklik Onaylarını Göster
                </label>
            </div>
        </div>
    </div>

    <!-- Hekim Bazlı Tablo -->
    <div id="hekimView">
        <table id="cizelgeTable" class="table table-sm table-bordered table-hover">
            <thead class="table-light">
                <tr>
                    <th>Gün</th>
                    <th>Tarih</th>
                    {% for personel in personeller %}
                    <th>{{ personel.PersonelName }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for day in days %}
                <tr class="
                    {% if day.is_weekend %}weekend{% endif %}
                    {% if day.is_holiday %} holiday-row{% endif %}
                ">
                    <td>{{ day.day_num }}</td>
                    <td>{{ day.full_date }}</td>
                    {% for personel in personeller %}
                    <!-- Mesai hücresi içeriği -->
<td {% if not is_approval_mode %}contenteditable="true"{% endif %} 
    data-personel-id="{{ personel.PersonelID }}" 
    data-date="{{ day.full_date }}"
    data-mesai-id="{% for mesai in personel.mesai_data %}{% if mesai.MesaiDate == day.full_date %}{{ mesai.MesaiID }}{% endif %}{% endfor %}"
    class="mesai-cell position-relative">
    {% for mesai in personel.mesai_data %}
        {% if mesai.MesaiDate == day.full_date %}
            <span class="position-absolute top-0 end-0 p-1 approval-icon" style="display:none;">
                <i class="bi bi-check-circle-fill {% if mesai.OnayDurumu == 1 %}text-success{% else %}text-warning{% endif %}"></i>
            </span>
            {% if mesai.Izin %}
                <span class="badge {{ mesai.Izin.renk }}">{{ mesai.Izin.tip }}</span>
            {% else %}
                {% for hizmet in mesai.Hizmetler %}
                    {% if hizmet.is_varsayilan %}
                        <span class="badge bg-primary">{{ hizmet.name }}</span>
                    {% elif hizmet.type == 'Nöbet' %}
                        <span class="badge text-bg-danger">{{ hizmet.name }}</span>
                    {% elif hizmet.type == 'İcap' %}
                        <span class="badge text-bg-info">{{ hizmet.name }}</span>
                    {% else %}
                        <span class="badge bg-secondary">{{ hizmet.name }}</span>
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% endif %}
    {% endfor %}
</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Hizmet Bazlı Tablo -->
    <div id="hizmetView" style="display: none;">
        <table id="hizmetTable" class="table table-sm table-bordered table-hover">
            <thead class="table-light">
                <tr>
                    <th>Gün</th>
                    <th>Tarih</th>
                    {% for hizmet in hizmetler %}
                    {% if hizmet.HizmetID != selected_birim.VarsayilanHizmet.HizmetID %}
                    <th>{{ hizmet.HizmetName }}</th>
                    {% endif %}
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for day in days %}
                <tr class="
                    {% if day.is_weekend %}weekend{% endif %}
                    {% if day.is_holiday %} holiday-row{% endif %}
                ">
                    <td>{{ day.day_num }}</td>
                    <td>{{ day.full_date }}</td>
                    {% for hizmet in hizmetler %}
                    {% if hizmet.HizmetID != selected_birim.VarsayilanHizmet.HizmetID %}
                    <td class="hizmet-cell" data-date="{{ day.full_date }}" data-hizmet-id="{{ hizmet.HizmetID }}">
    {% for personel in personeller %}
        {% for mesai in personel.mesai_data %}
            {% if mesai.MesaiDate == day.full_date %}
                {% for hizmet_data in mesai.Hizmetler %}
                    {% if hizmet_data.name == hizmet.HizmetName %}
                        <span class="badge bg-primary">{{ personel.PersonelName }}</span>
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% endfor %}
    {% endfor %}
</td>
                    {% endif %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Değişkenleri tanımla
    var changes = {};
    var deletion = {};
    const varsayilanHizmetID = "{{ selected_birim.VarsayilanHizmet.HizmetID }}";
    const isApprovalMode = {% if is_approval_mode %}true{% else %}false{% endif %};
    
    
    // Onay ikonlarını aç/kapat fonksiyonu
    function toggleApprovalIcons(show) {
        document.querySelectorAll('.approval-icon').forEach(function(el) {
            el.style.display = show ? 'inline-block' : 'none';
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        toggleApprovalIcons(false);

        // Checkbox event listener (DOMContentLoaded içinde olmalı!)
        var approvalCheckbox = document.getElementById('showApprovalIcons');
        if (approvalCheckbox) {
            approvalCheckbox.addEventListener('change', function() {
                toggleApprovalIcons(this.checked);
            });
        }
    });

    // Normal mod işlemleri
    if (!isApprovalMode) {
        // Hücreye tıklama işlemi için event listener
        document.querySelectorAll('.mesai-cell').forEach(function(cell) {
            cell.removeAttribute('contenteditable');  // contenteditable özelliğini kaldır
            cell.addEventListener('click', function() {
                const personelID = this.getAttribute('data-personel-id');
                const date = this.getAttribute('data-date');
                const clearSelection = document.getElementById('clearSelection')?.checked;
                const hizmetID = document.getElementById('hizmetSelection')?.value;
                const izinID = document.getElementById('izinSelection')?.value;

                if (clearSelection) {
                    // Sadece görsel temizleme
                    this.innerHTML = '';
                    
                    // Değişiklikleri kaydet
                    changes[`${personelID}_${date}`] = {
                        type: 'clear',
                        hizmetler: [],
                        izin: null
                    };
                    
                    // Silme işlemini iptal et
                    delete deletion[`${personelID}_${date}`];
                } else if (hizmetID || izinID) {
                    let currentServices = [];
                    let badges = this.getElementsByClassName('badge');
                    
                    // Mevcut hizmetleri topla
                    Array.from(badges).forEach(badge => {
                        let hizmetText = badge.textContent;
                        let option = Array.from(document.getElementById('hizmetSelection').options)
                            .find(opt => opt.textContent === hizmetText);
                        if (option) currentServices.push(option.value);
                    });

                    if (hizmetID) {
                        // VarsayilanHizmetleSunulur kontrolü
                        let selectedOption = document.querySelector(`#hizmetSelection option[value="${hizmetID}"]`);
                        let varsayilanHizmetleSunulur = true;
                        if (selectedOption) {
                            varsayilanHizmetleSunulur = selectedOption.getAttribute('data-varsayilan-sunulur') !== "false";
                        }

                        // Hizmet kombinasyonunu kontrol et
                        const validationResult = validateHizmetCombination(currentServices, hizmetID);
                        if (!validationResult.isValid) {
                            alert(validationResult.errors.join('\n'));
                            return;
                        }

                        // --- DÜZELTME: Standart hizmetlerde mevcut hizmetleri silme, sadece yeni hizmeti ekle ---
                        // VarsayilanHizmetleSunulur kontrolü sadece yeni hizmet varsayılan ile birlikte sunulamaz ise çalışır
                        if (!varsayilanHizmetleSunulur) {
                            // Varsayılan ile birlikte sunulamaz, sadece seçili hizmet girilecek
                            currentServices = [hizmetID];
                        } else {
                            // Varsayılan ile birlikte sunulabilir, mevcut hizmetleri koru ve yeni hizmeti ekle
                            if (!currentServices.includes(hizmetID)) {
                                currentServices.push(hizmetID);
                            }
                        }

                        // Hücreyi güncelle
                        this.innerHTML = currentServices.map(serviceID => {
                            let option = document.querySelector(`#hizmetSelection option[value="${serviceID}"]`);
                            let badgeClass = serviceID === varsayilanHizmetID ? 'bg-primary' : 'bg-secondary';
                            return `<span class="badge ${badgeClass}">${option.textContent}</span>`;
                        }).join(' ');

                        changes[`${personelID}_${date}`] = {
                            type: 'hizmet',
                            hizmetler: currentServices,
                            izin: null
                        };
                    } else if (izinID) {
                        // İzin seçimi işlemi
                        const izinOption = document.querySelector(`#izinSelection option[value="${izinID}"]`);
                        const izinRenk = izinOption.getAttribute('data-color');
                        this.innerHTML = `<span class="badge ${izinRenk}">${izinOption.textContent}</span>`;

                        changes[`${personelID}_${date}`] = {
                            type: 'izin',
                            hizmetler: [],
                            izin: izinID
                        };
                    }
                    
                    delete deletion[`${personelID}_${date}`];
                }
            });
        });

        // Hizmet bazlı görünüm için hücre tıklama
        document.querySelectorAll('.hizmet-cell').forEach(function(cell) {
            cell.addEventListener('click', function() {
                const date = this.getAttribute('data-date');
                const hizmetID = this.getAttribute('data-hizmet-id');
                const selectedHekimID = document.getElementById('hekimSelection')?.value;
                const clearSelection = document.getElementById('clearSelection')?.checked;

                if (!selectedHekimID) {
                    alert('Lütfen önce bir hekim seçiniz.');
                    return;
                }

                if (clearSelection) {
                    // Hücredeki tüm personelleri bul ve her biri için changes objesine clear kaydı ekle
                    {% for personel in personeller %}
                    if (cell.innerHTML.includes('{{ personel.PersonelName }}')) {
                        changes['{{ personel.PersonelID }}_' + date] = {
                            type: 'clear',
                            hizmetler: [],
                            izin: null
                        };
                        // Ayrıca deletion objesine de ekleyebilirsiniz, gerekirse:
                        // deletion['{{ personel.PersonelID }}_' + date] = true;
                    }
                    {% endfor %}
                    // Görsel olarak hücreyi temizle
                    this.innerHTML = '';
                    return;
                }

                // --- DÜZELTME: Aynı hekime birden fazla hizmet atanabilsin ---
                // Önce mevcut changes objesindeki hizmetleri bul
                let key = `${selectedHekimID}_${date}`;
                let prev = changes[key] && changes[key].type === 'hizmet' ? [...changes[key].hizmetler] : [];

                // Eğer zaten bu hizmet atanmışsa tekrar ekleme
                if (!prev.includes(hizmetID)) {
                    prev.push(hizmetID);
                }

                // Hizmet kombinasyonunu kontrol et
                const validationResult = validateHizmetCombination(prev, null);
                if (!validationResult.isValid) {
                    alert(validationResult.errors.join('\n'));
                    return;
                }

                // Görsel olarak hücreye ekle (her zaman sadece bir hekim gösterilecek)
                this.innerHTML = `<span class="badge bg-primary">${document.querySelector(`#hekimSelection option[value="${selectedHekimID}"]`).textContent}</span>`;

                // changes objesine güncel hizmet listesini yaz
                changes[key] = {
                    type: 'hizmet',
                    hizmetler: prev,
                    izin: null
                };
                delete deletion[key];
            });
        });
    }

    // Görünüm değiştirme butonu için event listener
    const toggleViewButton = document.getElementById('toggleView');
    if (toggleViewButton) {
        toggleViewButton.addEventListener('click', function() {
            const hekimView = document.getElementById('hekimView');
            const hizmetView = document.getElementById('hizmetView');
            const button = document.getElementById('toggleView');
            const viewModeText = document.getElementById('viewModeText');

            const hizmetSelectionDiv = document.getElementById('hizmetSelection').parentElement;
            const izinSelectionDiv = document.getElementById('izinSelection').parentElement;
            const hekimSelectionDiv = document.getElementById('hekimSelection').parentElement;

            if (hekimView.style.display !== 'none') {
                // Hekim bazlıdan hizmet bazlıya geçiş
                hekimView.style.display = 'none';
                hizmetView.style.display = 'block';
                hekimSelectionDiv.style.display = 'block';
                hizmetSelectionDiv.style.display = 'none';
                izinSelectionDiv.style.display = 'none';
                button.innerHTML = '<i class="bi bi-arrow-repeat"></i> Hekim Bazlı Görünüm';
                viewModeText.textContent = 'Hizmet Bazlı Görünüm';
            } else {
                // Hizmet bazlıdan hekim bazlıya geçiş
                hekimView.style.display = 'block';
                hizmetView.style.display = 'none';
                hekimSelectionDiv.style.display = 'none';
                hizmetSelectionDiv.style.display = 'block';
                izinSelectionDiv.style.display = 'block';
                button.innerHTML = '<i class="bi bi-arrow-repeat"></i> Hizmet Bazlı Görünüm';
                viewModeText.textContent = 'Hekim Bazlı Görünüm';
            }
        });
    }

    // Approval mode işlemleri
    if (isApprovalMode) {
        document.querySelectorAll('.mesai-cell').forEach(function(cell) {
            cell.addEventListener('click', function() {
                const mesaiId = this.getAttribute('data-mesai-id');
                if (!mesaiId) return;

                // Sadece onaylanmamış (sarı) hücrelere tıklanabilir
                const checkIcon = this.querySelector('.bi-check-circle-fill.text-warning');
                if (!checkIcon) return;
                
                if (confirm('Bu mesai kaydını onaylamak istiyor musunuz?')) {
                    fetch(`{% url 'hekim_cizelge:mesai_onay' 0 %}`.replace('0', mesaiId), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ onay_durumu: 1 })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            checkIcon.classList.remove('text-warning');
                            checkIcon.classList.add('text-success');
                        }
                    });
                }
            });
        });

        // Toplu onay butonu için event listener
        const topluOnayButton = document.getElementById('topluOnayButton');
        if (topluOnayButton) {
            topluOnayButton.addEventListener('click', function() {
                const birimId = document.getElementById('selectBirim')?.value;
                if (!birimId) return;

                const onaysizMesaiSayisi = document.querySelectorAll('.bi-check-circle-fill.text-warning').length;
                
                if (onaysizMesaiSayisi === 0) {
                    alert('Onaylanacak değişiklik bulunmamaktadır.');
                    return;
                }

                if (confirm(`Listede yer alan onaysız durumdaki ${onaysizMesaiSayisi} adet değişiklik onaylanacak. Onaylıyor musunuz?`)) {
                    fetch(`{% url 'hekim_cizelge:toplu_onay' 0 %}`.replace('0', birimId), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            document.querySelectorAll('.bi-check-circle-fill.text-warning').forEach(icon => {
                                icon.classList.remove('text-warning');
                                icon.classList.add('text-success');
                            });
                            alert(data.message);
                        }
                    });
                }
            });
        }
    }

    // Ortak butonlar için event listeners
    const filterButton = document.getElementById('filterButton');
    if (filterButton) {
        filterButton.addEventListener('click', function () {
            const selectedYear = document.getElementById('selectYear')?.value;
            const selectedMonth = document.getElementById('selectMonth')?.value;
            const selectedBirim = document.getElementById('selectBirim')?.value;
            if (selectedYear && selectedMonth && selectedBirim) {
                let url = `?year=${selectedYear}&month=${selectedMonth}&birim_id=${selectedBirim}`;
                if (isApprovalMode) {
                    url += '&mode=approval';
                }
                window.location.href = url;
            }
        });
    }

    // Kaydetme işlemi fonksiyonu
    function saveChanges() {
        // DÜZELTME: Hem changes hem deletion objesini backend'e gönder!
        if (Object.keys(changes).length === 0 && Object.keys(deletion).length === 0) {
            alert("Herhangi bir değişiklik yapmadınız.");
            return;
        }

        fetch("{% url 'hekim_cizelge:cizelge_kaydet' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ changes: changes, deletion: deletion })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Değişiklikler kaydedildi.');
                changes = {};
                deletion = {};
            } else {
                alert('Bir hata oluştu, lütfen tekrar deneyin.');
            }
        });
    }

    // Hizmet çakışma kontrolü için helper fonksiyon
    function checkHizmetCakisma(date, hizmetID) {
        const hizmet = document.querySelector(`#hizmetSelection option[value="${hizmetID}"]`);
        if (!hizmet || hizmet.value === varsayilanHizmetID) return true; // Varsayılan hizmet için kontrol yapma

        let mevcut_personel = null;
        document.querySelectorAll(`td[data-date="${date}"]`).forEach(cell => {
            const badges = cell.getElementsByClassName('badge');
            Array.from(badges).forEach(badge => {
                const badgeHizmet = Array.from(document.getElementById('hizmetSelection').options)
                    .find(opt => opt.textContent === badge.textContent);
                if (badgeHizmet && badgeHizmet.value === hizmetID) {
                    const personelHeader = document.querySelector(`th:nth-child(${getColumnIndex(cell)})`);
                    if (personelHeader) {
                        mevcut_personel = personelHeader.textContent;
                    }
                }
            });
        });

        if (mevcut_personel) {
            alert(`Bu hizmet zaten ${mevcut_personel} isimli personele tanımlanmış!`);
            return false;
        }
        return true;
    }

    // Hücre sütun indeksini bulmak için yardımcı fonksiyon
    function getColumnIndex(cell) {
        const row = cell.parentElement;
        return Array.from(row.cells).indexOf(cell) + 1;
    }

    // Tutarlılık kontrolü için helper fonksiyon
    function checkNobetConsistency(date, personelID) {
        const prevDate = new Date(date);
        prevDate.setDate(prevDate.getDate() - 1);
        const nextDate = new Date(date);
        nextDate.setDate(nextDate.getDate() + 1);

        const formatDate = (date) => {
            return date.toISOString().split('T')[0];
        };

        // Önceki gün nöbet kontrolü
        const prevCell = document.querySelector(`td[data-date="${formatDate(prevDate)}"][data-personel-id="${personelID}"]`);
        const nextCell = document.querySelector(`td[data-date="${formatDate(nextDate)}"][data-personel-id="${personelID}"]`);
        
        if (prevCell) {
            const hasNobetPrev = Array.from(prevCell.getElementsByClassName('badge')).some(badge => 
                badge.classList.contains('text-bg-danger')
            );
            if (hasNobetPrev) {
                return {
                    valid: false,
                    message: `${formatDate(date)} tarihinde standart hizmet var fakat bir önceki gün nöbet mevcut!`
                };
            }
        }

        // Sonraki gün standart mesai kontrolü
        if (nextCell) {
            const hasStandartNext = Array.from(nextCell.getElementsByClassName('badge')).some(badge =>
                !badge.classList.contains('text-bg-danger') && !badge.classList.contains('text-bg-info')
            );
            if (hasStandartNext) {
                return {
                    valid: false,
                    message: `${formatDate(date)} tarihinde nöbet var fakat bir sonraki gün standart hizmet mevcut!`
                };
            }
        }

        return { valid: true };
    }

    // Tüm tablo için tutarlılık kontrolü
    document.getElementById('checkConsistency').addEventListener('click', function() {
        const cells = document.querySelectorAll('.mesai-cell');
        let errors = [];

        cells.forEach(cell => {
            const date = cell.getAttribute('data-date');
            const personelID = cell.getAttribute('data-personel-id');
            const badges = cell.getElementsByClassName('badge');

            if (badges.length > 0) {
                const result = checkNobetConsistency(date, personelID);
                if (!result.valid) {
                    errors.push(result.message);
                }
            }
        });

        if (errors.length > 0) {
            alert('Aşağıdaki tutarsızlıklar tespit edildi:\n\n' + errors.join('\n'));
        } else {
            alert('Tüm kayıtlar tutarlı!');
        }
    });

    // Hücre tıklama olayını güncelle
    document.querySelectorAll('.mesai-cell').forEach(function(cell) {
        cell.addEventListener('click', function() {
            // ...existing click handler code...

            const date = this.getAttribute('data-date');
            const personelID = this.getAttribute('data-personel-id');

            // Eğer nöbet ekleniyorsa, sonraki günü temizle
            if (hizmetID && hizmet.textContent.includes('Nöbet')) {
                const nextDate = new Date(date);
                nextDate.setDate(nextDate.getDate() + 1);
                const nextCell = document.querySelector(`td[data-date="${nextDate.toISOString().split('T')[0]}"][data-personel-id="${personelID}"]`);
                if (nextCell) {
                    nextCell.innerHTML = '';
                    deletion[`${personelID}_${nextDate.toISOString().split('T')[0]}`] = true;
                }
            }

            // Eğer standart hizmet ekleniyorsa, önceki gün nöbet kontrolü yap
            if (hizmetID && !hizmet.textContent.includes('Nöbet') && !hizmet.textContent.includes('İcap')) {
                const result = checkNobetConsistency(date, personelID);
                if (!result.valid) {
                    alert(result.message);
                    return;
                }
            }

            // ...rest of click handler code...
        });
    });

    // Tutarlılık kontrolü için geliştirilmiş fonksiyon
    function checkConsistency() {
        // Mevcut değişiklikleri geçici olarak sakla
        const tempChanges = { ...changes };
        const tempDeletion = { ...deletion };
        let errors = [];
        let warnings = [];

        // Tüm hücrelerdeki uyarı ikonlarını temizle
        document.querySelectorAll('.warning-icon').forEach(icon => icon.remove());

        // Tarih formatlama fonksiyonu
        function formatDateString(dateStr) {
            const [year, month, day] = dateStr.split('-');
            return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        }

        // Verilen tarihe göre önceki/sonraki günü hesapla
        function getAdjacentDate(dateStr, offset) {
            const date = new Date(dateStr);
            date.setDate(date.getDate() + offset);
            return formatDateString(
                `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`
            );
        }

        // Tüm hücreleri kontrol et
        document.querySelectorAll('.mesai-cell').forEach(cell => {
            const date = cell.getAttribute('data-date');
            const personelID = cell.getAttribute('data-personel-id');
            const badges = Array.from(cell.getElementsByClassName('badge'));

            // Nöbet kontrolü
            const hasNobet = badges.some(badge => badge.classList.contains('text-bg-danger'));
            
            if (hasNobet) {
                // Sonraki gün kontrolü
                const nextDate = getAdjacentDate(date, 1);
                const nextCell = document.querySelector(
                    `td[data-date="${nextDate}"][data-personel-id="${personelID}"]`
                );

                if (nextCell && nextCell.getElementsByClassName('badge').length > 0) {
                    const warningText = `${date} tarihli nöbet sonrası (${nextDate}) mesai tanımlanmış`;
                    errors.push({
                        cell: nextCell,
                        message: warningText
                    });
                }
            } else {
                // Önceki gün nöbet kontrolü
                const prevDate = getAdjacentDate(date, -1);
                const prevCell = document.querySelector(
                    `td[data-date="${prevDate}"][data-personel-id="${personelID}"]`
                );

                if (prevCell) {
                    const hasPrevNobet = Array.from(prevCell.getElementsByClassName('badge'))
                        .some(badge => badge.classList.contains('text-bg-danger'));
                    
                    if (hasPrevNobet && badges.length > 0) {
                        const warningText = `${date} tarihinde mesai var fakat bir önceki gün (${prevDate}) nöbet mevcut`;
                        errors.push({
                            cell: cell,
                            message: warningText
                        });
                    }
                }
            }
        });

        // Hataları göster
        errors.forEach(error => {
            const icon = document.createElement('i');
            icon.className = 'bi bi-exclamation-triangle-fill warning-icon';
            icon.title = error.message;
            
            // Tooltip özelliği ekle
            icon.addEventListener('mouseenter', function(e) {
                showTooltip(e, error.message);
            });
            icon.addEventListener('mouseleave', hideTooltip);

            error.cell.classList.add('inconsistent-cell');
            error.cell.prepend(icon);
        });

        // Özet raporu göster
        if (errors.length > 0) {
            Swal.fire({
                title: 'Tutarsızlık Tespit Edildi',
                html: errors.map(e => `<div class="text-start">${e.message}</div>`).join(''),
                icon: 'warning',
                confirmButtonText: 'Tamam'
            });
        } else {
            Swal.fire({
                title: 'Kontrol Tamamlandı',
                text: 'Tüm kayıtlar tutarlı!',
                icon: 'success',
                confirmButtonText: 'Tamam'
            });
        }

        // Değişiklikleri geri yükle
        changes = tempChanges;
        deletion = tempDeletion;

        return errors.length === 0;
    }

    // Tooltip gösterme fonksiyonu
    function showTooltip(event, message) {
        const tooltip = document.createElement('div');
        tooltip.className = 'tooltip-custom';
        tooltip.textContent = message;
        tooltip.style.left = (event.pageX + 10) + 'px';
        tooltip.style.top = (event.pageY + 10) + 'px';
        document.body.appendChild(tooltip);
    }

    // Tooltip gizleme fonksiyonu
    function hideTooltip() {
        document.querySelectorAll('.tooltip-custom').forEach(el => el.remove());
    }

    // Kaydet butonuna tutarlılık kontrolü ekle
    document.getElementById('saveButton').addEventListener('click', function(e) {
        if (!checkConsistency()) {
            e.preventDefault();
            Swal.fire({
                title: 'Uyarı',
                text: 'Tutarsızlıklar var. Yine de kaydetmek istiyor musunuz?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Evet',
                cancelButtonText: 'Hayır'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Orijinal kaydetme işlemini gerçekleştir
                    saveChanges();
                }
            });
            return;
        }
        saveChanges();
    });

    // Kaydetme işlemi fonksiyonu
    function saveChanges() {
        if (Object.keys(changes).length === 0) {
            alert("Herhangi bir değişiklik yapmadınız.");
            return;
        }

        fetch("{% url 'hekim_cizelge:cizelge_kaydet' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ changes: changes })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Değişiklikler kaydedildi.');
                changes = {};
            } else {
                alert('Bir hata oluştu, lütfen tekrar deneyin.');
            }
        });
    }

    // Tutarlılık kontrolü butonu için event listener
    document.getElementById('checkConsistency').addEventListener('click', function() {
        // Sadece kontrol yap, kaydetme işlemi yapma
        checkConsistency();
    });

    // Kaydet butonu için event listener
    document.getElementById('saveButton').addEventListener('click', function(e) {
        if (!checkConsistency()) {
            e.preventDefault();
            Swal.fire({
                title: 'Uyarı',
                text: 'Tutarsızlıklar var. Yine de kaydetmek istiyor musunuz?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Evet',
                cancelButtonText: 'Hayır'
            }).then((result) => {
                if (result.isConfirmed) {
                    saveChanges();
                }
            });
            return;
        }
        saveChanges();
    });

    // İzin ve Hizmet seçimi için event listeners
    document.getElementById('hizmetSelection')?.addEventListener('change', function() {
        if (this.value) {
            document.getElementById('izinSelection').value = '';
        }
    });

    document.getElementById('izinSelection')?.addEventListener('change', function() {
        if (this.value) {
            document.getElementById('hizmetSelection').value = '';
        }
    });

    // Varsayılan hizmet doldurma butonu için event listener
    document.getElementById('autoFillDefault').addEventListener('click', function() {
        if (!confirm('Hafta içi tüm boş günlere varsayılan hizmet eklenecek. Onaylıyor musunuz?')) {
            return;
        }

        const selectedYear = document.getElementById('selectYear').value;
        const selectedMonth = document.getElementById('selectMonth').value;
        const selectedBirim = document.getElementById('selectBirim').value;

        fetch("{% url 'hekim_cizelge:auto_fill_default' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                year: selectedYear,
                month: selectedMonth,
                birim_id: selectedBirim
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Varsayılan hizmetler başarıyla eklendi.\nEklenen kayıt sayısı: ' + data.count);
                window.location.reload();
            } else {
                alert('Bir hata oluştu: ' + data.message);
            }
        });
    });

    // Hizmet kombinasyon kontrolü için yardımcı fonksiyon
    function validateHizmetCombination(currentServices, newHizmetID) {
        const hizmetler = currentServices.map(id => {
            const option = document.querySelector(`#hizmetSelection option[value="${id}"]`);
            return {
                id: id,
                name: option.textContent,
                type: option.textContent.includes('Nöbet') ? 'Nöbet' : 
                      option.textContent.includes('İcap') ? 'İcap' : 'Standart'
            };
        });

        // Yeni hizmeti ekle
        if (newHizmetID) {
            const newOption = document.querySelector(`#hizmetSelection option[value="${newHizmetID}"]`);
            hizmetler.push({
                id: newHizmetID,
                name: newOption.textContent,
                type: newOption.textContent.includes('Nöbet') ? 'Nöbet' : 
                      newOption.textContent.includes('İcap') ? 'İcap' : 'Standart'
            });
        }

        const standardHizmetler = hizmetler.filter(h => h.type === 'Standart');
        const nobetHizmetler = hizmetler.filter(h => h.type === 'Nöbet');
        const icapHizmetler = hizmetler.filter(h => h.type === 'İcap');

        const errors = [];

        // Nöbet ve İcap birlikte olamaz
        if (nobetHizmetler.length > 0 && icapHizmetler.length > 0) {
            errors.push("Nöbet ve İcap hizmetleri aynı güne tanımlanamaz");
        }

        // Nöbet/İcap sayısı kontrolü
        if (nobetHizmetler.length > 1) {
            errors.push("Birden fazla nöbet hizmeti tanımlanamaz");
        }
        if (icapHizmetler.length > 1) {
            errors.push("Birden fazla icap hizmeti tanımlanamaz");
        }

        return {
            isValid: errors.length === 0,
            errors: errors
        };
    }

    // Hücre tıklama event listener'ında validasyon kontrolünü ekle
    cell.addEventListener('click', function() {
        // ...existing code...

        if (hizmetID) {
            // Hizmet kombinasyonunu kontrol et
            const validationResult = validateHizmetCombination(currentServices, hizmetID);
            if (!validationResult.isValid) {
                alert(validationResult.errors.join('\n'));
                return;
            }
            
            // Devam eden hizmet ekleme işlemleri...
        }

        // ...existing code...
    });

</script>
{% endblock %}

{% block extra_css %}
<style>
    /* Tablo stil ayarları */
    #cizelgeTable td.mesai-cell:hover {
        background-color: #488d5d;
        cursor: pointer;
    }

    #cizelgeTable tbody tr:hover {
        background-color: #5c82a3;
    }

    #cizelgeTable .weekend {
    background-color: #c2c2c2 !important; /* Arka plan rengi */
    color: #22272e !important; /* Metin rengi */
}
    .mesai-cell {
        text-align: center;
        vertical-align: middle;
        min-height: 40px;  /* Onay ikonu için minimum yükseklik */
    }

    .bi-check-circle-fill {
        font-size: 14px;
        opacity: 0.8;
    }
    
    .mesai-cell .badge {
        margin: 2px;
    }
    
    .badge.bg-primary {
        font-weight: normal;
    }
    
    .badge.bg-secondary {
        font-weight: normal;
    }

    .hizmet-cell {
        text-align: center;
        vertical-align: middle;
        cursor: pointer;
    }

    .hizmet-cell:hover {
        background-color: #488d5d;
    }

    #hizmetTable .badge {
        margin: 2px;
    }

    /* Hizmet bazlı tablo için hafta sonu stilleri */
    #hizmetTable .weekend {
        background-color: #c2c2c2 !important;
        color: #22272e !important;
    }

    .hizmet-cell {
        text-align: center;
        vertical-align: middle;
        cursor: pointer;
        padding: 2px;
    }

    .hizmet-cell:hover {
        background-color: #488d5d;
    }

    #hizmetTable .badge {
        margin: 2px;
    }

    /* Onay modunda imleç ve seçim özelliklerini kaldır */
    .mesai-cell {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    /* Hücre seçimini engelle ve cursor ayarla */
    .mesai-cell, .hizmet-cell {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        cursor: pointer;
    }

    .inconsistent-cell {
        position: relative;
    }

    .warning-icon {
        position: absolute;
        top: 5px;
        left: 5px;
        color: #dc3545;
        cursor: help;
    }

    .tooltip-custom {
        position: absolute;
        background: #fff;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        z-index: 1000;
        max-width: 300px;
    }

    .holiday-row {
        background: #f0cdcd;
        color: #b30000 !important;
        font-weight: bold;
    }

    .approval-icon {
        right: 0;
        top: 0;
        z-index: 2;
        display: none;
    }

    .row.mb-2 .d-flex.gap-3 > * {
        margin-right: 1.5rem;
    }
</style>
{% endblock %}