{% extends 'base.html' %}
{% load static %}

{% block title %}Hizmet Sunum Alanı Bildirimi{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <!-- Üst Panel -->
    <div class="row align-items-end mb-3">
        <!-- Dönem Seçimi -->
        <div class="col-md-2">
            <label for="donemSecimi">Dönem</label>
            <select class="form-select" id="donemSecimi">
                <option value="">Dönem Seçiniz</option>
                {% for donem in donemler %}
                    <option value="{{ donem.value }}" {% if donem.value == selected_donem %}selected{% endif %}>
                        {{ donem.label }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- Birim Seçimi ve Düzenleme -->
        <div class="col-md-3">
            <div class="input-group">
                <label for="birimSecimi" class="w-100">Birim</label>
                <select class="form-select" id="birimSecimi">
                    <option value="">Birim Seçiniz</option>
                    {% for birim in birimler %}
                        <option value="{{ birim.BirimId }}" data-hsakodu="{{ birim.AlanKodu }}" {% if birim.BirimId == selected_birim %}selected{% endif %}>
                            {{ birim.BirimAdi }}
                        </option>
                    {% endfor %}
                </select>
                <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#birimDuzenleModal">
                    <i class="bi bi-gear"></i>
                </button>
                <button class="btn btn-success" type="button" id="btnPersonelEkle">
                    <i class="bi bi-person-plus"></i> Personel Ekle
                </button>
            </div>
        </div>

        <!-- İşlem Butonları -->
        <div class="col-md-4">
            <button class="btn btn-info me-2" id="btnYazdir">
                Kesinleştir ve Formu Yazdır
            </button>
            <button class="btn btn-success" id="btnKaydet">
                <i class="bi bi-save"></i> Kaydet
            </button>
        </div>
        <!-- Açıklama Butonu -->
        <div class="col-md-3 text-end">
            <button class="btn btn-secondary ms-2" id="btnAciklama">
                <i class="bi bi-info-circle"></i> Açıklama
            </button>
        </div>
    </div>

    <!-- Açıklama Modalı -->
    <div class="modal fade" id="aciklamaModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        Hizmet Sunum Alanı Bildirimleri Hakkında
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="bi bi-calendar-check text-success me-2"></i>
                            <strong>Her ay başında</strong> tamamlanan <u>önceki aya</u> ilişkin veriler girilecektir.
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                            <strong>Çakışma kontrolü:</strong> Aynı personelin birden fazla yerde aynı günlerde çalışması halinde sistem <span class="text-danger">uyarı</span> verir ve <b>kesinleştirme işlemi yapılamaz</b>.
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-lock-fill text-danger me-2"></i>
                            <strong>Kesinleştirilen veriler</strong> <span class="text-danger">kilitlenir</span> ve <u>değiştirilemez</u>. Değişiklik için sistem yöneticisine başvurunuz.
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-printer text-primary me-2"></i>
                            <strong>Form Yazdır:</strong> Kesinleştirilen kayıtlar PDF olarak indirilebilir ve yazdırabilirsiniz. İmzalayarak Mutemetlik Birimimize iletirsiniz.
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-pencil-square text-secondary me-2"></i>
                            <strong>Tablo düzenleme:</strong> Başlangıç tarihi bitişten küçük olmalı, tarihler seçili dönemin dışında olamaz.
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-person-plus text-success me-2"></i>
                            <strong>Personel ekleme:</strong> Önceki dönemden aktarabilir veya yeni personel ekleyebilirsiniz.
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-arrow-repeat text-info me-2"></i>
                            <strong>Veri güncelleme:</strong> Kaydet butonu ile değişiklikleri kaydedebilirsiniz.
                        </li>
                    </ul>
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-lightbulb-fill me-2"></i>
                        <b>İpucu:</b> Hatalı satırların <span class="text-danger">durum sütununda kırmızı <i class="bi bi-x-circle-fill"></i></span> simgesi görünür ve üzerine gelince hata açıklaması gösterilir.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Aktif Birim Bilgisi (Dinamik) -->
    <div id="aktifBirimBilgisi"></div>

    <!-- Bildirimler Tablosu -->
    <div class="table-responsive">
        <table class="table table-sm table-bordered table-hover" id="bildirimlerTable">
            <thead class="table-light">
                <tr>
                    <th>Sıra No</th>
                    <th>T.C. Kimlik No</th>
                    <th>Adı</th>
                    <th>Soyadı</th>
                    <th>Başlangıç</th>
                    <th>Bitiş</th>
                    <th>Özel Alan Kodu</th>
                    <th>Sorumlu</th>
                    <th>Sertifika</th>
                    <th>İşlem</th>
                    <th>Durum</th>
                </tr>
            </thead>
            <tbody id="bildirimlerTableBody">
                {% for bildirim in bildirimler %}
                <tr>
                    <td class="text-center">{{ forloop.counter }}</td>
                    <td>{{ bildirim.tc_kimlik_no }}</td>
                    <td>{{ bildirim.ad }}</td>
                    <td>{{ bildirim.soyad }}</td>
                    <td>
                        <input type="date" class="form-control form-control-sm" 
                               value="{{ bildirim.baslangic|date:'Y-m-d' }}" {% if bildirim.kesinlesmis %}readonly disabled{% endif %}>
                    </td>
                    <td>
                        <input type="date" class="form-control form-control-sm" 
                               value="{{ bildirim.bitis|date:'Y-m-d' }}" {% if bildirim.kesinlesmis %}readonly disabled{% endif %}>
                    </td>
                    <td>{{ bildirim.ozel_alan_kodu }}</td>
                    <td class="text-center">
                        <input type="checkbox" class="form-check-input" 
                               {% if bildirim.sorumlu %}checked{% endif %} {% if bildirim.kesinlesmis %}disabled{% endif %}>
                    </td>
                    <td class="text-center">
                        <input type="checkbox" class="form-check-input" 
                               {% if bildirim.sertifika %}checked{% endif %} {% if bildirim.kesinlesmis %}disabled{% endif %}>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-danger btn-sm" onclick="kayitSil('{{ bildirim.id }}')" {% if bildirim.kesinlesmis %}disabled{% endif %}>
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                    <td class="text-center">
                        <i class="bi bi-check-circle-fill {% if bildirim.kesinlesmis %}text-success{% else %}text-warning{% endif %}"></i>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Birim Düzenleme Modal -->
<div class="modal fade" id="birimDuzenleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Birim Yönetimi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Birim Ekleme Formu -->
                    <div class="col-md-6 border-end">
                        <h6>Yeni Birim Ekle</h6>
                        <form id="birimEkleForm">
                             {% csrf_token %}
                            <div class="mb-3">
                                <label for="birimAdiEkle" class="form-label">Birim Adı</label>
                                <input type="text" class="form-control" id="birimAdiEkle" name="birimAdi" required>
                            </div>
                            <div class="mb-3">
                                <label for="kurumAdiEkle" class="form-label">Kurum Adı</label>
                                <select class="form-select" id="kurumAdiEkle" name="kurumAdi" required>
                                    <option value="">Seçiniz...</option>
                                    <option value="Kayseri DH">Kayseri DH</option>
                                    <option value="Özvatan DH">Özvatan DH</option>
                                    <option value="Felahiye DH">Felahiye DH</option>
                                    <option value="Sarıoğlan DH">Sarıoğlan DH</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="hsaKoduEkle" class="form-label">Hizmet Sunum Alanı</label>
                                <select class="form-select" id="hsaKoduEkle" name="hsaKodu" required>
                                    <option value="" selected disabled>Seçiniz...</option>
                                    {% for hsa in hsa_listesi %}
                                        <option value="{{ hsa.AlanKodu }}">{{ hsa.AlanAdi }} ({{ hsa.AlanKodu }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                             <button type="button" class="btn btn-success" onclick="birimEkle()">Yeni Birimi Kaydet</button>
                        </form>
                    </div>

                    <!-- Birim Düzenleme Formu -->
                    <div class="col-md-6">
                        <h6>Seçili Birimi Düzenle</h6>
                        <form id="birimDuzenleForm">
                             {% csrf_token %}
                            <input type="hidden" id="birimIdDuzenle" name="birimId">
                             <div class="mb-3">
                                <label for="birimAdiDuzenle" class="form-label">Birim Adı</label>
                                <input type="text" class="form-control" id="birimAdiDuzenle" name="birimAdi" required>
                            </div>
                            <div class="mb-3">
                                <label for="kurumAdiDuzenle" class="form-label">Kurum Adı</label>
                                <select class="form-select" id="kurumAdiDuzenle" name="kurumAdi" required>
                                     <option value="">Seçiniz...</option>
                                    <option value="Kayseri DH">Kayseri DH</option>
                                    <option value="Özvatan DH">Özvatan DH</option>
                                    <option value="Felahiye DH">Felahiye DH</option>
                                    <option value="Sarıoğlan DH">Sarıoğlan DH</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="hsaKoduDuzenle" class="form-label">Hizmet Sunum Alanı</label>
                                <select class="form-select" id="hsaKoduDuzenle" name="hsaKodu" required>
                                    <option value="" selected disabled>Seçiniz...</option>
                                    {% for hsa in hsa_listesi %}
                                        <option value="{{ hsa.AlanKodu }}">{{ hsa.AlanAdi }} ({{ hsa.AlanKodu }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                             <button type="button" class="btn btn-primary" onclick="birimGuncelle()">Değişiklikleri Kaydet</button>
                             <button type="button" class="btn btn-danger ms-2" onclick="birimSil()">Birimi Sil</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

<!-- Personel Ekleme Modal -->
<div class="modal fade" id="personelEkleModal" tabindex="-1">
    {% csrf_token %}
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Personel Ekleme</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Sol Taraf: Önceki Dönem Personelleri -->
                    <div class="col-md-6">
                        <h6>Önceki Dönem Personelleri</h6>
                        <div class="table-responsive">
                            <table class="table table-sm" id="oncekiDonemTable">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAllOnceki"></th>
                                        <th>T.C.</th>
                                        <th>Adı</th>
                                        <th>Soyadı</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <button class="btn btn-primary" id="btnPersonelAktar">
                            <i class="bi bi-arrow-right"></i> Seçilenleri Aktar
                        </button>
                    </div>

                    <!-- Sağ Taraf: Manuel/Excel Giriş -->
                    <div class="col-md-6">
                        <h6>Yeni Personel Girişi</h6>
                        <div class="alert alert-info">
                            Excel'den kopyaladığınız verileri direkt tabloya yapıştırabilir veya manuel giriş yapabilirsiniz.
                            <br>Enter veya aşağı ok tuşu ile yeni satır ekleyebilirsiniz.
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm" id="yeniPersonelTable">
                                <thead>
                                    <tr>
                                        <th>Sıra No</th>
                                        <th>T.C.</th>
                                        <th>Adı</th>
                                        <th>Soyadı</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>1</td>
                                        <td contenteditable="true"></td>
                                        <td contenteditable="true"></td>
                                        <td contenteditable="true"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <button class="btn btn-success" id="btnPersonelKaydet">
                            <i class="bi bi-save"></i> Personelleri Ekle
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
    .form-control:read-only {
        background-color: #e9ecef;
    }
    
    .table td {
        vertical-align: middle;
    }
    
    /* Tarih inputları için özel stil */
    input[type="date"].form-control-sm {
        padding: 0.25rem 0.5rem;
    }
    
    /* Checkbox'lar için özel stil */
    .form-check-input {
        cursor: pointer;
    }
    
    /* Durum ikonları için özel stil */
    .bi-check-circle-fill {
        font-size: 1.2rem;
    }

    #yeniPersonelTable td[contenteditable="true"] {
        padding: 5px;
        border: 1px solid #dee2e6;
    }
    
    #yeniPersonelTable td[contenteditable="true"]:focus {
        outline: none;
        background-color: #e8f0fe;
        border-color: #80bdff;
    }

    .table th {
        background-color: #f8f9fa;
    }

    #birimDuzenleForm input, #birimDuzenleForm select {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Birim Ekleme Fonksiyonu
    function birimEkle() {
        const form = document.getElementById('birimEkleForm');
        const formData = new FormData(form);
        const url = `/hizmet_sunum/birim/ekle/`;

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('Hata: ' + (data.message || 'Birim eklenemedi.'));
            }
        })
        .catch(error => {
            console.error('Birim Ekleme Hatası:', error);
            alert('Birim eklenirken bir hata oluştu.');
        });
    }

    // Birim Güncelleme Fonksiyonu
    function birimGuncelle() {
        const form = document.getElementById('birimDuzenleForm');
        const formData = new FormData(form);
        const birimId = document.getElementById('birimIdDuzenle').value;
        if (!birimId) {
            alert('Düzenlenecek birim seçili değil.');
            return;
        }
        const url = `/hizmet_sunum/birim/${birimId}/guncelle/`;

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('Hata: ' + (data.message || 'Birim güncellenemedi.'));
            }
        })
        .catch(error => {
            console.error('Birim Güncelleme Hatası:', error);
            alert('Birim güncellenirken bir hata oluştu.');
        });
    }
    
    // Birim Silme Fonksiyonu
    function birimSil() {
        const birimId = document.getElementById('birimIdDuzenle').value;
        if (!birimId) {
            alert('Silinecek birim seçili değil.');
            return;
        }
        if (!confirm('Bu birimi silmek istediğinizden emin misiniz? Bu birime ait tüm bildirimler de silinecektir!')) {
            return;
        }
        const url = `/hizmet_sunum/birim/${birimId}/sil/`;
        fetch(url, {
            method: 'POST',
            headers: {
                 'X-CSRFToken': document.getElementById('birimDuzenleForm').querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('Hata: ' + (data.message || 'Birim silinemedi.'));
            }
        })
        .catch(error => {
            console.error('Birim Silme Hatası:', error);
            alert('Birim silinirken bir hata oluştu.');
        });
    }

    // Kayıt silme fonksiyonu
    function kayitSil(bildirimId) {
        if (!bildirimId) return;
        if (confirm('Bu bildirim kaydını silmek istediğinize emin misiniz?')) {
             const url = `/hizmet_sunum/bildirim/${bildirimId}/sil/`;
             fetch(url, {
                method: 'POST',
                headers: {
                     'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                     fetchBildirimlerForSelected(); 
                     alert('Kayıt başarıyla silindi.');
                } else {
                    alert('Hata: ' + (data.message || 'Kayıt silinemedi.'));
                }
            })
            .catch(error => {
                 console.error('Bildirim Silme Hatası:', error);
                alert('Kayıt silinirken bir hata oluştu.');
            });
        }
    }

    // Kesinleştir ve Formu Yazdır butonu
    document.getElementById('btnYazdir').addEventListener('click', function() {
        Swal.fire({
            title: 'Emin misiniz?',
            text: "Veriler kesinleştirildikten sonra değişiklik yapamayacaksınız. Onaylıyor musunuz?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Evet, kesinleştir!',
            cancelButtonText: 'İptal'
        }).then((result) => {
            if (result.isConfirmed) {
                kesinlestirVeYazdir();
            }
        });
    });

    // Kesinleştirme ve yazdırma fonksiyonu
    function kesinlestirVeYazdir() {
        const tableBody = document.getElementById('bildirimlerTableBody');
        const rows = tableBody.querySelectorAll('tr');
        const dataToSave = [];
        const donem = document.getElementById('donemSecimi').value;
        let isValid = true;

        const [year, month] = donem.split('-').map(Number);
        const donemBaslangic = new Date(year, month - 1, 1);
        const donemBitis = new Date(year, month, 0);

        rows.forEach((row, index) => {
            if (row.querySelector('td[colspan]')) return;

            const idInput = row.querySelector('button[onclick^="kayitSil"]');
            const bildirimIdMatch = idInput ? idInput.getAttribute('onclick').match(/kayitSil\('?(\d+)'?\)/) : null;
            const bildirimId = bildirimIdMatch ? bildirimIdMatch[1] : null;

            const tcKimlikNo = row.cells[1].textContent;
            const baslangicInput = row.querySelector('td:nth-child(5) input[type="date"]');
            const bitisInput = row.querySelector('td:nth-child(6) input[type="date"]');
            const sorumluInput = row.querySelector('td:nth-child(8) input[type="checkbox"]');
            const sertifikaInput = row.querySelector('td:nth-child(9) input[type="checkbox"]');
            const durumIcon = row.querySelector('td:nth-child(11) i');

            const baslangicValue = baslangicInput.value;
            const bitisValue = bitisInput.value;
            const sorumluValue = sorumluInput.checked;
            const sertifikaValue = sertifikaInput.checked;

            let rowErrors = [];
            baslangicInput.classList.remove('is-invalid');
            bitisInput.classList.remove('is-invalid');
            durumIcon.className = 'bi bi-check-circle-fill text-warning';
            durumIcon.removeAttribute('title');
            durumIcon.removeAttribute('data-bs-toggle');

            if (baslangicValue && bitisValue) {
                const baslangicDate = new Date(baslangicValue + 'T00:00:00');
                const bitisDate = new Date(bitisValue + 'T00:00:00');

                if (baslangicDate > bitisDate) {
                    rowErrors.push('Başlangıç tarihi, bitiş tarihinden sonra olamaz.');
                    baslangicInput.classList.add('is-invalid');
                    bitisInput.classList.add('is-invalid');
                    isValid = false;
                }

                if (baslangicDate < donemBaslangic || baslangicDate > donemBitis) {
                    rowErrors.push('Başlangıç tarihi seçili dönemin dışında.');
                    baslangicInput.classList.add('is-invalid');
                    isValid = false;
                }
                 if (bitisDate < donemBaslangic || bitisDate > donemBitis) {
                    rowErrors.push('Bitiş tarihi seçili dönemin dışında.');
                    bitisInput.classList.add('is-invalid');
                    isValid = false;
                }
            }

            if (rowErrors.length > 0) {
                 durumIcon.className = 'bi bi-x-circle-fill text-danger';
                 durumIcon.setAttribute('title', rowErrors.join('\n'));
                 durumIcon.setAttribute('data-bs-toggle', 'tooltip');
                 new bootstrap.Tooltip(durumIcon);
            }

            dataToSave.push({
                id: bildirimId,
                tc_kimlik_no: tcKimlikNo,
                baslangic: baslangicValue,
                bitis: bitisValue,
                sorumlu: sorumluValue,
                sertifika: sertifikaValue,
            });
        });

        if (!isValid) {
            Swal.fire({
                icon: 'error',
                title: 'Hata!',
                text: 'Kesinleştirme tamamlanamadı, Açıklamaları görmek için kaydet butonuna tıklayın.'
            });
                return;
            }

        const birimId = document.getElementById('birimSecimi').value;
        const url = `/hizmet_sunum/bildirimler/kesinlestir/`;

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                donem: donem,
                birim_id: birimId,
                bildirimler: dataToSave
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: 'Başarılı!',
                    text: 'Tüm kayıtlar kesinleştirildi. PDF indiriliyor...'
                }).then(() => {
                    fetchBildirimlerForSelected();
                    // PDF indir
                    window.open(`/hizmet_sunum/bildirimler/yazdir/${year}/${parseInt(month)}/${birimId}/`, '_blank');
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Hata!',
                    text: 'Kesinleştirme tamamlanamadı, Açıklamaları görmek için kaydet butonuna tıklayınız.'
                });
            }
        })
        .catch(error => {
            console.error('Kesinleştirme Hatası:', error);
            Swal.fire({
                icon: 'error',
                title: 'Hata!',
                text: 'Kesinleştirme sırasında bir sunucu hatası oluştu.'
            });
        });
    }

    // Değişiklikleri kaydetme fonksiyonu
    function saveBildirimler() {
        const tableBody = document.getElementById('bildirimlerTableBody');
        const rows = tableBody.querySelectorAll('tr');
        const dataToSave = [];
        const donem = document.getElementById('donemSecimi').value;
        let isValid = true;

        const [year, month] = donem.split('-').map(Number);
        const donemBaslangic = new Date(year, month - 1, 1);
        const donemBitis = new Date(year, month, 0);

        rows.forEach((row, index) => {
            if (row.querySelector('td[colspan]')) return;

            const idInput = row.querySelector('button[onclick^="kayitSil"]');
            const bildirimIdMatch = idInput ? idInput.getAttribute('onclick').match(/kayitSil\('?(\d+)'?\)/) : null;
            const bildirimId = bildirimIdMatch ? bildirimIdMatch[1] : null;

            const tcKimlikNo = row.cells[1].textContent;
            const baslangicInput = row.querySelector('td:nth-child(5) input[type="date"]');
            const bitisInput = row.querySelector('td:nth-child(6) input[type="date"]');
            const sorumluInput = row.querySelector('td:nth-child(8) input[type="checkbox"]');
            const sertifikaInput = row.querySelector('td:nth-child(9) input[type="checkbox"]');
            const durumIcon = row.querySelector('td:nth-child(11) i');

            const baslangicValue = baslangicInput.value;
            const bitisValue = bitisInput.value;
            const sorumluValue = sorumluInput.checked;
            const sertifikaValue = sertifikaInput.checked;

            let rowErrors = [];
            baslangicInput.classList.remove('is-invalid');
            bitisInput.classList.remove('is-invalid');
            durumIcon.className = 'bi bi-check-circle-fill text-warning';
            durumIcon.removeAttribute('title');
            durumIcon.removeAttribute('data-bs-toggle');

            if (baslangicValue && bitisValue) {
                const baslangicDate = new Date(baslangicValue + 'T00:00:00');
                const bitisDate = new Date(bitisValue + 'T00:00:00');

                if (baslangicDate > bitisDate) {
                    rowErrors.push('Başlangıç tarihi, bitiş tarihinden sonra olamaz.');
                    baslangicInput.classList.add('is-invalid');
                    bitisInput.classList.add('is-invalid');
                    isValid = false;
                }

                if (baslangicDate < donemBaslangic || baslangicDate > donemBitis) {
                    rowErrors.push('Başlangıç tarihi seçili dönemin dışında.');
                    baslangicInput.classList.add('is-invalid');
                    isValid = false;
                }
                 if (bitisDate < donemBaslangic || bitisDate > donemBitis) {
                    rowErrors.push('Bitiş tarihi seçili dönemin dışında.');
                    bitisInput.classList.add('is-invalid');
                    isValid = false;
                }
            } else if (!baslangicValue || !bitisValue) {
                // Eksik tarih kontrolü (backend'de daha detaylı yapılabilir)
                // rowErrors.push('Başlangıç ve Bitiş tarihleri girilmelidir.');
                // isValid = false;
            }

            if (rowErrors.length > 0) {
                 durumIcon.className = 'bi bi-x-circle-fill text-danger';
                 durumIcon.setAttribute('title', rowErrors.join('\n'));
                 durumIcon.setAttribute('data-bs-toggle', 'tooltip');
                 new bootstrap.Tooltip(durumIcon);
            }

            dataToSave.push({
                id: bildirimId,
                tc_kimlik_no: tcKimlikNo,
                baslangic: baslangicValue,
                bitis: bitisValue,
                sorumlu: sorumluValue,
                sertifika: sertifikaValue,
            });
        });

        if (!isValid) {
            alert('Lütfen tablodaki hataları düzeltin.');
            return;
        }

        const birimId = document.getElementById('birimSecimi').value;
        const url = `/hizmet_sunum/bildirimler/kaydet/`;
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ 
                donem: donem,
                birim_id: birimId,
                bildirimler: dataToSave 
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Değişiklikler başarıyla kaydedildi.');
                 fetchBildirimlerForSelected();
            } else {
                 alert('Kayıt sırasında hatalar oluştu: ' + (data.message || 'Bilinmeyen Hata'));
                 if (data.errors && Array.isArray(data.errors)) {
                     data.errors.forEach(error => {
                         const targetRow = Array.from(rows).find(row => {
                              const idInput = row.querySelector('button[onclick^="kayitSil"]');
                              const bildirimIdMatch = idInput ? idInput.getAttribute('onclick').match(/kayitSil\('?(\d+)'?\)/) : null;
                              const rowId = bildirimIdMatch ? bildirimIdMatch[1] : null;
                              return (rowId && error.id && rowId === error.id.toString()) || 
                                     (!rowId && !error.id && row.cells[1].textContent === error.tc_kimlik_no); 
                         });
                         if (targetRow) {
                             const durumIcon = targetRow.querySelector('td:nth-child(11) i');
                             durumIcon.className = 'bi bi-x-circle-fill text-danger';
                             durumIcon.setAttribute('title', error.message);
                             durumIcon.setAttribute('data-bs-toggle', 'tooltip');
                             new bootstrap.Tooltip(durumIcon);
                         }
                     });
                 }
            }
        })
        .catch(error => {
            console.error('Kaydetme Hatası:', error);
            alert('Değişiklikler kaydedilirken bir sunucu hatası oluştu.');
        });
    }

    // Değişiklikleri kaydetme fonksiyonu
    document.getElementById('btnKaydet').addEventListener('click', function() {
        saveBildirimler();
    });

    // Dönemleri oluşturan fonksiyon
    function getDosyaDonemler() {
        const today = new Date();
        const months = [];
        
        today.setDate(1);
        
        today.setMonth(today.getMonth() - 1);
        
        for (let i = 0; i < 6; i++) {
            const year = today.getFullYear();
            const month = today.getMonth() + 1;
            const monthLabel = `${month.toString().padStart(2, '0')}/${year}`;
            const monthValue = `${year}-${month.toString().padStart(2, '0')}`;
            
            months.push({
                label: monthLabel,
                value: monthValue
            });
            
            today.setMonth(today.getMonth() - 1);
        }
        
        return months;
    }

    // Tablo işlemleri için fonksiyonlar
    function initYeniPersonelTable() {
        const table = document.getElementById('yeniPersonelTable');
        const tbody = table.querySelector('tbody');

        function addRowListeners(row) {
            row.querySelectorAll('td[contenteditable="true"]').forEach(cell => {
                cell.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === 'ArrowDown') {
                        e.preventDefault();
                        addNewRow();
                    }
                });
            });
        }

        function addNewRow() {
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${tbody.children.length + 1}</td>
                <td contenteditable="true"></td>
                <td contenteditable="true"></td>
                <td contenteditable="true"></td>
            `;
            tbody.appendChild(newRow);
            addRowListeners(newRow);
            newRow.querySelector('td[contenteditable="true"]').focus();
        }

        table.addEventListener('paste', function(e) {
            e.preventDefault();
            
            let data = e.clipboardData.getData('text');
            let rows = data.split('\n').filter(row => row.trim());
            
            tbody.innerHTML = '';
            
            rows.forEach((row, index) => {
                const cols = row.split('\t');
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td contenteditable="true">${cols[0] || ''}</td>
                    <td contenteditable="true">${cols[1] || ''}</td>
                    <td contenteditable="true">${cols[2] || ''}</td>
                `;
                tbody.appendChild(tr);
                addRowListeners(tr);
            });
        });

        addRowListeners(tbody.querySelector('tr'));
    }

    // Personel aktarma işlemleri
    document.getElementById('btnPersonelAktar').addEventListener('click', function() {
        const checkedRows = document.querySelectorAll('#oncekiDonemTable tbody input[type="checkbox"]:checked');
        const personelTable = document.getElementById('yeniPersonelTable').querySelector('tbody');
        
        checkedRows.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${personelTable.children.length + 1}</td>
                <td contenteditable="true">${row.cells[1].textContent}</td>
                <td contenteditable="true">${row.cells[2].textContent}</td>
                <td contenteditable="true">${row.cells[3].textContent}</td>
            `;
            personelTable.appendChild(newRow);
        });
    });

    // Sayfa yüklendiğinde
    document.addEventListener('DOMContentLoaded', function() {
        const donemler = getDosyaDonemler();
        const donemSelect = document.getElementById('donemSecimi');
        donemSelect.innerHTML = donemler.map(donem => 
            `<option value="${donem.value}">${donem.label}</option>`
        ).join('');

        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        initYeniPersonelTable();
        fetchBildirimlerForSelected();
    });

    // Birim düzenleme modalını açarken formu doldur
    document.getElementById('birimDuzenleModal').addEventListener('show.bs.modal', function (event) {
        const selectedBirimId = document.getElementById('birimSecimi').value;
        const editForm = document.getElementById('birimDuzenleForm');
        const addForm = document.getElementById('birimEkleForm');
        
        addForm.reset();

        if (selectedBirimId) {
            fetch(`/hizmet_sunum/birim/${selectedBirimId}/detay/`)
                .then(response => response.json())
                .then(data => {
                    if(data.status === 'success'){
                        document.getElementById('birimIdDuzenle').value = data.data.BirimId;
                        document.getElementById('birimAdiDuzenle').value = data.data.BirimAdi;
                        document.getElementById('kurumAdiDuzenle').value = data.data.KurumAdi;
                        document.getElementById('hsaKoduDuzenle').value = data.data.HSAKodu;
                        editForm.style.display = 'block'; 
                    } else {
                         editForm.style.display = 'none';
                         alert('Seçili birim bilgileri alınamadı.');
                    }
                }).catch(error => {
                     console.error("Birim detay getirme hatası:", error);
                     editForm.style.display = 'none'; 
                     alert('Seçili birim bilgileri alınırken hata.');
                });
        } else {
            editForm.reset();
            document.getElementById('birimIdDuzenle').value = '';
            editForm.style.display = 'none'; 
        }
    });

    // Personel Ekle butonu: modalı aç
    document.getElementById('btnPersonelEkle').addEventListener('click', function() {
        const donem = document.getElementById('donemSecimi').value;
        const birimId = document.getElementById('birimSecimi').value;
        if (!donem || !birimId) {
            alert('Lütfen dönem ve birim seçiniz.');
            return;
        }
        fetch(`/hizmet_sunum/onceki-donem-personel/${donem}/${birimId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'error') {
                    alert(data.message || 'Veriler alınırken bir hata oluştu');
                    return;
                }
                const personeller = Array.isArray(data) ? data : (data.data || []);
                const tbody = document.querySelector('#oncekiDonemTable tbody');
                tbody.innerHTML = personeller.map(p => `
                    <tr>
                        <td><input type="checkbox" value="${p.personel_id}"></td>
                        <td>${p.tc_kimlik || ''}</td>
                        <td>${p.adi || ''}</td>
                        <td>${p.soyadi || ''}</td>
                    </tr>
                `).join('');
            })
            .catch(error => {
                console.error('Veri getirme hatası:', error);
                alert('Veriler alınırken bir hata oluştu');
            });
        new bootstrap.Modal(document.getElementById('personelEkleModal')).show();
    });

    // Personelleri ekle butonu
    document.getElementById('btnPersonelKaydet').addEventListener('click', function() {
        const donem = document.getElementById('donemSecimi').value;
        const birimId = document.getElementById('birimSecimi').value;
        if (!donem || !birimId) {
            alert('Lütfen dönem ve birim seçiniz');
            return;
        }

        const personeller = [];
        document.querySelectorAll('#yeniPersonelTable tbody tr').forEach(row => {
            const cells = row.querySelectorAll('td[contenteditable="true"]');
            if (cells.length === 3) {
                const personel = {
                    tc_kimlik: cells[0].textContent.trim(),
                    adi: cells[1].textContent.trim(),
                    soyadi: cells[2].textContent.trim()
                };
                if (personel.tc_kimlik && personel.adi && personel.soyadi) {
                    personeller.push(personel);
                }
            }
        });

        if (personeller.length === 0) {
            alert('Eklenecek personel bulunamadı!');
            return;
        }
        
        // CSRF token'ını modal içinden al
        const modalElement = document.getElementById('personelEkleModal');
        const csrfTokenInput = modalElement.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfTokenInput) {
            alert('CSRF token bulunamadı. Sayfayı yenileyip tekrar deneyin.');
            console.error('CSRF token input not found inside #personelEkleModal');
            return;
        }
        const csrfToken = csrfTokenInput.value;

        fetch('/hizmet_sunum/personel/kaydet/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken 
            },
            body: JSON.stringify({
                donem: donem,
                birim_id: birimId,
                personeller: personeller
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(data.message);
                fetchBildirimlerForSelected(); // Tabloyu güncelle
                // Modalı kapat (opsiyonel)
                var personelModal = bootstrap.Modal.getInstance(modalElement);
                if(personelModal) personelModal.hide();
            } else {
                throw new Error(data.message || 'Bilinmeyen bir hata oluştu.');
            }
        })
        .catch(error => {
            console.error('Kayıt hatası:', error);
            alert('Kayıt sırasında bir hata oluştu: ' + error.message);
        });
    });

    // Bildirimler tablosunu dolduran fonksiyon
    function fillBildirimlerTable(bildirimler) {
        const tbody = document.getElementById('bildirimlerTableBody');
        tbody.innerHTML = '';
        if (!bildirimler || bildirimler.length === 0) {
            tbody.innerHTML = `<tr><td colspan="11" class="text-center">Kayıt bulunamadı.</td></tr>`;
            return;
        }
        bildirimler.forEach((b, idx) => {
            tbody.innerHTML += `
                <tr>
                    <td class="text-center">${idx + 1}</td>
                    <td>${b.tc_kimlik_no || ''}</td>
                    <td>${b.ad || ''}</td>
                    <td>${b.soyad || ''}</td>
                    <td><input type="date" class="form-control form-control-sm" value="${b.baslangic || ''}" ${b.kesinlesmis ? 'readonly disabled' : ''}></td>
                    <td><input type="date" class="form-control form-control-sm" value="${b.bitis || ''}" ${b.kesinlesmis ? 'readonly disabled' : ''}></td>
                    <td>${b.ozel_alan_kodu || ''}</td>
                    <td class="text-center"><input type="checkbox" class="form-check-input" ${b.sorumlu ? 'checked' : ''} ${b.kesinlesmis ? 'disabled' : ''}></td>
                    <td class="text-center"><input type="checkbox" class="form-check-input" ${b.sertifika ? 'checked' : ''} ${b.kesinlesmis ? 'disabled' : ''}></td>
                    <td class="text-center">
                        <button class="btn btn-danger btn-sm" onclick="kayitSil('${b.id || ''}')" ${b.kesinlesmis ? 'disabled' : ''}>
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                    <td class="text-center">
                        <i class="bi bi-check-circle-fill ${b.kesinlesmis ? 'text-success' : 'text-warning'}"></i>
                    </td>
                </tr>
            `;
        });
    }

    // Aktif birim bilgisini güncelle
    function updateAktifBirimBilgisi(birimId) {
        if (!birimId) {
            document.getElementById('aktifBirimBilgisi').innerHTML = '';
            return;
        }
        fetch(`/hizmet_sunum/birim/${birimId}/detay/`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const birim = data.data;
                    document.getElementById('aktifBirimBilgisi').innerHTML = `
                        <div class="alert alert-info" role="alert">
                            <strong>Aktif Birim:</strong> ${birim.BirimAdi}
                            <span>
                                - Özel Alan Kodu: ${birim.HSAKodu} (${birim.HSAAdi || ''})
                            </span>
                        </div>
                    `;
                } else {
                    document.getElementById('aktifBirimBilgisi').innerHTML = '';
                }
            })
            .catch(() => {
                document.getElementById('aktifBirimBilgisi').innerHTML = '';
            });
    }

    // Dönem veya birim değiştiğinde bildirimleri ve aktif birim bilgisini getir
    function fetchBildirimlerForSelected() {
        const donem = document.getElementById('donemSecimi').value;
        const birimId = document.getElementById('birimSecimi').value;
        updateAktifBirimBilgisi(birimId);
        if (!donem || !birimId) {
            fillBildirimlerTable([]);
            return;
        }
        const [year, month] = donem.split('-');
        fetch(`/hizmet_sunum/bildirimler/listele/${year}/${parseInt(month)}/${birimId}/`)
            .then(resp => resp.json())
            .then(data => {
                if (data.status === 'success') {
                    fillBildirimlerTable(data.data);
                } else {
                    fillBildirimlerTable([]);
                }
            })
            .catch(() => fillBildirimlerTable([]));
    }

    // Dönem ve birim seçimlerinde tabloyu güncelle
    document.getElementById('donemSecimi').addEventListener('change', fetchBildirimlerForSelected);
    document.getElementById('birimSecimi').addEventListener('change', fetchBildirimlerForSelected);

    // Açıklama butonu fonksiyonu
    document.getElementById('btnAciklama').addEventListener('click', function() {
        var aciklamaModal = new bootstrap.Modal(document.getElementById('aciklamaModal'));
        aciklamaModal.show();
    });
</script>
{% endblock %}
