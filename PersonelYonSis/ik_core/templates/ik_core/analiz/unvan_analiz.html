{% extends 'base.html' %}
{% load static %}

{% block title %}Ünvan Bazlı Analiz{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3 align-items-center">
        <div class="col">
            <h1 class="h3 mb-0 text-gray-800">Ünvan Bazlı Analiz</h1>
        </div>
        <div class="col-auto">
            <a href="{% url 'ik_core:analiz_dashboard' %}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left"></i> Geri Dön
            </a>
        </div>
    </div>

    <!-- Filtreler -->
    <div class="card mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center" id="filtersToggleBtn"
            type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse" aria-expanded="true"
            aria-controls="filtersCollapse">
            <h6 class="mb-0 fw-bold"><i class="bi bi-funnel"></i> Filtreler</h6>
        </div>
        <div class="collapse show" id="filtersCollapse">
            <div class="card-body">
                <form method="get" id="filterForm">
                    <div class="row g-3">
                        <!-- Durum Filter -->
                        <div class="col-md-3">
                            <label class="form-label small fw-bold">Personel Durumu</label>
                            <div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="durum" value="Aktif"
                                        id="durum_aktif" {% if "Aktif" in selected_durum %}checked{% endif %}>
                                    <label class="form-check-label" for="durum_aktif">Aktif</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="durum" value="Pasif"
                                        id="durum_pasif" {% if "Pasif" in selected_durum %}checked{% endif %}>
                                    <label class="form-check-label" for="durum_pasif">Pasif</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="durum"
                                        value="Kurumdan Ayrıldı" id="durum_ayrildi" {% if "Kurumdan Ayrıldı" in selected_durum %}checked{% endif %}>
                                    <label class="form-check-label" for="durum_ayrildi">Kurumdan Ayrıldı</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="durum"
                                        value="Asıl Kurumuna Döndü" id="durum_dondu" {% if "Asıl Kurumuna Döndü" in selected_durum %}checked{% endif %}>
                                    <label class="form-check-label" for="durum_dondu">Asıl Kurumuna Döndü</label>
                                </div>
                            </div>
                        </div>

                        <!-- Kisa Unvan Filter -->
                        <div class="col-md-3">
                            <label class="form-label small fw-bold">Kısa Unvan</label>
                            <button type="button"
                                class="btn btn-outline-secondary w-100 d-flex justify-content-between align-items-center text-start"
                                data-bs-toggle="modal" data-bs-target="#kisaUnvanModal"
                                style="font-size: 0.85rem; padding: 4px 8px; border-color: #ced4da; min-height: 31px;">
                                <span id="kisaUnvanSelectBtnLabel" class="text-truncate">
                                    {% if selected_kisa_unvans %}
                                    {{ selected_kisa_unvans|length }} Seçili
                                    {% else %}
                                    Seçiniz...
                                    {% endif %}
                                </span>
                                <span id="kisaUnvanSelectBtnBadge"
                                    class="badge bg-primary rounded-pill {% if not selected_kisa_unvans %}d-none{% endif %} ms-1">
                                    {{ selected_kisa_unvans|length }}
                                </span>
                                <i class="bi bi-chevron-down ms-1 small text-muted"></i>
                            </button>
                            <!-- Inputs for selected items will be handled by the modal JS logic -->
                            <div id="hiddenKisaUnvanInputs">
                                {% for id in selected_kisa_unvans %}
                                <input type="hidden" name="kisa_unvan" value="{{ id }}">
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Kadro Durumu Filter -->
                        <div class="col-md-3">
                            <label class="form-label small fw-bold">Kadro Durumu</label>
                            <select name="kadro_durumu" class="form-select form-select-sm">
                                <option value="">Tümü</option>
                                <option value="Kadrolu" {% if selected_kadro_durumu == "Kadrolu" %}selected{% endif %}>Kadrolu</option>
                                <option value="Geçici Gelen" {% if selected_kadro_durumu == "Geçici Gelen" %}selected{% endif %}>Geçici Gelen</option>
                            </select>
                        </div>

                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary btn-sm w-100">
                                <i class="bi bi-search"></i> Uygula
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Analiz Sekmeleri -->
    <ul class="nav nav-tabs mb-3" id="analizTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-dagilim-tab" data-bs-toggle="tab" data-bs-target="#tab-dagilim"
                type="button" role="tab">Kısa Ünvan Dağılımı</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-kirilim-tab" data-bs-toggle="tab" data-bs-target="#tab-kirilim"
                type="button" role="tab">Birim - Kısa Ünvan Kırılımı</button>
        </li>
    </ul>

    <div id="analizContent">
        <div class="d-flex justify-content-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Yükleniyor...</span>
            </div>
            <span class="ms-3 h5 align-self-center text-muted">Veriler analiz ediliyor...</span>
        </div>
    </div>
</div>

<!-- Kisa Unvan Modal (Filter) -->
{% include 'ik_core/partials/kisa_unvan_modal.html' %}

{% include 'ik_core/partials/personel_list_modal.html' %}
{% include 'ik_core/partials/yeni_birim_belirle_modal.html' %}

{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="{% static 'js/excel_export_helper.js' %}"></script>
<script>
    let globalPersonelData = [];
    
    document.addEventListener('DOMContentLoaded', function () {
        
        loadData();

        // --- Filters Collapse Icon Toggle ---
        const filtersCollapse = document.getElementById('filtersCollapse');
        if (filtersCollapse) {
            filtersCollapse.addEventListener('show.bs.collapse', function () {
                const icon = document.querySelector('#filtersToggleBtn i');
                if (icon) icon.className = 'bi bi-chevron-up';
            });
            filtersCollapse.addEventListener('hide.bs.collapse', function () {
                const icon = document.querySelector('#filtersToggleBtn i');
                if (icon) icon.className = 'bi bi-chevron-down';
            });
        }
        
        // --- Filter Modal Sync ---
        const kisaUnvanModal = document.getElementById('kisaUnvanModal');
        if (kisaUnvanModal) {
            const applyBtn = kisaUnvanModal.querySelector('.btn-success');
            if (applyBtn) {
                applyBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const checkboxes = kisaUnvanModal.querySelectorAll('input[type="checkbox"][name="kisa_unvan"]:checked');
                    const container = document.getElementById('hiddenKisaUnvanInputs');
                    if (container) {
                        container.innerHTML = '';
                        let count = 0;
                        checkboxes.forEach(cb => {
                            const input = document.createElement('input');
                            input.type = 'hidden';
                            input.name = 'kisa_unvan';
                            input.value = cb.value;
                            container.appendChild(input);
                            count++;
                        });

                        const labelEl = document.getElementById('kisaUnvanSelectBtnLabel');
                        if (labelEl) {
                            labelEl.innerText = count > 0 ? count + ' Seçili' : 'Seçiniz...';
                        }
                        const badge = document.getElementById('kisaUnvanSelectBtnBadge');
                        if (badge) {
                            badge.innerText = count;
                            badge.classList.toggle('d-none', count === 0);
                        }
                    }
                    // Close modal
                    const modalInstance = bootstrap.Modal.getInstance(kisaUnvanModal);
                    if(modalInstance) modalInstance.hide();
                });
            }
        }
    });

    // --- AJAX DATA LOADING ---
    function loadData() {
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('load_data', '1');
        
        fetch(window.location.pathname + '?' + urlParams.toString(), {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.html_content) {
                document.getElementById('analizContent').innerHTML = data.html_content;
                // Re-init tabs if needed or other plugins
            }
            if (data.personel_data) {
                globalPersonelData = data.personel_data;
                console.log('Personel verisi yüklendi:', globalPersonelData.length, 'kayıt');
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            document.getElementById('analizContent').innerHTML = '<div class="alert alert-danger">Veriler yüklenirken bir hata oluştu. Lütfen sayfayı yenileyiniz.</div>';
        });
    }

    // --- Detail Modal Logic (Client Side) ---
    const detailModal = new bootstrap.Modal(document.getElementById('personelListModal'));
    const allOzelDurumlar = [
        {% for oz in all_ozel_durumlar %}
        { kod: "{{ oz.kod }}", ad: "{{ oz.ad }}" },
        {% endfor %}
    ];
    
    // Event Delegation for dynamically created elements
    document.addEventListener('click', function(e) {
        // Find closest element with detail-btn class
        const btn = e.target.closest('.detail-btn') || e.target.closest('.clickable-cell');
        
        if (btn) {
            // Check if it's inside our result area or relevant parts
            const birimId = btn.dataset.birimId;
            const kuId = btn.dataset.kisaUnvanId;
            
            if (birimId || kuId) {
                let params = {};
                if (birimId) params['birim_id'] = birimId;
                if (kuId) params['kisa_unvan_id'] = kuId;
                openDetailModal(params);
            }
        }
        
        // Handle set-yeni-birim-btn inside modal
        if (e.target.classList.contains('set-yeni-birim-btn')) {
             console.log('Set Yeni Birim clicked for personel id:', e.target.dataset.personelId);
             const pid = e.target.dataset.personelId;
             const hidden = document.getElementById('id_yeni_birim-personel_id');
             if (hidden) {
                 hidden.value = pid;
             }
             detailModal.hide();
             setTimeout(() => {
                 const modalEl = document.getElementById('yeniBirimBelirleModal');
                 if (modalEl) {
                     const modal = new bootstrap.Modal(modalEl);
                     modal.show();
                 }
             }, 300);
        }

        // Inline Edit: Ozel Durum click
        const displayDiv = e.target.closest('.ozel-durum-display');
        if (displayDiv) {
            const container = displayDiv.closest('.editable-ozel-durum-container');
            const editDiv = container.querySelector('.ozel-durum-edit');
            const selectEl = editDiv.querySelector('.ozel-durum-select');

            displayDiv.classList.add('d-none');
            editDiv.classList.remove('d-none');

            // Initialize Select2
            $(selectEl).select2({
                dropdownParent: $('#personelListModal'),
                placeholder: 'Seçiniz...',
                allowClear: true,
                width: '100%'
            }).on('change', function() {
                // Instantly save
                saveOzelDurum(container.dataset.personelId, $(this).val(), container);
            }).on('select2:close', function() {
                // Return to display mode
                setTimeout(() => {
                    updateOzelDurumDisplay(container);
                    editDiv.classList.add('d-none');
                    displayDiv.classList.remove('d-none');
                }, 100);
            }).select2('open');
        }
    });

    // Delegated Listener for editable-note focusout (blur doesn't bubble)
    document.addEventListener('focusout', function(e) {
        if (e.target.classList.contains('editable-note')) {
            const div = e.target;
            const newText = div.innerText.trim();
            const pbId = div.dataset.personelBirimId;
            
            if(!pbId) return;

            fetch('/ik_core/analiz/personel-birim/update-aciklama/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    'personel_birim_id': pbId,
                    'aciklama': newText
                })
            })
            .then(r => r.json())
            .then(d => {
                if(d.status === 'success') {
                    div.style.borderBottom = '1px solid green';
                    setTimeout(() => { div.style.borderBottom = '1px dashed #ccc'; }, 2000);
                    
                    // Update global data if exists
                    const p = globalPersonelData.find(x => String(x.personel_birim_id) === String(pbId));
                    if (p) { p.aciklama = newText; }
                } else {
                    alert('Kaydedilemedi: ' + d.message);
                }
            })
            .catch(e => {
               console.error(e);
               alert('Bir hata oluştu.');
            });
        }
    });

    function saveOzelDurum(personelId, ozel_durumlar, container) {
        fetch('/ik_core/analiz/personel/update-ozel-durum/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                'personel_id': personelId,
                'ozel_durumlar': ozel_durumlar
            })
        })
        .then(r => r.json())
        .then(d => {
            if (d.status === 'success') {
                container.style.backgroundColor = 'rgba(75, 181, 67, 0.1)';
                setTimeout(() => { container.style.backgroundColor = 'transparent'; }, 1000);
                
                // Update global data so re-opens show new data
                const p = globalPersonelData.find(x => String(x.id) === String(personelId));
                if (p) {
                    p.ozel_durumlar = allOzelDurumlar.filter(oz => ozel_durumlar.includes(oz.kod));
                }
            } else {
                alert('Hata: ' + d.message);
            }
        })
        .catch(e => {
            console.error(e);
            alert('Bir hata oluştu.');
        });
    }

    function updateOzelDurumDisplay(container) {
        const select = $(container.querySelector('.ozel-durum-select'));
        const display = container.querySelector('.ozel-durum-display');
        const selectedData = select.select2('data');
        
        if (selectedData.length === 0) {
            display.innerHTML = '<span class="text-muted small">Ekle...</span>';
        } else {
            display.innerHTML = selectedData.map(item => `<span class="badge bg-info text-dark mb-1 me-1">${item.text}</span>`).join('');
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function openDetailModal(params) {
        if (!globalPersonelData) {
            alert("Veriler henüz yüklenmedi.");
            return;
        }

        const body = document.getElementById('personelListModalBody');
        body.innerHTML = '<div class="d-flex justify-content-center py-5"><div class="spinner-border text-primary" role="status"></div></div>';
        detailModal.show();

        // Client-side filtering
        const filtered = globalPersonelData.filter(p => {
            for (let key in params) {
                // Ignore empty params or nulls
                if (!params[key]) continue;
                // String comparison
                if (String(p[key]) !== String(params[key])) return false;
            }
            return true;
        });

        // Grouping logic for display (Grouping by Birim Name + Description)
        const grouped = {};
        filtered.forEach(p => {
            const bName = p.birim_ad;
            const bDesc = p.birim_aciklama || '';
            const key = JSON.stringify([bName, bDesc]);
            if (!grouped[key]) grouped[key] = [];
            grouped[key].push(p);
        });
        
        // Sorting groups
        const sortedKeys = Object.keys(grouped).sort();

        // Render HTML
        let html = `
            <div class="px-3 py-2 border-bottom d-flex justify-content-between align-items-center bg-light">
                <div>
                    <span class="fw-bold text-primary">${filtered.length}</span> Personel Listeleniyor
                </div>
                 <div class="d-flex">
                     <button class="btn btn-outline-success btn-sm me-2" onclick="exportModalToExcel()"><i class="bi bi-file-earmark-excel"></i> Excel</button>
                     <button class="btn btn-outline-primary btn-sm" onclick="exportModalToPDF()"><i class="bi bi-file-earmark-pdf"></i> PDF</button>
                 </div>
            </div>
            <div class="table-responsive">
                <table class="table table-sm table-striped table-hover mb-0" style="font-size: 0.85rem;">
                    <thead class="table-light sticky-top" style="top: 0; z-index: 10;">
                        <tr>
                            <th class="p-1">Ad Soyad</th>
                            <th class="p-1">Yaş</th>
                            <th class="p-1">Kısa Unvan</th>
                            <th class="p-1">Açıklama</th>
                            <th class="p-1">Kadro Durumu</th>
                            <th class="p-1">Özel Durumlar</th>
                            <th class="p-1">Durum</th>
                            <th class="p-1">İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>`;

        if (filtered.length === 0) {
            html += `<tr><td colspan="8" class="text-center py-4 text-muted">Personel bulunamadı.</td></tr>`;
        } else {
            sortedKeys.forEach(key => {
                const list = grouped[key];
                const [bName, bDesc] = JSON.parse(key);
                html += `
                    <tr class="table-secondary">
                        <td colspan="8" class="fw-bold text-dark ps-2 py-1">
                            <i class="bi bi-building"></i> ${bName} 
                            ${bDesc ? `<span class="text-muted fw-normal ms-2 small">- ${bDesc}</span>` : ''}
                            <span class="badge bg-secondary ms-2 rounded-pill">${list.length}</span>
                        </td>
                    </tr>`;
                
                list.forEach(p => {
                    let ozelDurumBadges = p.ozel_durumlar.map(oz => `<span class="badge bg-info text-dark mb-1 me-1">${oz.ad}</span>`).join('');
                    if(!ozelDurumBadges) ozelDurumBadges = '<span class="text-muted small">Ekle...</span>';
                    
                    let kadroBadge = p.kadro_durumu === 'Kadrolu' 
                        ? '<span class="badge bg-success bg-opacity-10 text-success border border-success">Kadrolu</span>'
                        : '<span class="badge bg-warning bg-opacity-10 text-warning border border-warning">Geçici</span>';

                    let optionsHtml = allOzelDurumlar.map(opt => {
                        const isSelected = p.ozel_durumlar.some(oz => oz.kod === opt.kod);
                        return `<option value="${opt.kod}" ${isSelected ? 'selected' : ''}>${opt.ad}</option>`;
                    }).join('');

                    html += `
                    <tr>
                        <td class="p-1 ps-2">
                            <div class="fw-bold">${p.ad_soyad}</div>
                        </td>
                        <td class="p-1">${p.yas}</td>
                        <td class="p-1">
                             ${p.kisa_unvan_ad}
                        </td>
                        <td class="p-1">
                             <div class="editable-note" 
                                  contenteditable="true" 
                                  data-personel-birim-id="${p.personel_birim_id || ''}"
                                  style="min-height: 20px; border-bottom: 1px dashed #ccc; cursor: text;">
                                 ${p.aciklama || ''}
                             </div>
                        </td>
                        <td class="p-1">${kadroBadge}</td>
                        <td class="p-1 editable-ozel-durum-container" data-personel-id="${p.id}">
                            <div class="ozel-durum-display" style="cursor: pointer; min-height: 25px;">
                                ${ozelDurumBadges}
                            </div>
                            <div class="ozel-durum-edit d-none">
                                <select class="form-select form-select-sm ozel-durum-select" multiple style="width: 100%;">
                                    ${optionsHtml}
                                </select>
                            </div>
                        </td>
                        <td class="p-1"><span class="badge bg-secondary">${p.durum}</span></td>
                        <td class="text-end p-1">
                            <button type="button" class="btn btn-sm btn-outline-primary set-yeni-birim-btn py-0 px-2" style="font-size: 0.8rem;" data-personel-id="${p.id}">Birim Değiştir</button>
                        </td>
                    </tr>`;
                });
            });
        }

        html += `</tbody></table></div>`;
        body.innerHTML = html;
        
        // Remove old export buttons from footer if any (since we put them in header now)
        const footerExportBtns = document.querySelectorAll('#personelListModal .modal-footer .export-btn');
        footerExportBtns.forEach(b => b.remove());

        // Add Listeners for Editable Notes
        document.querySelectorAll('.editable-note').forEach(div => {
            div.addEventListener('blur', function() {
                const newText = this.innerText.trim();
                const pbId = this.dataset.personelBirimId;
                
                if(!pbId) return;

                fetch('/ik_core/analiz/personel-birim/update-aciklama/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        'personel_birim_id': pbId,
                        'aciklama': newText
                    })
                })
                .then(r => r.json())
                .then(d => {
                    if(d.status === 'success') {
                        this.style.borderBottom = '1px solid green';
                        setTimeout(() => { this.style.borderBottom = '1px dashed #ccc'; }, 2000);
                    } else {
                        alert('Kaydedilemedi: ' + d.message);
                    }
                })
                .catch(e => {
                   console.error(e);
                   alert('Bir hata oluştu.');
                });
            });
        });
    }

    // Export functions
    window.exportToPDF = function (tabId) {
        const element = document.getElementById(tabId);
        if (!element) { alert('Tab bulunamadı'); return; }
        html2canvas(element, { scale: 2, useCORS: true, allowTaint: true }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgWidth = 210; 
            const pageHeight = 295; 
            const imgHeight = canvas.height * imgWidth / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }
            pdf.save('analiz_export.pdf');
        });
    }

    window.exportToExcel = function (tabId) {
        ExcelExport.exportTable(tabId, 'analiz_export');
    }

    window.exportModalToPDF = function () {
        const modalBody = document.getElementById('personelListModalBody');
        if (!modalBody) return;
        html2canvas(modalBody, { scale: 2, useCORS: true, allowTaint: true }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgWidth = 210;
            const imgHeight = canvas.height * imgWidth / canvas.width;
            pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
            pdf.save('personel_listesi.pdf');
        });
    }

    window.exportModalToExcel = function () {
        const modalBody = document.getElementById('personelListModalBody');
        if (modalBody) ExcelExport.exportTable(modalBody, 'personel_listesi');
    }
</script>
{% endblock %}