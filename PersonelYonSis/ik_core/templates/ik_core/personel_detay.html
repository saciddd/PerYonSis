{% extends "base.html" %}
{% load static %} {# Add static tag if not already present #}
{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<style>
    /* Personel Detay CSS */
    :root {
        --primary-color: #2c3e50;
        --secondary-color: #3498db;
        --light-bg: #f8f9fa;
        --border-color: #dee2e6;
    }
    
    body {
        background-color: #f5f7fa;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        padding-top: 5px;
        font-size: 0.85rem;
    }
    
    .container {
        max-width: 100%;
        padding: 0 5px;
    }
    
    .card {
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 8px;
        border: 1px solid #dee2e6;
    }
    
    .card-header {
        background-color: var(--primary-color);
        color: white;
        font-weight: 600;
        padding: 4px 8px;
        font-size: 0.8rem;
        border-radius: 4px 4px 0 0;
    }
    
    .card-body {
        padding: 6px 8px;
    }
    
    .status-badge {
        padding: 2px 6px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
    }
    
    .status-active {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-inactive {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .status-left {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .section-title {
        color: var(--primary-color);
        border-bottom: 1px solid var(--secondary-color);
        padding-bottom: 3px;
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .info-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 1px;
        font-size: 0.9rem;
    }
    
    .info-value {
        font-size: 0.9rem;
        margin-bottom: 6px;
        padding: 2px 0;
        border-bottom: 1px dashed var(--border-color);
    }
    
    .action-buttons .btn {
        min-width: 80px;
        margin: 0 2px;
        padding: 3px 8px;
        font-size: 0.75rem;
    }
    
    .table-sm th, .table-sm td {
        padding: 2px 4px;
        font-size: 0.8rem;
    }
    
    .temporary-row-out {
        background-color: rgba(233, 236, 239, 0.3);
    }
    
    .temporary-row-in {
        background-color: rgba(207, 226, 255, 0.3);
    }
    
    .modal-content {
        border-radius: 5px;
    }
    
    .form-control:disabled, .form-select:disabled {
        background-color: #f8f9fa;
        border-color: #e9ecef;
    }
    
    .editable-display {
        display: block;
        padding: 1px 0;
        min-height: calc(1.2em + 0.5rem + 1px);
    }
    
    .editable-input {
        display: none;
    }
    
    .edit-mode .editable-display {
        display: none;
    }
    
    .edit-mode .editable-input {
        display: block;
    }
    
    .edit-mode .form-check.editable-input {
        display: flex !important;
        align-items: center;
    }
    
    .form-control-plaintext {
        padding: 1px 0;
    }
    
    .select2-container--bootstrap-5 .select2-selection {
        min-height: 28px;
        display: flex;
        align-items: center;
        border-radius: 4px;
        border: 1px solid #ced4da;
    }
    
    .select2-container--bootstrap-5 .select2-selection--single {
        padding: 2px 4px;
    }
    
    .select2-container--bootstrap-5 .select2-selection__rendered {
        color: #495057;
        font-size: 0.8rem;
    }
    
    .select2-container--bootstrap-5 .select2-selection__placeholder {
        color: #6c757d;
    }
    
    .select2-container--bootstrap-5 .select2-selection--single .select2-selection__arrow {
        height: 26px;
    }
    
    .select2-container--bootstrap-5 .select2-dropdown {
        border-radius: 4px;
        border: 1px solid #ced4da;
    }
    
    .select2-container--bootstrap-5 .select2-results__option {
        font-size: 0.8rem;
        padding: 4px 8px;
    }
    
    /* Form alanları için ek stiller */
    .editable-input input,
    .editable-input select,
    .editable-input textarea {
        width: 100%;
        margin-bottom: 0;
        font-size: 0.8rem;
        padding: 2px 4px;
    }
    
    .editable-input .form-check-input {
        margin-left: 0;
    }
    
    .edit-mode .editable-input input,
    .edit-mode .editable-input select,
    .edit-mode .editable-input textarea {
        display: block !important;
    }
    
    .edit-mode .editable-input .form-check {
        display: flex !important;
        align-items: center;
    }
    
    /* Ayrılış input alanları için özel stiller */
    .ayrilis-input {
        display: none;
    }
    
    .ayrilis-input input,
    .ayrilis-input select,
    .ayrilis-input textarea {
        width: 100%;
        margin-bottom: 0;
        font-size: 0.8rem;
        padding: 2px 4px;
        background-color: #fff;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
    }
    
    .ayrilis-input input:focus,
    .ayrilis-input select:focus,
    .ayrilis-input textarea:focus {
        border-color: #86b7fe;
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    /* Personel başlık kısmı */
    .personel-header {
        margin-bottom: 8px;
    }
    
    .personel-avatar {
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
    }
    
    .personel-name {
        font-size: 1.2rem;
        margin-bottom: 2px;
    }
    
    .personel-info {
        font-size: 1rem;
    }
    
    /* Grid düzeni optimizasyonu */
    .row {
        margin-left: -2px;
        margin-right: -2px;
    }
    
    .col-md-3, .col-md-4, .col-md-6, .col-md-8, .col-lg-4, .col-lg-8 {
        padding-left: 2px;
        padding-right: 2px;
    }
    
    .mb-3 {
        margin-bottom: 6px !important;
    }
    
    .mb-2 {
        margin-bottom: 4px !important;
    }
    
    .mt-3 {
        margin-top: 6px !important;
    }
    
    .mt-4 {
        margin-top: 8px !important;
    }
    
    /* Özel durum kartları */
    .card.border-info, .card.border-warning {
        margin-top: 4px;
    }
    
    .card.border-info .card-header,
    .card.border-warning .card-header {
        padding: 2px 4px;
        font-size: 0.7rem;
    }
    
    .card.border-info .card-body,
    .card.border-warning .card-body {
        padding: 3px 4px;
    }
    
    /* Tablo optimizasyonu */
    .table-responsive {
        margin-bottom: 0;
    }
    
    /* Modal optimizasyonu */
    .modal-dialog {
        max-width: 90%;
    }
    
    .modal-body {
        padding: 8px;
    }
    
    .modal-header {
        padding: 6px 8px;
    }
    
    .modal-footer {
        padding: 6px 8px;
    }
    
    /* Buton boyutları */
    .btn-sm {
        padding: 2px 6px;
        font-size: 0.7rem;
    }
    
    /* Alert optimizasyonu */
    .alert {
        padding: 4px 8px;
        margin-bottom: 6px;
        font-size: 0.8rem;
    }
    
    /* Responsive düzenlemeler */
    @media (max-width: 768px) {
        .col-md-4, .col-md-6, .col-md-8 {
            margin-bottom: 4px;
        }
        
        .action-buttons {
            justify-content: center;
            margin-top: 4px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Üst Bilgi ve Durum Mesajları -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
    
    <!-- Form Hataları -->
    {% if form.errors %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <h6><i class="bi bi-exclamation-triangle me-2"></i>Form Hataları:</h6>
            <ul class="mb-0">
                {% for field, errors in form.errors.items %}
                    {% for error in errors %}
                        <li><strong>{{ field }}:</strong> {{ error }}</li>
                    {% endfor %}
                {% endfor %}
            </ul>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endif %}
    
    <!-- Personel Bilgileri Üst Kısım -->
    <div class="card mb-3 w-100 px-0">
        <div class="card-body">
            <form id="personelDetayForm" method="post" autocomplete="off">
                {% csrf_token %}
                <!-- Mevcut personel bilgilerini hidden input olarak ekle -->
                <input type="hidden" name="tc_kimlik_no" value="{{ personel.tc_kimlik_no }}">
                <input type="hidden" name="ad" value="{{ personel.ad }}">
                <input type="hidden" name="soyad" value="{{ personel.soyad }}">
                <input type="hidden" name="kurum" value="{{ personel.kurum.id|default:'' }}">
                <input type="hidden" name="unvan" value="{{ personel.unvan.id|default:'' }}">
                <input type="hidden" name="brans" value="{{ personel.brans.id|default:'' }}">
                <input type="hidden" name="sicil_no" value="{{ personel.sicil_no|default:'' }}">
                <input type="hidden" name="dogum_tarihi" value="{{ personel.dogum_tarihi|date:'Y-m-d'|default:'' }}">
                <input type="hidden" name="cinsiyet" value="{{ personel.cinsiyet|default:'' }}">
                <input type="hidden" name="kadro_yeri" value="{{ personel.kadro_yeri.id|default:'' }}">
                <input type="hidden" name="fiili_gorev_yeri" value="{{ personel.fiili_gorev_yeri.id|default:'' }}">
                <input type="hidden" name="teskilat" value="{{ personel.teskilat|default:'' }}">
                <input type="hidden" name="emekli_sicil_no" value="{{ personel.emekli_sicil_no|default:'' }}">
                <input type="hidden" name="tahsil_durumu" value="{{ personel.tahsil_durumu|default:'' }}">
                <input type="hidden" name="telefon" value="{{ personel.telefon|default:'' }}">
                <input type="hidden" name="eposta" value="{{ personel.eposta|default:'' }}">
                <input type="hidden" name="adres" value="{{ personel.adres|default:'' }}">
                <input type="hidden" name="memur_devreden_izin" value="{{ personel.memur_devreden_izin|default:0 }}">
                <input type="hidden" name="memur_hak_ettigi_izin" value="{{ personel.memur_hak_ettigi_izin|default:0 }}">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center">
                            <div class="me-2">
                                <div class="bg-light border rounded-circle d-flex align-items-center justify-content-center personel-avatar">
                                    <i class="bi bi-person-fill" style="color: #6c757d;"></i>
                                </div>
                            </div>
                            <div>
                                <h3 class="personel-name mb-1">{{ personel.ad }} {{ personel.soyad }}</h3>
                                <div class="d-flex flex-wrap align-items-center personel-info">
                                    {% if personel.durum == "Aktif" %}
                                        <span class="status-badge status-active me-2 mb-1">{{ personel.durum }}</span>
                                    {% elif personel.durum == "Kurumdan Ayrıldı" %}
                                        <span class="status-badge status-left me-2 mb-1">{{ personel.durum }}</span>
                                    {% else %}
                                        <span class="status-badge status-inactive me-2 mb-1">{{ personel.durum }}</span>
                                    {% endif %}
                                    
                                    <span class="text-muted me-2 mb-1"><i class="bi bi-person-badge me-1"></i> {{ personel.tc_kimlik_no }}</span>
                                    
                                    {% if personel.dogum_tarihi %}
                                        <span class="text-muted me-2 mb-1"><i class="bi bi-calendar me-1"></i> {{ personel.dogum_tarihi|date:"d.m.Y" }}</span>
                                        <span class="text-muted mb-1"><i class="bi bi-star me-1"></i> {{ personel.burc }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex justify-content-end action-buttons">
                            <!-- Tebliğ işlemleri butonu -->
                            <a href="{% url 'ik_core:teblig_islemleri' personel.id %}" class="btn btn-primary btn-sm">
                                <i class="bi bi-file-earmark-text me-1"></i> Tebliğ İşlemleri
                            </a>
                            <button type="button" class="btn btn-warning btn-sm" id="editBtn">
                                <i class="bi bi-pencil me-1"></i> Düzenle
                            </button>
                            <button type="submit" class="btn btn-success btn-sm d-none" id="saveBtn" name="save_main" value="save_main">
                                <i class="bi bi-check-circle me-1"></i> Kaydet
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm d-none" id="cancelBtn">
                                <i class="bi bi-x-circle me-1"></i> İptal
                            </button>
                            <a href="{% url 'ik_core:personel_list' %}" class="btn btn-outline-secondary btn-sm ms-1">
                                <i class="bi bi-arrow-left me-1"></i> Geri
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <!-- Sol Kolon (Kurumsal ve Görev Bilgileri) -->
                    <div class="col-lg-8">
                        <!-- Kurumsal Bilgiler Kartı -->
                        <div class="card">
                            <div class="card-header py-2 px-2" style="background-color: #343a40; color: #fff; min-height: 32px;">
                                <i class="bi bi-building me-1"></i> Kurumsal Bilgiler
                            </div>
                            <div class="card-body py-2 px-2">
                                <div class="row">
                                    <div class="col-md-4 mb-1">
                                        <div class="info-label">Kurum</div>
                                        <span class="editable-display info-value">{{ personel.kurum.ad|default:"-" }}</span>
                                        <div class="editable-input">{{ form.kurum }}</div>
                                    </div>
                                    <div class="col-md-4 mb-1">
                                        <div class="info-label">Teşkilat</div>
                                        <span class="editable-display info-value">{{ personel.get_teskilat_display|default:"-" }}</span>
                                        <div class="editable-input">{{ form.teskilat }}</div>
                                    </div>
                                    <div class="col-md-4 mb-1">
                                        <div class="info-label">Sicil No</div>
                                        <span class="editable-display info-value">{{ personel.sicil_no|default:"-" }}</span>
                                        <div class="editable-input">{{ form.sicil_no }}</div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4 mb-1">
                                        <div class="info-label">Unvan</div>
                                        <span class="editable-display info-value">{{ personel.unvan.ad|default:"-" }}</span>
                                        <div class="editable-input">{{ form.unvan }}</div>
                                    </div>
                                    <div class="col-md-4 mb-1">
                                        <div class="info-label">Branş</div>
                                        <span class="editable-display info-value">{{ personel.brans.ad|default:"-" }}</span>
                                        <div class="editable-input">{{ form.brans }}</div>
                                    </div>
                                    <div class="col-md-4 mb-1">
                                        <div class="row">
                                            <div class="col-md-6 mb-1">
                                                <div class="info-label">Emekli Sicil No</div>
                                                    <span class="editable-display info-value">{{ personel.emekli_sicil_no|default:"-" }}</span>
                                                <div class="editable-input">{{ form.emekli_sicil_no }}</div>
                                            </div>
                                            <div class="col-md-6 mb-1">
                                                <div class="info-label">Aday Memur</div>
                                                <span class="editable-display info-value">
                                                    {% if personel.aday_memur %}
                                                        <i style="color: #28a745;" class="bi bi-check-circle-fill"></i>
                                                    {% else %}
                                                        <i style="color: #dc3545;" class="bi bi-x-circle-fill"></i>
                                                    {% endif %}
                                                </span>
                                                <div class="editable-input">
                                                    <div class="form-check form-switch">{{ form.aday_memur }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Görev Bilgileri Kartı -->
                        <div class="card">
                            <div class="card-header py-2 px-2" style="background-color: #343a40; color: #fff; min-height: 32px;">
                                <i class="bi bi-briefcase me-1"></i> Görev Bilgileri
                            </div>
                            <div class="card-body py-2 px-2">
                                <div class="row">
                                    <div class="col-md-9">
                                        <div class="row">
                                            <div class="col-md-6 mb-1">
                                                <div class="info-label">Kadrolu Personel</div>
                                                <span class="editable-display info-value">
                                                    {% if personel.kadrolu_personel %}
                                                        <i style="color: #28a745;" class="bi bi-check-circle-fill"></i>
                                                    {% else %}
                                                        <i style="color: #dc3545;" class="bi bi-x-circle-fill"></i>
                                                    {% endif %}
                                                </span>
                                                <div class="editable-input">
                                                    <div class="form-check form-switch">{{ form.kadrolu_personel }}</div>
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-1">
                                                <div class="info-label">Atama Karar Tarihi</div>
                                                <span class="editable-display info-value">{{ personel.atama_karar_tarihi|date:"d.m.Y"|default:"-" }}</span>
                                                <div class="editable-input">
                                                    <input type="date" class="form-control" name="atama_karar_tarihi" 
                                                           value="{% if personel.atama_karar_tarihi %}{{ personel.atama_karar_tarihi|date:'Y-m-d' }}{% endif %}">
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-1">
                                                <div class="info-label">Atama Karar No</div>
                                                <span class="editable-display info-value">{{ personel.atama_karar_no|default:"-" }}</span>
                                                <div class="editable-input">{{ form.atama_karar_no }}</div>
                                            </div>                                            
                                        </div>                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-1">
                                                <div class="info-label">Kadro Yeri</div>
                                                <span class="editable-display info-value">{{ personel.kadro_yeri.ad|default:"-" }}</span>
                                                <div class="editable-input">{{ form.kadro_yeri }}</div>
                                            </div>
                                            <div class="col-md-3 mb-1">
                                                <div class="info-label">Göreve Başlama Tarihi</div>
                                                <span class="editable-display info-value">{{ personel.goreve_baslama_tarihi|date:"d.m.Y"|default:"-" }}</span>
                                                <div class="editable-input">
                                                    <input type="date" class="form-control" name="goreve_baslama_tarihi" 
                                                           value="{% if personel.goreve_baslama_tarihi %}{{ personel.goreve_baslama_tarihi|date:'Y-m-d' }}{% endif %}">
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-1">
                                                <div class="info-label">Memuriyete Başlama Tarihi</div>
                                                <span class="editable-display info-value">{{ personel.memuriyete_baslama_tarihi|date:"d.m.Y"|default:"-" }}</span>
                                                <div class="editable-input">
                                                    <input type="date" class="form-control" name="memuriyete_baslama_tarihi" 
                                                           value="{% if personel.memuriyete_baslama_tarihi %}{{ personel.memuriyete_baslama_tarihi|date:'Y-m-d' }}{% endif %}">
                                                </div>
                                            </div>
                                        </div>                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-1">
                                                <div class="info-label">Fiili Görev Yeri</div>
                                                <span class="editable-display info-value">{{ personel.fiili_gorev_yeri.ad|default:"-" }}</span>
                                                <div class="editable-input">{{ form.fiili_gorev_yeri }}</div>
                                            </div>
                                            <div class="col-md-3 mb-1">
                                                <div class="info-label text-success">Kamu Başlangıç Tarihi</div>
                                                <span class="editable-display info-value">{{ personel.kamu_baslangic_tarihi|date:"d.m.Y"|default:"-" }}</span>
                                                <div class="editable-input">
                                                    <input type="date" class="form-control" name="kamu_baslangic_tarihi" 
                                                           value="{% if personel.kamu_baslangic_tarihi %}{{ personel.kamu_baslangic_tarihi|date:'Y-m-d' }}{% endif %}">
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-1">
                                                <div class="info-label">Aile Hek. Sözleşmesi</div>
                                                <span class="editable-display info-value">
                                                    {% if personel.aile_hek_sozlesmesi %}
                                                        <i style="color: #28a745;" class="bi bi-check-circle-fill"></i>
                                                    {% else %}
                                                        <i style="color: #dc3545;" class="bi bi-x-circle-fill"></i>
                                                    {% endif %}</span>
                                                <div class="editable-input">
                                                    <div class="form-check form-switch">{{ form.aile_hek_sozlesmesi }}</div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-3 mb-1">
                                                <div class="info-label">DHY</div>
                                                <span class="editable-display info-value">
                                                    {% if personel.dhy %}
                                                    <i style="color: #28a745;" class="bi bi-check-circle-fill"></i>
                                                    {% else %}
                                                        <i style="color: #dc3545;" class="bi bi-x-circle-fill"></i>
                                                    {% endif %}</span>
                                                <div class="editable-input">
                                                    <div class="form-check form-switch">{{ form.dhy }}</div>
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-1">
                                                <div class="info-label">SGK</div>
                                                <span class="editable-display info-value">
                                                    {% if personel.sgk %}
                                                        <i style="color: #28a745;" class="bi bi-check-circle-fill"></i>
                                                    {% else %}
                                                        <i style="color: #dc3545;" class="bi bi-x-circle-fill"></i>
                                                    {% endif %}</span>
                                                <div class="editable-input">
                                                    <div class="form-check form-switch">{{ form.sgk }}</div>
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-1">
                                                <div class="info-label">DSS</div>
                                                <span class="editable-display info-value">
                                                    {% if personel.dss %}
                                                        <i style="color: #28a745;" class="bi bi-check-circle-fill"></i>
                                                    {% else %}
                                                        <i style="color: #dc3545;" class="bi bi-x-circle-fill"></i>
                                                    {% endif %}</span>
                                                <div class="editable-input">
                                                    <div class="form-check form-switch">{{ form.dss }}</div>
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-1">
                                                <div class="info-label">SHÇEK</div>
                                                <span class="editable-display info-value">
                                                    {% if personel.shcek %}
                                                        <i style="color: #28a745;" class="bi bi-check-circle-fill"></i>
                                                    {% else %}
                                                        <i style="color: #dc3545;" class="bi bi-x-circle-fill"></i>
                                                    {% endif %}</span>
                                                <div class="editable-input">
                                                    <div class="form-check form-switch">{{ form.shcek }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card border-secondary mt-3">
                                            <div class="card-header bg-secondary text-white py-1 px-2 d-flex justify-content-between align-items-center mb-0">Mazeret Bilgileri
                                            <!-- Mazeret bilgileri sil butonu -->
                                            <div class="d-flex justify-content-end">
                                                <button type="button" class="btn btn-sm btn-dark" id="btnMazeretSil">
                                                    <i class="bi bi-trash"></i> Mazeret Sil
                                                </button>
                                            </div>
                                            </div>
                                            <div class="card-body py-2 px-2">
                                                <div class="mb-2">
                                                    <div class="info-label">Durum</div>
                                                    <span class="editable-display info-value">{{ personel.get_mazeret_durumu_display|default:"-" }}</span>
                                                    <div class="editable-input mazeret-input">{{ form.mazeret_durumu }}</div>
                                                </div>
                                                <div class="mb-2">
                                                    <div class="info-label">Başlangıç</div>
                                                    <span class="editable-display info-value">{{ personel.mazeret_baslangic|date:"d.m.Y"|default:"-" }}</span>
                                                    <div class="editable-input">
                                                        <input type="date" class="form-control" name="mazeret_baslangic" 
                                                               value="{% if personel.mazeret_baslangic %}{{ personel.mazeret_baslangic|date:'Y-m-d' }}{% endif %}">
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="info-label">Bitiş</div>
                                                    <span class="editable-display info-value">{{ personel.mazeret_bitis|date:"d.m.Y"|default:"-" }}</span>
                                                    <div class="editable-input">
                                                        <input type="date" class="form-control" name="mazeret_bitis" 
                                                               value="{% if personel.mazeret_bitis %}{{ personel.mazeret_bitis|date:'Y-m-d' }}{% endif %}">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Kişi Bilgileri Kartı -->
                        <div class="card">
                            <div class="card-header py-2 px-2" style="background-color: #343a40; color: #fff; min-height: 32px;">
                                <i class="bi bi-person-lines-fill me-1"></i> Kişi Bilgileri
                            </div>
                            <div class="card-body py-2 px-2">
                                <div class="row">
                                    <div class="col-md-9">
                                        <div class="row">
                                            <div class="col-md-3 mb-1">
                                                <div class="info-label">Tahsil Durumu</div>
                                                <span class="editable-display info-value">{{ personel.get_tahsil_durumu_display|default:"-" }}</span>
                                                <div class="editable-input">{{ form.tahsil_durumu }}</div>
                                            </div>
                                            <div class="col-md-3 mb-1">
                                                <div class="info-label">Cinsiyet</div>
                                                <span class="editable-display info-value">{{ personel.get_cinsiyet_display|default:"-" }}</span>
                                                <div class="editable-input">{{ form.cinsiyet }}</div>
                                            </div>
                                            <div class="col-md-3 mb-1">
                                                <div class="info-label">Doğum Tarihi</div>
                                                <span class="editable-display info-value">{{ personel.dogum_tarihi|date:"d.m.Y"|default:"-" }}</span>
                                                <div class="editable-input">
                                                    <input type="date" class="form-control" name="dogum_tarihi" 
                                                           value="{% if personel.dogum_tarihi %}{{ personel.dogum_tarihi|date:'Y-m-d' }}{% endif %}">
                                                </div>
                                            </div>
                                            <div class="col-md-3 mb-1">
                                                <div class="info-label">
                                                    Telefon
                                                    {% if personel.telefon %}
                                                        <!-- Whatsapp Web butonu -->
                                                        <a href="https://web.whatsapp.com/send/?phone=90{{ personel.telefon }}" target="_blank" class="ms-1" title="Whatsapp ile mesaj gönder">
                                                            <i class="bi bi-whatsapp" style="color: #25d366; font-size: 1.1em;"></i>
                                                        </a>
                                                    {% endif %}
                                                </div>
                                                <span class="editable-display info-value">{{ personel.telefon|default:"-" }}</span>
                                                <div class="editable-input">{{ form.telefon }}</div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-4 mb-1">
                                                <div class="info-label">E-posta</div>
                                                <span class="editable-display info-value">{{ personel.eposta|default:"-" }}</span>
                                                <div class="editable-input">{{ form.eposta }}</div>
                                            </div>
                                            <div class="col-md-8 mb-1">
                                                <div class="info-label">Adres</div>
                                                <span class="editable-display info-value">{{ personel.adres|default:"-" }}</span>
                                                <div class="editable-input">{{ form.adres }}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card border-warning mt-3">
                                            <div class="card-header bg-warning text-dark py-1 px-2">Özel Durum Bilgileri</div>
                                            <div class="card-body py-2 px-2">
                                                <div class="mb-2">
                                                    <div class="info-label">Özel Durumu</div>
                                                    <span class="editable-display info-value">
                                                        {% for od in personel.ozel_durumu.all %}
                                                            {{ od.ad }}{% if not forloop.last %}, {% endif %}
                                                        {% empty %} - {% endfor %}
                                                    </span>
                                                    <div class="editable-input">{{ form.ozel_durumu }}</div>
                                                </div>
                                                <div class="mb-2">
                                                    <div class="info-label">Açıklama</div>
                                                    <span class="editable-display info-value">{{ personel.ozel_durumu_aciklama|default:"-" }}</span>
                                                    <div class="editable-input">{{ form.ozel_durumu_aciklama }}</div>
                                                </div>
                                                <div class="mb-2">
                                                    <div class="info-label">Engel Oranı</div>
                                                    <span class="editable-display info-value">{{ personel.engel_orani|default:"-" }}</span>
                                                    <div class="editable-input">{{ form.engel_orani }}</div>
                                                </div>
                                                <div>
                                                    <div class="info-label">Vergi İndirimi</div>
                                                    <span class="editable-display info-value">{{ personel.get_vergi_indirimi_display|default:"-" }}</span>
                                                    <div class="editable-input">{{ form.vergi_indirimi }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sağ Kolon (İzin ve Çalışma, Geçici Görev ve Ayrılış) -->
                    <div class="col-lg-4">
                        <!-- İzin Bilgileri Kartı -->
                        <div class="card">
                            <div class="card-header py-2 px-2" style="background-color: #343a40; color: #fff; min-height: 32px;">
                                <i class="bi bi-calendar-check me-1"></i> İzin ve Çalışma Bilgileri
                            </div>
                            <div class="card-body py-2 px-2">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <div class="info-label">Memur Devreden İzin</div>
                                            <span class="editable-display info-value">{{ personel.memur_devreden_izin|default:"0" }}</span>
                                            <div class="editable-input">{{ form.memur_devreden_izin }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <div class="info-label">Memur Hak Ettiği İzin</div>
                                            <span class="editable-display info-value">{{ personel.memur_hak_ettigi_izin|default:"0" }}</span>
                                            <div class="editable-input">{{ form.memur_hak_ettigi_izin }}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="info-label">Çalıştığı Bina</div>
                                        <span class="editable-display info-value">
                                            {% if son_birim_kaydi %}
                                                {{ son_birim_kaydi.birim.bina.ad }}
                                            {% else %}
                                                Tanımsız
                                            {% endif %}
                                        </span>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="info-label">Birim</div>
                                        <span class="editable-display info-value">
                                            {% if son_birim_kaydi %}
                                                {{ son_birim_kaydi.birim.ad }}
                                            {% else %}
                                                Tanımsız
                                            {% endif %}
                                        </span>
                                    </div>
                                    <div class="col-md-1">
                                        <div class="d-flex gap-1 justify-content-end">
                                            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#yeniBirimBelirleModal" title="Yeni Birim Belirle">
                                                <i class="bi bi-building-add"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#birimGecmisiModal" title="Birim Geçmişi">
                                                <i class="bi bi-clock-history"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Geçici Görevler Kartı -->
                        <div class="card">
                            <div class="card-header py-2 px-2" style="background-color: #343a40; color: #fff; min-height: 32px;">
                                <div class="row justify-content-between align-items-center">
                                    <div class="col-md-5">
                                        <i class="bi bi-people me-1"></i> Geçici Görevler
                                    </div>
                                    <div class="col-md-7 text-end">
                                        <div class="d-flex justify-content-end mb-0 mt-0">
                                            <button type="button" class="btn btn-sm btn-outline-warning" id="btnGeciciGorevModalAc">
                                                <i class="bi bi-exposure me-1"></i> Geçici Görev Ekle / Sil
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body py-2 px-2">
                                
                                
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Tipi</th>
                                                <th>Başlangıç</th>
                                                <th>Bitiş</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for gg in personel.gecicigorev_set.all|slice:":3" %}
                                            <tr class="{% if gg.gecici_gorev_tipi == 'Gidis' %}temporary-row-out{% elif gg.gecici_gorev_tipi == 'Gelis' %}temporary-row-in{% endif %}">
                                                <td>{{ gg.get_gecici_gorev_tipi_display }}</td>
                                                <td>{{ gg.gecici_gorev_baslangic|date:"d.m.Y" }}</td>
                                                <td>{{ gg.gecici_gorev_bitis|date:"d.m.Y"|default:"-" }}</td>
                                            </tr>
                                            {% empty %}
                                            <tr><td colspan="3" class="text-center">Geçici görev kaydı yok.</td></tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ayrılış Bilgileri Kartı -->
                        <div class="card">
                            <div class="card-header py-2 px-2" style="background-color: #343a40; color: #fff; min-height: 32px;">
                                <i class="bi bi-door-open me-1"></i> Ayrılış
                            </div>
                            <div class="card-body py-2 px-2">
                                <div class="mb-3">
                                    <div class="info-label">Ayrılma Tarihi</div>
                                    <span class="editable-display info-value">
                                        {% if personel.ayrilma_tarihi %}
                                            {{ personel.ayrilma_tarihi|date:"d.m.Y" }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </span>
                                    <div class="editable-input ayrilis-input">
                                        <input type="date" class="form-control" id="ayrilma_tarihi" name="ayrilma_tarihi" 
                                               value="{% if personel.ayrilma_tarihi %}{{ personel.ayrilma_tarihi|date:'Y-m-d' }}{% endif %}">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="info-label">Ayrılma Nedeni</div>
                                    <span class="editable-display info-value">
                                        {% if personel.ayrilma_nedeni %}
                                            {{ personel.get_ayrilma_nedeni_display }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </span>
                                    <div class="editable-input ayrilis-input">
                                        <select class="form-select" id="ayrilma_nedeni" name="ayrilma_nedeni">
                                            <option value="">Ayrılma nedeni seçiniz</option>
                                            <option value="Emekli" {% if personel.ayrilma_nedeni == 'Emekli' %}selected{% endif %}>Emekli</option>
                                            <option value="İstifa" {% if personel.ayrilma_nedeni == 'İstifa' %}selected{% endif %}>İstifa</option>
                                            <option value="İhraç" {% if personel.ayrilma_nedeni == 'İhraç' %}selected{% endif %}>İhraç</option>
                                            <option value="Vefat" {% if personel.ayrilma_nedeni == 'Vefat' %}selected{% endif %}>Vefat</option>
                                            <option value="Diğer" {% if personel.ayrilma_nedeni == 'Diğer' %}selected{% endif %}>Diğer</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="info-label">Ayrılma Detay</div>
                                    <span class="editable-display info-value">{{ personel.ayrilma_detay|default:"-" }}</span>
                                    <div class="editable-input ayrilis-input">
                                        <textarea class="form-control" id="ayrilma_detay" name="ayrilma_detay" rows="2">{{ personel.ayrilma_detay|default:"" }}</textarea>
                                    </div>
                                </div>
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-info {% if personel.ayrilma_tarihi %}d-none{% endif %}" id="ayrilisBaslatBtn">
                                        <i class="bi bi-gear me-1"></i> Ayrılış İşlemi Başlat
                                    </button>
                                    <button type="submit" class="btn btn-success d-none" id="ayrilisKaydetBtn" name="save_ayrilis" value="save_ayrilis">
                                        <i class="bi bi-check-circle me-1"></i> Ayrılış Bilgilerini Kaydet
                                    </button>
                                    <a href="{% if personel.ayrilma_tarihi %}{% url 'ik_core:ilisik_kesme_formu' personel.pk %}{% else %}#{% endif %}"
                                       class="btn btn-primary {% if not personel.ayrilma_tarihi %}d-none{% endif %}"
                                       id="ilisikKesmeBtn"
                                       {% if not personel.ayrilma_tarihi %}aria-disabled="true" tabindex="-1"{% endif %}
                                       {% if personel.ayrilma_tarihi %}target="_blank" rel="noopener"{% endif %}>
                                       <i class="bi bi-file-earmark-text me-1"></i> İlişik Kesme Formu
                                    </a>
                                    <button type="button" class="btn btn-warning {% if not personel.ayrilma_tarihi %}d-none{% endif %}" id="personeliAktiflestirBtn">
                                        <i class="bi bi-arrow-clockwise me-1"></i> Personeli Aktifleştir
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Geçici Görev Ekleme Modalı -->
<div class="modal fade" id="geciciGorevModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-people me-2"></i> Geçici Görev Yönetimi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6 class="mb-3"><i class="bi bi-plus-circle me-1"></i> Yeni Geçici Görev Kaydı</h6>
                <form id="geciciGorevForm" method="post" action="{% url 'ik_core:gecici_gorev_ekle' personel.id %}" class="mb-4">
                    {% csrf_token %}
                    <input type="hidden" name="personel_id" value="{{ personel.id }}">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Geçici Görev Tipi</label>
                            {{ gecici_gorev_form.gecici_gorev_tipi }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Başlangıç Tarihi</label>
                            {{ gecici_gorev_form.gecici_gorev_baslangic }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Bitiş Tarihi</label>
                            {{ gecici_gorev_form.gecici_gorev_bitis }}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Asıl Kurumu</label>
                            {{ gecici_gorev_form.asil_kurumu }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Görevlendirildiği Birim</label>
                            {{ gecici_gorev_form.gorevlendirildigi_birim }}
                        </div>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle me-1"></i> Kaydet
                        </button>
                    </div>
                </form>
                
                <h6 class="mb-3"><i class="bi bi-list me-1"></i> Geçici Görev Kayıtları</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Tipi</th>
                                <th>Başlangıç</th>
                                <th>Bitiş</th>
                                <th>Asıl Kurumu</th>
                                <th>Görevlendirildiği Birim</th>
                                <th>İşlem</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for gg in personel.gecicigorev_set.all %}
                            <tr class="{% if gg.gecici_gorev_tipi == 'Gidis' %}temporary-row-out{% elif gg.gecici_gorev_tipi == 'Gelis' %}temporary-row-in{% endif %}">
                                <td>{{ gg.get_gecici_gorev_tipi_display }}</td>
                                <td>{{ gg.gecici_gorev_baslangic|date:"d.m.Y" }}</td>
                                <td>{{ gg.gecici_gorev_bitis|date:"d.m.Y"|default:"-" }}</td>
                                <td>{{ gg.asil_kurumu }}</td>
                                <td>{{ gg.gorevlendirildigi_birim }}</td>
                                <td>
                                    <form method="post" action="{% url 'ik_core:gecici_gorev_sil' personel.id gg.id %}" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Bu geçici görevi silmek istediğinize emin misiniz?')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="6" class="text-center">Geçici görev kaydı yok.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    $(document).ready(function() {
        // Modalı açan butonun submit davranışını engelle
        document.getElementById('btnGeciciGorevModalAc').addEventListener('click', function(e) {
            e.preventDefault();
            var modalEl = document.getElementById('geciciGorevModal');
            var modal = new bootstrap.Modal(modalEl);
            modal.show();
        });

        // Modal açıldığında Select2 başlat
        $('#geciciGorevModal').on('shown.bs.modal', function () {
            // Sadece modal içindeki form-select'leri enable et
            $('#geciciGorevModal .form-select').each(function() {
                $(this).prop('disabled', false);
                $(this).select2({
                    theme: 'bootstrap-5',
                    width: '100%',
                    dropdownParent: $('#geciciGorevModal')
                });
            });
        });

        // Modal içindeki formun submitini AJAX ile gönder
        $('#geciciGorevForm').on('submit', function(e) {
            e.preventDefault();
            var $form = $(this);
            var url = $form.attr('action');
            var formData = $form.serialize();
            $.post(url, formData)
                .done(function(data) {
                    if (data.status === 'success' || data.success) {
                        location.reload();
                    } else {
                        alert(data.message || 'Kayıt başarısız.');
                    }
                })
                .fail(function(xhr) {
                    alert('Kayıt sırasında bir hata oluştu.');
                });
        });

        // Select2 başlatma (modal açıldığında da başlat)
        function initSelect2InModal() {
            $('#geciciGorevModal .form-select').select2({
                theme: 'bootstrap-5',
                width: '100%',
                dropdownParent: $('#geciciGorevModal')
            });
        }
        initSelect2InModal();
        $('#geciciGorevModal').on('shown.bs.modal', function () {
            initSelect2InModal();
        });

        // Form alanlarını başlangıçta devre dışı bırak
        document.querySelectorAll('.editable-input input, .editable-input textarea').forEach(el => {
            el.disabled = true;
            if (el.type !== 'checkbox') {
                el.readOnly = true;
            }
        });
        // Sadece select dışındaki alanları disable et, select'ler için ayrıca:
        document.querySelectorAll('.editable-input select').forEach(el => {
            el.disabled = true;
        });
        
        // Ayrılış alanlarını başlangıçta devre dışı bırak
        document.querySelectorAll('.ayrilis-input input, .ayrilis-input select, .ayrilis-input textarea').forEach(el => {
            el.disabled = true;
            if (el.type !== 'checkbox') {
                el.readOnly = true;
            }
            el.style.backgroundColor = '#f8f9fa';
            el.style.border = '1px solid #e9ecef';
        });

        // Select2 alanlarını devre dışı bırak (ayrılış ve mazeret alanları hariç)
        $('.form-select:not(.ayrilis-input select):not(.mazeret-input select)').prop('disabled', true);

        // Düzenleme modu kontrolü
        const editBtn = document.getElementById('editBtn');
        const saveBtn = document.getElementById('saveBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const ayrilisBaslatBtn = document.getElementById('ayrilisBaslatBtn');
        const ayrilisKaydetBtn = document.getElementById('ayrilisKaydetBtn');
        const ilisikKesmeBtn = document.getElementById('ilisikKesmeBtn');
        const personeliAktiflestirBtn = document.getElementById('personeliAktiflestirBtn');
        const btnMazeretSil = document.getElementById('btnMazeretSil');

        let originalValues = {};

        // Orijinal değerleri sakla
        function storeOriginalValues() {
            document.querySelectorAll('.editable-input input, .editable-input select, .editable-input textarea').forEach(el => {
                const name = el.name;
                if (!name) return;

                if (el.type === 'checkbox') {
                    originalValues[name] = el.checked;
                } else if (el.multiple) {
                    originalValues[name] = Array.from(el.selectedOptions).map(opt => opt.value);
                } else {
                    originalValues[name] = el.value;
                }
            });
        }

        // Orijinal değerlere dön
        function restoreOriginalValues() {
            document.querySelectorAll('.editable-input input, .editable-input select, .editable-input textarea').forEach(el => {
                const name = el.name;
                if (!name || !originalValues.hasOwnProperty(name)) return;

                if (el.type === 'checkbox') {
                    el.checked = originalValues[name];
                } else if (el.multiple) {
                    Array.from(el.options).forEach(opt => {
                        opt.selected = originalValues[name].includes(opt.value);
                    });
                    $(el).trigger('change.select2');
                } else {
                    el.value = originalValues[name];
                    $(el).trigger('change.select2');
                }
            });
        }

        // Ana düzenleme modu
        editBtn.addEventListener('click', function() {
            storeOriginalValues();
            document.querySelectorAll('.card-body').forEach(el => {
                el.classList.add('edit-mode');
            });
            editBtn.classList.add('d-none');
            saveBtn.classList.remove('d-none');
            cancelBtn.classList.remove('d-none');

            // Form alanlarını etkinleştir
            document.querySelectorAll('.editable-input input, .editable-input textarea').forEach(el => {
                el.disabled = false;
                if (el.type !== 'checkbox') {
                    el.readOnly = false;
                }
            });
            // Sadece select dışındaki alanları enable et, select'ler için ayrıca:
            document.querySelectorAll('.editable-input select').forEach(el => {
                el.disabled = false;
            });
            // Ayrılış alanlarını devre dışı bırak
            document.querySelectorAll('.ayrilis-input input, .ayrilis-input select, .ayrilis-input textarea').forEach(el => {
                el.disabled = true;
                if (el.type !== 'checkbox') {
                    el.readOnly = true;
                }
                el.style.backgroundColor = '#f8f9fa';
                el.style.border = '1px solid #e9ecef';
                el.style.display = 'block';
            });

            // Select2 alanlarını etkinleştir
            $('.form-select').prop('disabled', false);

            // Select2 alanlarını yeniden başlat (ayrılış ve mazeret alanları hariç)
            $('.form-select:not(.ayrilis-input select):not(.mazeret-input select)').each(function() {
                if (!$(this).hasClass('select2-hidden-accessible')) {
                    $(this).select2({
                        theme: 'bootstrap-5',
                        width: '100%',
                        allowClear: true
                    });
                } else {
                    // Mevcut Select2'yi yeniden başlat
                    $(this).select2('destroy');
                    $(this).select2({
                        theme: 'bootstrap-5',
                        width: '100%',
                        allowClear: true
                    });
                }
            });
            
            // Mazeret alanları için Select2 başlat
            $('.mazeret-input select').each(function() {
                if (!$(this).hasClass('select2-hidden-accessible')) {
                    $(this).select2({
                        theme: 'bootstrap-5',
                        width: '100%',
                        allowClear: true
                    });
                }
            });
        });

        // Mazeret silme fonksiyonu
        btnMazeretSil.addEventListener('click', function() {
            Swal.fire({
                title: 'Mazeret Sil',
                text: 'Bu mazeret kaydını silmek istediğinize emin misiniz?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Evet, Sil',
                cancelButtonText: 'İptal'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: "{% url 'ik_core:mazeret_sil' personel.id %}",
                        type: 'POST',
                        data: {
                            'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                        },
                        success: function(response) {
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Başarılı',
                                    text: 'Mazeret kaydı silindi!'
                                }).then(() => {
                                    location.reload();
                                });
                            }
                        },
                        error: function() {
                            Swal.fire({
                                icon: 'error',
                                title: 'Hata',
                                text: 'Mazeret kaydı silinemedi!'
                            });
                        }
                    });
                }
            });
        });

        // İptal butonu
        cancelBtn.addEventListener('click', function() {
            restoreOriginalValues();
            document.querySelectorAll('.card-body').forEach(el => {
                el.classList.remove('edit-mode');
            });
            saveBtn.classList.add('d-none');
            cancelBtn.classList.add('d-none');
            editBtn.classList.remove('d-none');

            // Form alanlarını devre dışı bırak
            document.querySelectorAll('.editable-input input, .editable-input textarea').forEach(el => {
                el.disabled = true;
                if (el.type !== 'checkbox') {
                    el.readOnly = true;
                }
            });
            // Sadece select dışındaki alanları disable et, select'ler için ayrıca:
            document.querySelectorAll('.editable-input select').forEach(el => {
                el.disabled = true;
            });

            // Select2 alanlarını devre dışı bırak (ayrılış ve mazeret alanları hariç)
            $('.form-select:not(.ayrilis-input select):not(.mazeret-input select)').prop('disabled', true);
            
            // Mazeret Select2'yi temizle
            $('.mazeret-input select').each(function() {
                if ($(this).hasClass('select2-hidden-accessible')) {
                    $(this).select2('destroy');
                }
            });
        });

        // Unvan değiştiğinde branşları filtrele
        $('#id_unvan').on('change', function() {
            var unvanId = $(this).val();
            var bransSelect = $('#id_brans');
            
            // Branş seçimini temizle
            bransSelect.val(null).trigger('change');
            
            if (unvanId) {
                // AJAX ile branşları getir
                $.get("{% url 'ik_core:get_brans_by_unvan' %}", {unvan_id: unvanId}, function(data) {
                    bransSelect.empty();
                    bransSelect.append('<option value="">Branş seçiniz</option>');
                    
                    data.branslar.forEach(function(brans) {
                        bransSelect.append('<option value="' + brans.id + '">' + brans.ad + '</option>');
                    });
                    
                    bransSelect.trigger('change');
                });
            } else {
                // Unvan seçilmemişse tüm branşları göster
                bransSelect.empty();
                bransSelect.append('<option value="">Branş seçiniz</option>');
                bransSelect.trigger('change');
            }
        });
        
        // Ayrılış işlemi başlat
        if (ayrilisBaslatBtn) {
            ayrilisBaslatBtn.addEventListener('click', function() {
                // Ayrılış input alanlarını görünür yap ve etkinleştir
                document.querySelectorAll('.ayrilis-input').forEach(el => {
                    el.style.display = 'block';
                    
                    // Input alanlarını etkinleştir
                    const inputs = el.querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        input.disabled = false;
                        input.readOnly = false;
                        input.style.backgroundColor = '#fff';
                        input.style.border = '1px solid #ced4da';
                    });
                });
                
                // Ayrılış select alanları için Select2 başlat (sadece ayrılış alanları)
                $('.ayrilis-input select').each(function() {
                    if (!$(this).hasClass('select2-hidden-accessible')) {
                        $(this).select2({
                            theme: 'bootstrap-5',
                            width: '100%',
                            allowClear: true
                        });
                    }
                });
                
                // Ayrılış display alanlarını gizle
                document.querySelectorAll('.ayrilis-input').forEach(el => {
                    const displayEl = el.previousElementSibling;
                    if (displayEl && displayEl.classList.contains('editable-display')) {
                        displayEl.style.display = 'none';
                    }
                });
                
                if (ayrilisKaydetBtn) {
                    ayrilisKaydetBtn.classList.remove('d-none');
                }
                ayrilisBaslatBtn.classList.add('d-none');
                
                // İlişik kesme butonunu güncelle
                ilisikKesmeBtn.classList.add('d-none');
            });
        }
        
        // Ayrılış kaydetme fonksiyonu
        if (ayrilisKaydetBtn) {
            ayrilisKaydetBtn.addEventListener('click', function() {
                const ayrilmaTarihi = document.getElementById('ayrilma_tarihi').value;
                const ayrilmaNedeni = document.getElementById('ayrilma_nedeni').value;
                const ayrilmaDetay = document.getElementById('ayrilma_detay').value;
                
                if (!ayrilmaTarihi) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Uyarı',
                        text: 'Ayrılma tarihi zorunludur!'
                    });
                    return;
                }
                
                if (!ayrilmaNedeni) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Uyarı',
                        text: 'Ayrılma nedeni seçilmelidir!'
                    });
                    return;
                }
                
                // AJAX ile ayrılış bilgilerini kaydet
                $.ajax({
                    url: "{% url 'ik_core:ayrilis_kaydet' personel.id %}",
                    type: 'POST',
                    data: {
                        'ayrilma_tarihi': ayrilmaTarihi,
                        'ayrilma_nedeni': ayrilmaNedeni,
                        'ayrilma_detay': ayrilmaDetay,
                        'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Başarılı',
                                text: 'Ayrılış bilgileri kaydedildi!'
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Hata',
                                text: response.message || 'Ayrılış bilgileri kaydedilemedi!'
                            });
                        }
                    },
                    error: function() {
                        Swal.fire({
                            icon: 'error',
                            title: 'Hata',
                            text: 'Sunucu hatası oluştu!'
                        });
                    }
                });
            });
        }
        
        // Personeli aktifleştirme fonksiyonu
        if (personeliAktiflestirBtn) {
            personeliAktiflestirBtn.addEventListener('click', function() {
                Swal.fire({
                    title: 'Personeli Aktifleştir',
                    text: 'Bu personeli aktifleştirmek istediğinize emin misiniz? Ayrılış bilgileri silinecektir.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Evet, Aktifleştir',
                    cancelButtonText: 'İptal'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // AJAX ile personeli aktifleştir
                        $.ajax({
                            url: "{% url 'ik_core:personeli_aktiflestir' personel.id %}",
                            type: 'POST',
                            data: {
                                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                            },
                            success: function(response) {
                                if (response.success) {
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Başarılı',
                                        text: 'Personel aktifleştirildi!'
                                    }).then(() => {
                                        location.reload();
                                    });
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Hata',
                                        text: response.message || 'Personel aktifleştirilemedi!'
                                    });
                                }
                            },
                            error: function() {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Hata',
                                    text: 'Sunucu hatası oluştu!'
                                });
                            }
                        });
                    }
                });
            });
        }
        
        // Form gönderimi
        document.getElementById('personelDetayForm').addEventListener('submit', function(e) {
            const submitter = e.submitter;
            const action = submitter ? submitter.value : null;
            
            if (action === 'save_main') {
                // Ana form alanlarını etkinleştir
                document.querySelectorAll('.editable-input:not(.ayrilis-input)').forEach(el => {
                    el.disabled = false;
                    if (el.tagName !== 'SELECT' && el.type !== 'checkbox') {
                        el.readOnly = false;
                    }
                });
                
                // Ayrılış alanlarını devre dışı bırak
                document.querySelectorAll('.ayrilis-input').forEach(el => el.disabled = true);
                
                // Hidden input'ları güncelle
                updateHiddenInputs();
            } else if (action === 'save_ayrilis') {
                // Ayrılış alanlarını etkinleştir
                document.querySelectorAll('.ayrilis-input').forEach(el => {
                    el.disabled = false;
                    if (el.tagName !== 'SELECT') {
                        el.readOnly = false;
                    }
                });
                
                // Ana form alanlarını devre dışı bırak
                document.querySelectorAll('.editable-input:not(.ayrilis-input)').forEach(el => el.disabled = true);
                
                // Hidden input'ları ayrılış bilgileri ile güncelle
                updateAyrilisHiddenInputs();
            }
        });
        
        // Hidden input'ları güncelle
        function updateHiddenInputs() {
            // Mevcut değerleri hidden input'lara kopyala
            document.querySelectorAll('.editable-input:not(.ayrilis-input) input, .editable-input:not(.ayrilis-input) select, .editable-input:not(.ayrilis-input) textarea').forEach(el => {
                const name = el.name;
                if (!name) return;
                
                const hiddenInput = document.querySelector(`input[name="${name}"]`);
                if (hiddenInput) {
                    if (el.type === 'checkbox') {
                        hiddenInput.value = el.checked ? 'on' : '';
                    } else if (el.multiple) {
                        // Multiple select için
                        const selectedValues = Array.from(el.selectedOptions).map(opt => opt.value);
                        hiddenInput.value = selectedValues.join(',');
                    } else if (el.type === 'date') {
                        // Tarih alanları için özel işlem
                        hiddenInput.value = el.value;
                    } else {
                        hiddenInput.value = el.value;
                    }
                }
            });
        }
        
        // Ayrılış hidden input'ları güncelle
        function updateAyrilisHiddenInputs() {
            // Ayrılış bilgilerini hidden input'lara kopyala
            document.querySelectorAll('.ayrilis-input input, .ayrilis-input select, .ayrilis-input textarea').forEach(el => {
                const name = el.name;
                if (!name) return;
                
                const hiddenInput = document.querySelector(`input[name="${name}"]`);
                if (hiddenInput) {
                    if (el.type === 'checkbox') {
                        hiddenInput.value = el.checked ? 'on' : '';
                    } else if (el.multiple) {
                        // Multiple select için
                        const selectedValues = Array.from(el.selectedOptions).map(opt => opt.value);
                        hiddenInput.value = selectedValues.join(',');
                    } else {
                        hiddenInput.value = el.value;
                    }
                }
            });
        }
    });
</script>

<!-- Modal Include'ları -->
{% include 'ik_core/partials/yeni_birim_belirle_modal.html' %}
{% include 'ik_core/partials/birim_gecmisi_modal.html' %}
{% endblock %}