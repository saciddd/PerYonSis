{% extends "base.html" %}
{% block title %}Yeni Personel Ekle{% endblock %}
{% block content %}
<div class="container">
    <h3>Yeni Personel Ekle</h3>
    <div id="tcCheckResult" class="alert alert-info d-none" role="alert"></div>
    <div id="kisibilgiSticky" class="alert alert-secondary mt-4 d-none"></div>
    <form id="personelStepperForm" method="post" autocomplete="off">
        {% csrf_token %}
        <div id="personelStepper" class="bs-stepper">
            <div class="bs-stepper-header" role="tablist">
                <div class="step" data-target="#step1">
                    <button type="button" class="step-trigger" role="tab" aria-controls="step1" id="step1-trigger">1. Kişi Bilgileri</button>
                </div>
                <div class="line"></div>
                <div class="step" data-target="#step2">
                    <button type="button" class="step-trigger" role="tab" aria-controls="step2" id="step2-trigger">2. Kurumsal Bilgiler</button>
                </div>
                <div class="line"></div>
                <div class="step" data-target="#step3">
                    <button type="button" class="step-trigger" role="tab" aria-controls="step3" id="step3-trigger">3. Görev Bilgileri</button>
                </div>
                <div class="line"></div>
                <div class="step" data-target="#step4">
                    <button type="button" class="step-trigger" role="tab" aria-controls="step4" id="step4-trigger">4. Mazeret Bilgileri</button>
                </div>
                <div class="line"></div>
                <div class="step" data-target="#step5">
                    <button type="button" class="step-trigger" role="tab" aria-controls="step5" id="step5-trigger">5. Diğer Bilgiler</button>
                </div>
            </div>
            <div class="bs-stepper-content mt-4">
                <!-- Step 1: Kişi Bilgileri -->
                <div id="step1" class="content">
                    <div class="row mb-3">
                        <label for="id_tc_kimlik_no" class="col-sm-3 col-form-label">T.C. Kimlik No</label>
                        <div class="col-sm-9">
                            {{ form.tc_kimlik_no }}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <label for="id_ad" class="col-sm-3 col-form-label">Ad</label>
                        <div class="col-sm-9">{{ form.ad }}</div>
                    </div>
                    <div class="row mb-3">
                        <label for="id_soyad" class="col-sm-3 col-form-label">Soyad</label>
                        <div class="col-sm-9">{{ form.soyad }}</div>
                    </div>
                    <div class="row mb-3">
                        <label for="id_dogum_tarihi" class="col-sm-3 col-form-label">Doğum Tarihi</label>
                        <div class="col-sm-9">{{ form.dogum_tarihi }}</div>
                    </div>
                    <div class="row mb-3">
                        <label for="id_cinsiyet" class="col-sm-3 col-form-label">Cinsiyet</label>
                        <div class="col-sm-9">{{ form.cinsiyet }}</div>
                    </div>
                    <div class="row mb-3">
                        <label for="id_sicil_no" class="col-sm-3 col-form-label">Sicil No</label>
                        <div class="col-sm-9">{{ form.sicil_no }}</div>
                    </div>
                    <div class="row mb-3">
                        <label for="id_unvan" class="col-sm-3 col-form-label">Unvan</label>
                        <div class="col-sm-9 d-flex align-items-center">
                            {{ form.unvan }}
                            <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="clearUnvan">X</button>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <label for="id_brans" class="col-sm-3 col-form-label">Branş</label>
                        <div class="col-sm-9 d-flex align-items-center">
                            {{ form.brans }}
                            <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="clearBrans">X</button>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-primary" id="toStep2">Devam Et</button>
                    </div>
                </div>
                <!-- Step 2: Kurumsal Bilgiler -->
                <div id="step2" class="content">
                    <div class="row mb-3">
                        <label for="id_kurum" class="col-sm-3 col-form-label">Kurum</label>
                        <div class="col-sm-9">{{ form.kurum }}</div>
                    </div>
                    <div class="row mb-3">
                        <label for="id_kadro_yeri" class="col-sm-3 col-form-label">Kadro Yeri</label>
                        <div class="col-sm-9">{{ form.kadro_yeri }}</div>
                    </div>
                    <div class="row mb-3">
                        <label for="id_fiili_gorev_yeri" class="col-sm-3 col-form-label">Fiili Görev Yeri</label>
                        <div class="col-sm-9">{{ form.fiili_gorev_yeri }}</div>
                    </div>
                    <div class="row mb-3">
                        <label for="id_kadrolu_personel" class="col-sm-3 col-form-label">Kadrolu Personel mi?</label>
                        <div class="col-sm-9 d-flex align-items-center">{{ form.kadrolu_personel }}</div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" id="backToStep1">Geri</button>
                        <button type="button" class="btn btn-primary" id="toStep3">Devam Et</button>
                    </div>
                </div>
                <!-- Step 3: Görev Bilgileri -->
                <div id="step3" class="content">
                    <div id="kadroluFields">
                        <div class="row mb-3">
                            <label for="id_teskilat" class="col-sm-3 col-form-label">Teşkilat</label>
                            <div class="col-sm-9">{{ form.teskilat }}</div>
                        </div>
                        <div class="row mb-3">
                            <label for="id_atama_karar_tarihi" class="col-sm-3 col-form-label">Atama Karar Tarihi</label>
                            <div class="col-sm-9">{{ form.atama_karar_tarihi }}</div>
                        </div>
                        <div class="row mb-3">
                            <label for="id_atama_karar_no" class="col-sm-3 col-form-label">Atama Karar No</label>
                            <div class="col-sm-9">{{ form.atama_karar_no }}</div>
                        </div>
                        <div class="row mb-3">
                            <label for="id_goreve_baslama_tarihi" class="col-sm-3 col-form-label">Göreve Başlama Tarihi</label>
                            <div class="col-sm-9">{{ form.goreve_baslama_tarihi }}</div>
                        </div>
                        <div class="row mb-3">
                            <label for="id_memuriyete_baslama_tarihi" class="col-sm-3 col-form-label">Memuriyete Başlama Tarihi</label>
                            <div class="col-sm-9">{{ form.memuriyete_baslama_tarihi }}</div>
                        </div>
                        <div class="row mb-3">
                            <label for="id_emekli_sicil_no" class="col-sm-3 col-form-label">Emekli Sicil No</label>
                            <div class="col-sm-9">{{ form.emekli_sicil_no }}</div>
                        </div>
                        <div class="row mb-3">
                            <label for="id_tahsil_durumu" class="col-sm-3 col-form-label">Tahsil Durumu</label>
                            <div class="col-sm-9">{{ form.tahsil_durumu }}</div>
                        </div>
                    </div>
                    <div id="geciciGorevFields" class="d-none">
                        <div class="row mb-3">
                            <label for="id_gecici_gorev_tipi" class="col-sm-3 col-form-label">Geçici Görev Tipi</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="gecici_gorev_tipi" name="gecici_gorev_tipi" value="Gelis" readonly>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label for="id_gecici_gorev_baslangic" class="col-sm-3 col-form-label">Geçici Görev Başlangıç</label>
                            <div class="col-sm-9">
                                <input type="date" class="form-control" id="gecici_gorev_baslangic" name="gecici_gorev_baslangic">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label for="id_gorevlendirildigi_birim" class="col-sm-3 col-form-label">Görevlendirildiği Birim</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="gorevlendirildigi_birim" name="gorevlendirildigi_birim">
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" id="backToStep2">Geri</button>
                        <button type="button" class="btn btn-primary" id="toStep4">Devam Et</button>
                    </div>
                </div>
                <!-- Step 4: Mazeret Bilgileri (sadece kadrolu ise) -->
                <div id="step4" class="content">
                    <div class="alert alert-info">
                        Personelin mazeret ataması varsa bu alanı doldurun yoksa atlayın.
                    </div>
                    <div class="row mb-3">
                        <label for="id_mazeret_durumu" class="col-sm-3 col-form-label">Mazeret Durumu</label>
                        <div class="col-sm-9">{{ form.mazeret_durumu }}</div>
                    </div>
                    <div class="row mb-3">
                        <label for="id_mazeret_baslangic" class="col-sm-3 col-form-label">Mazeret Başlangıç</label>
                        <div class="col-sm-9">{{ form.mazeret_baslangic }}</div>
                    </div>
                    <div class="row mb-3">
                        <label for="id_mazeret_bitis" class="col-sm-3 col-form-label">Mazeret Bitiş</label>
                        <div class="col-sm-9">{{ form.mazeret_bitis }}</div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" id="backToStep3">Geri</button>
                        <button type="button" class="btn btn-primary" id="toStep5">Devam Et</button>
                    </div>
                </div>
                <!-- Step 5: Diğer Bilgiler -->
                <div id="step5" class="content">
                    <div class="alert alert-info">
                        İzin bilgileri için "Maaş nakil formundan girebilirsiniz".
                    </div>
                    <div class="row mb-3">
                        <label for="id_memur_devreden_izin" class="col-sm-3 col-form-label">Memur Devreden İzin</label>
                        <div class="col-sm-9">{{ form.memur_devreden_izin }}</div>
                    </div>
                    <div class="row mb-3">
                        <label for="id_memur_hak_ettigi_izin" class="col-sm-3 col-form-label">Memur Hak Ettiği İzin</label>
                        <div class="col-sm-9">{{ form.memur_hak_ettigi_izin }}</div>
                    </div>
                    <div class="row mb-3">
                        <label for="id_adres" class="col-sm-3 col-form-label">Adres</label>
                        <div class="col-sm-9">{{ form.adres }}</div>
                    </div>
                    <div class="row mb-3">
                        <label for="id_telefon" class="col-sm-3 col-form-label">Telefon</label>
                        <div class="col-sm-9">{{ form.telefon }}</div>
                    </div>
                    <div class="row mb-3">
                        <label for="id_eposta" class="col-sm-3 col-form-label">E-posta</label>
                        <div class="col-sm-9">{{ form.eposta }}</div>
                    </div>
                    <div class="row mb-3">
                        <label for="id_dhy" class="col-sm-3 col-form-label">DHY</label>
                        <div class="col-sm-9 d-flex align-items-center">{{ form.dhy }}</div>
                    </div>
                    <div class="row mb-3">
                        <label for="id_sgk" class="col-sm-3 col-form-label">SGK</label>
                        <div class="col-sm-9 d-flex align-items-center">{{ form.sgk }}</div>
                    </div>
                    <div class="row mb-3">
                        <label for="id_dss" class="col-sm-3 col-form-label">DSS</label>
                        <div class="col-sm-9 d-flex align-items-center">{{ form.dss }}</div>
                    </div>
                    <div class="row mb-3">
                        <label for="id_shcek" class="col-sm-3 col-form-label">SHÇEK</label>
                        <div class="col-sm-9 d-flex align-items-center">{{ form.shcek }}</div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" id="backToStep4">Geri</button>
                        <button type="submit" class="btn btn-success">Kaydet</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bs-stepper/dist/css/bs-stepper.min.css">
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<style>
/* Stepper stilleri */
.bs-stepper {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 20px;
    margin-bottom: 20px;
}

.bs-stepper-header {
    border-bottom: 1px solid #dee2e6;
    margin-bottom: 20px;
    padding-bottom: 15px;
}

.step {
    display: flex;
    align-items: center;
}

.step-trigger {
    background: none;
    border: none;
    color: #6c757d;
    font-weight: 500;
    padding: 8px 16px;
    border-radius: 20px;
    transition: all 0.3s ease;
    text-decoration: none;
}

.step-trigger:hover {
    background-color: #e9ecef;
    color: #495057;
}

.step.active .step-trigger {
    background-color: #0d6efd;
    color: white;
}

.step.completed .step-trigger {
    background-color: #198754;
    color: white;
}

.line {
    flex: 1;
    height: 2px;
    background-color: #dee2e6;
    margin: 0 10px;
}

.step.completed + .line {
    background-color: #198754;
}

/* Form stilleri */
.form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
}

.form-control, .form-select {
    border-radius: 6px;
    border: 1px solid #ced4da;
    padding: 8px 12px;
    font-size: 14px;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

/* Select2 stilleri */
.select2-container--bootstrap-5 .select2-selection {
    border-radius: 6px;
    border: 1px solid #ced4da;
    min-height: 38px;
    display: flex;
    align-items: center;
}

.select2-container--bootstrap-5 .select2-selection--single {
    padding: 8px 12px;
}

.select2-container--bootstrap-5 .select2-selection__rendered {
    color: #495057;
    font-size: 14px;
}

.select2-container--bootstrap-5 .select2-selection__placeholder {
    color: #6c757d;
}

.select2-container--bootstrap-5 .select2-selection--single .select2-selection__arrow {
    height: 36px;
}

/* Buton stilleri */
.btn {
    border-radius: 6px;
    font-weight: 500;
    padding: 8px 16px;
    font-size: 14px;
    transition: all 0.15s ease-in-out;
}

.btn-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.btn-primary:hover {
    background-color: #0b5ed7;
    border-color: #0a58ca;
}

.btn-secondary {
    background-color: #6c757d;
    border-color: #6c757d;
}

.btn-secondary:hover {
    background-color: #5c636a;
    border-color: #565e64;
}

.btn-success {
    background-color: #198754;
    border-color: #198754;
}

.btn-success:hover {
    background-color: #157347;
    border-color: #146c43;
}

/* Sticky header stilleri */
#kisibilgiSticky {
    position: sticky;
    top: 0;
    z-index: 1000;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 10px 15px;
    margin-bottom: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Alert stilleri */
.alert {
    border-radius: 6px;
    border: none;
    padding: 12px 16px;
    margin-bottom: 15px;
}

.alert-info {
    background-color: #d1ecf1;
    color: #0c5460;
}

/* Validation stilleri */
.is-valid {
    border-color: #198754 !important;
    box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25) !important;
}

.is-invalid {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
}

.select2-container--bootstrap-5 .select2-selection.is-valid {
    border-color: #198754 !important;
}

.select2-container--bootstrap-5 .select2-selection.is-invalid {
    border-color: #dc3545 !important;
}

/* Form validation mesajları */
.validation-message {
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

.validation-message.valid-feedback {
    color: #198754;
}

.validation-message.invalid-feedback {
    color: #dc3545;
}

/* Responsive düzenlemeler */
@media (max-width: 768px) {
    .bs-stepper {
        padding: 15px;
    }
    
    .step-trigger {
        font-size: 12px;
        padding: 6px 12px;
    }
    
    .form-label {
        font-size: 14px;
    }
    
    .btn {
        font-size: 13px;
        padding: 6px 12px;
    }
}
</style>
{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bs-stepper/dist/js/bs-stepper.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var stepperElement = document.getElementById('personelStepper');
    var stepper = new Stepper(stepperElement, {
        linear: false,
        animation: true
    });

    // Select2 ile Unvan ve Branş alanlarını arama yapılabilir yap
    $('#id_unvan').select2({
        theme: 'bootstrap-5',
        width: '100%',
        placeholder: 'Unvan seçiniz',
        allowClear: true,
        dropdownParent: $('body')
    });
    $('#id_brans').select2({
        theme: 'bootstrap-5',
        width: '100%',
        placeholder: 'Branş seçiniz',
        allowClear: true,
        dropdownParent: $('body')
    });

    // Form validation'ı düzelt
    $('#id_brans').removeAttr('required');
    $('#id_brans').attr('data-required', 'false');
    
    // Select2 alanlarının focusable olmasını sağla
    $('.select2-hidden-accessible').removeAttr('tabindex');
    $('.select2-hidden-accessible').removeAttr('aria-hidden');
    
    // Select2 alanlarının validation'da focusable olmasını sağla
    $('.select2-hidden-accessible').attr('tabindex', '0');

    // Form submit işlemini iyileştir
    // Artık kaydet butonuna özel handler kullanıyoruz

    // Form alanlarında Enter tuşuna basıldığında formun submit olmasını engelle
    $('#personelStepperForm input, #personelStepperForm select, #personelStepperForm textarea').on('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            e.stopPropagation();
            
            // Select2 alanı ise özel işlem yap
            if ($(this).hasClass('select2-hidden-accessible')) {
                // Select2 dropdown'ı açık ise kapat
                if ($(this).next('.select2-container').find('.select2-dropdown').is(':visible')) {
                    $(this).select2('close');
                } else {
                    // Dropdown kapalı ise aç
                    $(this).select2('open');
                }
            } else {
                // Normal input alanı ise bir sonraki step'e geç
                var currentStep = stepper._currentIndex;
                var totalSteps = stepper._steps.length;
                
                // Eğer son step değilse bir sonraki step'e geç
                if (currentStep < totalSteps - 1) {
                    // Mevcut step'e göre uygun butonu tetikle
                    switch(currentStep) {
                        case 0: // Step 1 -> Step 2
                            if (document.getElementById('toStep2')) {
                                document.getElementById('toStep2').click();
                            }
                            break;
                        case 1: // Step 2 -> Step 3
                            if (document.getElementById('toStep3')) {
                                document.getElementById('toStep3').click();
                            }
                            break;
                        case 2: // Step 3 -> Step 4 veya Step 5
                            if (document.getElementById('toStep4')) {
                                document.getElementById('toStep4').click();
                            }
                            break;
                        case 3: // Step 4 -> Step 5
                            if (document.getElementById('toStep5')) {
                                document.getElementById('toStep5').click();
                            }
                            break;
                    }
                }
            }
        }
    });

    // Select2 alanları için özel validation
    $('.select2').on('select2:select', function() {
        $(this).removeClass('is-invalid').addClass('is-valid');
        // Select2 container'ı da güncelle
        $(this).next('.select2-container').find('.select2-selection').removeClass('is-invalid').addClass('is-valid');
    });

    $('.select2').on('select2:unselect', function() {
        if ($(this).attr('required')) {
            $(this).removeClass('is-valid').addClass('is-invalid');
            // Select2 container'ı da güncelle
            $(this).next('.select2-container').find('.select2-selection').removeClass('is-valid').addClass('is-invalid');
        }
    });

    // Input alanları için real-time validation
    $('input[required], select[required]').on('input change', function() {
        if (this.value) {
            $(this).removeClass('is-invalid').addClass('is-valid');
            // Select2 container'ı da güncelle
            if ($(this).hasClass('select2-hidden-accessible')) {
                $(this).next('.select2-container').find('.select2-selection').removeClass('is-invalid').addClass('is-valid');
            }
        } else {
            $(this).removeClass('is-valid').addClass('is-invalid');
            // Select2 container'ı da güncelle
            if ($(this).hasClass('select2-hidden-accessible')) {
                $(this).next('.select2-container').find('.select2-selection').removeClass('is-valid').addClass('is-invalid');
            }
        }
    });

    // Sayfa yüklendiğinde mevcut değerleri kontrol et
    $('input[required], select[required]').each(function() {
        if (this.value) {
            $(this).addClass('is-valid');
            if ($(this).hasClass('select2-hidden-accessible')) {
                $(this).next('.select2-container').find('.select2-selection').addClass('is-valid');
            }
        }
    });

    // Temizleme butonları
    document.getElementById('clearUnvan').addEventListener('click', function() {
        $('#id_unvan').val(null).trigger('change');
    });
    
    document.getElementById('clearBrans').addEventListener('click', function() {
        $('#id_brans').val(null).trigger('change');
    });

    // Unvan değiştiğinde branşları filtrele
    $('#id_unvan').on('change', function() {
        var unvanId = $(this).val();
        var bransSelect = $('#id_brans');
        
        // Branş seçimini temizle
        bransSelect.val(null).trigger('change');
        
        if (unvanId) {
            // AJAX ile branşları getir
            $.get("{% url 'ik_core:get_brans_by_unvan' %}", {unvan_id: unvanId}, function(data) {
                bransSelect.empty();
                bransSelect.append('<option value="">Branş seçiniz</option>');
                
                data.branslar.forEach(function(brans) {
                    bransSelect.append('<option value="' + brans.id + '">' + brans.ad + '</option>');
                });
                
                bransSelect.trigger('change');
            });
        } else {
            // Unvan seçilmemişse tüm branşları göster
            bransSelect.empty();
            bransSelect.append('<option value="">Branş seçiniz</option>');
            bransSelect.trigger('change');
        }
    });

    // Sticky header update function
    function updateStickyHeader() {
        const ad = document.getElementById('id_ad').value || '[Ad Girilmemiş]';
        const soyad = document.getElementById('id_soyad').value || '[Soyad Girilmemiş]';
        const tc = document.getElementById('id_tc_kimlik_no').value || '[TC Girilmemiş]';
        const sicil = document.getElementById('id_sicil_no').value || '[Sicil Girilmemiş]';
        const unvanSelect = document.getElementById('id_unvan');
        const unvan = unvanSelect && unvanSelect.selectedOptions[0] ? unvanSelect.selectedOptions[0].text : '[Unvan Seçilmemiş]';
        const bransSelect = document.getElementById('id_brans');
        const brans = bransSelect && bransSelect.selectedOptions[0] ? bransSelect.selectedOptions[0].text : '[Branş Seçilmemiş]';

        const stickyDiv = document.getElementById('kisibilgiSticky');
        stickyDiv.innerHTML = `<strong>${ad} ${soyad}</strong> (TC: ${tc}, Sicil: ${sicil}) - ${unvan} / ${brans}`;
        if (stepper._currentIndex > 0) {
            stickyDiv.classList.remove('d-none');
        } else {
            stickyDiv.classList.add('d-none');
        }
    }

    document.querySelectorAll('#step1 input, #step1 select').forEach(input => {
        input.addEventListener('change', updateStickyHeader);
        if (input.type === 'text' || input.type === 'number') {
            input.addEventListener('input', updateStickyHeader);
        }
    });

    // --- Navigation ---
    document.getElementById('toStep2').addEventListener('click', function() {
        const tc = document.getElementById('id_tc_kimlik_no').value.trim();
        const tcCheckResultDiv = document.getElementById('tcCheckResult');
        tcCheckResultDiv.classList.add('d-none');
        if (!tc || tc.length !== 11 || !/^\d+$/.test(tc)) {
            alert('Lütfen geçerli bir T.C. Kimlik No giriniz.');
            return;
        }
        fetch("{% url 'ik_core:personel_kontrol' %}?tc_kimlik_no=" + tc)
            .then(resp => resp.json())
            .then(data => {
                if (data.exists) {
                    tcCheckResultDiv.className = 'alert alert-danger';
                    tcCheckResultDiv.textContent = 'Bu T.C. Kimlik No ile kayıtlı bir personel zaten var!';
                    tcCheckResultDiv.classList.remove('d-none');
                } else {
                    tcCheckResultDiv.classList.add('d-none');
                    updateStickyHeader();
                    stepper.next();
                }
            })
            .catch(() => {
                tcCheckResultDiv.className = 'alert alert-warning';
                tcCheckResultDiv.textContent = 'T.C. kontrolü sırasında bir hata oluştu.';
                tcCheckResultDiv.classList.remove('d-none');
            });
    });

    document.getElementById('backToStep1').addEventListener('click', function() { stepper.previous(); });
    document.getElementById('toStep3').addEventListener('click', function() { stepper.next(); });
    document.getElementById('backToStep2').addEventListener('click', function() { stepper.previous(); });

    document.getElementById('toStep4').addEventListener('click', function() {
        const kadroluCheckbox = document.getElementById('id_kadrolu_personel');
        if (kadroluCheckbox && kadroluCheckbox.checked) {
            stepper.next();
        } else {
            stepper.to(5);
        }
    });

    document.getElementById('backToStep3').addEventListener('click', function() { stepper.previous(); });
    document.getElementById('toStep5').addEventListener('click', function() { stepper.next(); });

    document.getElementById('backToStep4').addEventListener('click', function() {
        const kadroluCheckbox = document.getElementById('id_kadrolu_personel');
        if (kadroluCheckbox && kadroluCheckbox.checked) {
            stepper.previous();
        } else {
            stepper.to(3);
        }
    });

    const kadroluCheckbox = document.getElementById('id_kadrolu_personel');
    const kadroluFieldsDiv = document.getElementById('kadroluFields');
    const geciciGorevFieldsDiv = document.getElementById('geciciGorevFields');
    const step4Trigger = document.querySelector('.step[data-target="#step4"]');
    const step4Content = document.getElementById('step4');

    function toggleFieldsVisibility() {
        if (!kadroluCheckbox) return;

        if (kadroluCheckbox.checked) {
            if (kadroluFieldsDiv) kadroluFieldsDiv.classList.remove('d-none');
            if (geciciGorevFieldsDiv) geciciGorevFieldsDiv.classList.add('d-none');
            if (step4Trigger) step4Trigger.style.display = '';
        } else {
            if (kadroluFieldsDiv) kadroluFieldsDiv.classList.add('d-none');
            if (geciciGorevFieldsDiv) geciciGorevFieldsDiv.classList.remove('d-none');
            if (step4Trigger) step4Trigger.style.display = 'none';
            if (step4Content) step4Content.classList.add('d-none');
        }
    }

    if (kadroluCheckbox) {
        kadroluCheckbox.addEventListener('change', toggleFieldsVisibility);
    }

    stepperElement.addEventListener('show.bs-stepper', function (event) {
        if (event.detail.indexStep > 0) {
            updateStickyHeader();
            document.getElementById('kisibilgiSticky').classList.remove('d-none');
        } else {
            document.getElementById('kisibilgiSticky').classList.add('d-none');
        }

        if (event.detail.indexStep === 2) {
            toggleFieldsVisibility();
        }

        const kadroluCheckbox = document.getElementById('id_kadrolu_personel');
        const step4Content = document.getElementById('step4');

        if (event.detail.indexStep === 3) {
            if (kadroluCheckbox && !kadroluCheckbox.checked) {
                if (step4Content) step4Content.classList.add('d-none');
                stepper.to(5);
            } else if (step4Content) {
                step4Content.classList.remove('d-none');
            }
        }
    });

    toggleFieldsVisibility();
    updateStickyHeader();

    // Kaydet butonuna özel validation
    $('button[type="submit"]').on('click', function(e) {
        e.preventDefault();
        
        // Branş alanının required olmamasını sağla
        $('#id_brans').removeAttr('required');
        
        // Required alanları kontrol et ve kullanıcıya bildir
        var requiredFields = [
            { id: 'id_tc_kimlik_no', name: 'T.C. Kimlik No' },
            { id: 'id_ad', name: 'Ad' },
            { id: 'id_soyad', name: 'Soyad' },
            { id: 'id_unvan', name: 'Unvan' },
            { id: 'id_kurum', name: 'Kurum' },
            { id: 'id_kadro_yeri', name: 'Kadro Yeri' },
            { id: 'id_fiili_gorev_yeri', name: 'Fiili Görev Yeri' }
        ];
        
        var missingFields = [];
        
        requiredFields.forEach(function(field) {
            var element = document.getElementById(field.id);
            if (element && !element.value) {
                missingFields.push(field.name);
            }
        });
        
        if (missingFields.length > 0) {
            var message = 'Lütfen aşağıdaki zorunlu alanları doldurun:\n\n';
            message += missingFields.join('\n');
            alert(message);
            
            // İlk eksik alana odaklan
            var firstMissingField = document.getElementById(requiredFields.find(f => 
                missingFields.includes(f.name)).id);
            if (firstMissingField) {
                // Select2 alanı ise özel işlem yap
                if (firstMissingField.classList.contains('select2-hidden-accessible')) {
                    // Select2 container'ına odaklan ve dropdown'ı aç
                    setTimeout(function() {
                        $(firstMissingField).select2('open');
                        // Select2 container'ına scroll yap
                        var select2Container = $(firstMissingField).next('.select2-container');
                        select2Container[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                } else {
                    firstMissingField.focus();
                    // Scroll to element
                    firstMissingField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
            return false; // Form gönderimini durdur
        }
        
        // Tüm validation geçtiyse formu gönder
        $('#personelStepperForm').submit();
    });
});
</script>
{% endblock %}