{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container mt-3">
  <style>
    /* Print area typography and clean paper look */
    #printArea { font-family: "Times New Roman", Times, serif; font-size: 12pt; }
    #printArea pre { font-family: inherit; font-size: inherit; }
    #printArea #ResmiYazi { border: none; box-shadow: none; outline: none; resize: none; padding: 0; }
  </style>
  <div class="row">
    <div class="col-md-4">
      <div class="d-flex justify-content-end mb-2">
        <button class="btn btn-success" onclick="printArea()">Kaydet ve Yazdır</button>
      </div>
      <div class="mb-2">
        <label class="form-label">İmza</label>
        <div class="input-group">
          <select id="ddlImza" class="form-select" onchange="updatePreview()">
            <option value="">Seçiniz</option>
            {% for i in imzalar %}
              <option value="{{ i.id }}" data-metin="{{ i.metin|escapejs }}">{{ i.ad }}</option>
            {% endfor %}
          </select>
          <a class="btn btn-outline-secondary" href="{% url 'ik_core:imza_tanimlari' %}"><i class="bi bi-gear"></i></a>
        </div>
      </div>
      <div class="mb-2">
        <label class="form-label">Yazı</label>
        <div class="input-group">
          <select id="ddlYazi" class="form-select" onchange="loadResmiYazi()">
            <option value="">Seçiniz</option>
            {% for t in resmi_yazilar %}
              <option value="{{ t.id }}">{{ t.ad }}</option>
            {% endfor %}
          </select>
          <a class="btn btn-outline-secondary" href="{% url 'ik_core:resmi_yazi_tanimlari' %}"><i class="bi bi-gear"></i></a>
        </div>
      </div>
      <div class="mb-2">
        <label class="form-label">İlgi</label>
        <!-- varsayılan readonly; loadResmiYazi ile editable olacak -->
        <input type="text" class="form-control" name="ilgi" id="resmi_yazi_ilgi" readonly oninput="updateIlgiEkPreview()">
      </div>
      <div class="mb-2">
        <label class="form-label">Ek</label>
        <!-- varsayılan readonly; loadResmiYazi ile editable olacak -->
        <input type="text" class="form-control" name="ek" id="resmi_yazi_ek" readonly oninput="updateIlgiEkPreview()">
      </div>
      <hr/>
      <div class="small">
        <div><strong>Personel Adı Soyadı:</strong> {{ personel.ad }} {{ personel.soyad }}</div>
        <div><strong>Sicil No:</strong> {{ personel.sicil_no }}</div>
        <div><strong>Unvan:</strong> {{ personel.unvan }}</div>
        <div><strong>Branş:</strong> {{ personel.brans }}</div>
      </div>
    </div>
    <div class="col-md-8">
      <div class="border border-secondary shadow-sm p-3 mb-5 bg-white rounded">
        <div id="printArea">
          <br/>
          <br/>
          <div class="text-center">Sayın {{ personel.ad }} {{ personel.soyad }}</div>
          <div class="text-center">{{ personel.unvan }}{% if personel.brans %} {{ personel.brans }}{% endif %}</div>
          <div style="height:2em"></div>
          <div>
            <!-- Resmi yazıda ilgi varsa bu alana eklenecek -->
            <div id="ilgi"></div>
            <div style="height:2em"></div>
          </div>
          <div>
            <textarea id="ResmiYazi" class="form-control" rows="6" oninput="debouncedMetinChanged()" placeholder="Metin yüklemek için soldan seçiniz..."></textarea>
          </div>
          <div style="height:1em"></div>
          <div class="row text-center mt-2" style="min-height:6em">
            <div class="col"></div>
            <div class="col"></div>
            <div class="col"><pre id="imzaMetin" style="white-space:pre-line">&nbsp;</pre></div>
          </div>
          <!-- Ek alanı -->
          <div style="height:3em"></div>
          <div id="ek"></div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock%}
{% block extra_js %}
<script>
let metinUpdateTimer = null;
function updatePreview(){
  const selImza = document.getElementById('ddlImza');
  const raw = selImza.selectedOptions[0]?.dataset?.metin || '';
  // Decode escape sequences like \u000D\u000A and \n so line breaks render
  const decoded = raw
    .replace(/\\u000D/gi, '\r')
    .replace(/\\u000A/gi, '\n')
    .replace(/\\n/g, '\n');
  document.getElementById('imzaMetin').textContent = decoded;
}

// Yeni: ilgi/ek önizlemesini güncelleyen yardımcı fonksiyon
function updateIlgiEkPreview(){
  const ilgiInput = document.getElementById('resmi_yazi_ilgi');
  const ekInput = document.getElementById('resmi_yazi_ek');
  const ilgiEl = document.getElementById('ilgi');
  const ekEl = document.getElementById('ek');

  if(ilgiEl){
    const v = (ilgiInput?.value || '').trim();
    ilgiEl.textContent = v ? 'İlgi   : ' + v : '';
    ilgiEl.style.whiteSpace = v ? 'pre-line' : '';
  }
  if(ekEl){
    const v2 = (ekInput?.value || '').trim();
    ekEl.textContent = v2 ? 'Ek     : ' + v2 : '';
    ekEl.style.whiteSpace = v2 ? 'pre-line' : '';
  }
}

async function loadResmiYazi(){
  const id = document.getElementById('ddlYazi').value;
  if(!id) return;
  try {
    const res = await fetch('{% url "ik_core:resmi_yazi_get" 0 %}'.replace('/0/','/'+id+'/'));
    if(!res.ok) return;
    const data = await res.json();
    document.getElementById('ResmiYazi').value = (data.metin || '');

    // İlgi alanını güncelle ve editable yap
    const ilgiElInput = document.getElementById('resmi_yazi_ilgi');
    if (ilgiElInput) {
      ilgiElInput.value = data.ilgi || '';
      ilgiElInput.readOnly = false;
    }
    // Ek alanını güncelle ve editable yap
    const ekElInput = document.getElementById('resmi_yazi_ek');
    if (ekElInput) {
      ekElInput.value = data.ek || '';
      ekElInput.readOnly = false;
    }

    // Önizlemeyi güncelle (boşsa temizleyecek)
    updateIlgiEkPreview();

    updatePreview();
  } catch (e) {
    console.error(e);
  }
}
function debouncedMetinChanged(){
  updatePreview();
  if(metinUpdateTimer){ clearTimeout(metinUpdateTimer); }
  metinUpdateTimer = setTimeout(saveMetinIfSelected, 600);
}
async function saveMetinIfSelected(){
  const id = document.getElementById('ddlYazi').value;
  if(!id) return;

  const formData = new FormData();
  // ad alanı backend tarafından zorunlu görünüyor, dropdowndaki metni gönder
  const ad = document.getElementById('ddlYazi').selectedOptions[0]?.textContent || '';
  formData.append('ad', ad);
  formData.append('metin', document.getElementById('ResmiYazi').value || '');

  const ilgiVal = document.getElementById('resmi_yazi_ilgi')?.value || '';
  const ekVal = document.getElementById('resmi_yazi_ek')?.value || '';
  formData.append('ilgi', ilgiVal);
  formData.append('ek', ekVal);

  const url = '{% url "ik_core:resmi_yazi_guncelle" 0 %}'.replace('/0/','/'+id+'/');
  await fetch(url, {method:'POST', headers:{'X-CSRFToken': '{{ csrf_token }}'}, body: formData});

  // Önizlemeyi güncelle (özellikle otomatik kayıttan sonra)
  updateIlgiEkPreview();
}

function printArea(){
  const contentEl = document.getElementById('printArea');
  if(!contentEl) return;

  // Klon oluştur ve textarea içeriğini görüntülenebilir elemana çevir
  const clone = contentEl.cloneNode(true);
  const taInClone = clone.querySelector('#ResmiYazi');
  if(taInClone){
    const display = document.createElement('div');
    display.style.whiteSpace = 'pre-wrap';
    display.style.fontFamily = 'inherit';
    display.style.fontSize = 'inherit';
    // Orijinal textarea'dan güncel değeri al
    const originalVal = document.getElementById('ResmiYazi')?.value || '';
    display.textContent = originalVal;
    taInClone.parentNode.replaceChild(display, taInClone);
  }

  const generatePDF = () => {
    const opt = {
      margin:       [50,10,10,10], // mm
      filename:     'resmi_yazi.pdf',
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2, useCORS: true },
      jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    // html2pdf -> blob -> yeni sekmede aç
    window.html2pdf().set(opt).from(clone).outputPdf('blob').then(function(blob){
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank');
    }).catch(function(e){ console.error(e); alert('PDF oluşturulurken hata: ' + e); });
  };

  if(window.html2pdf){
    generatePDF();
  } else {
    // CDN'den yükle ve sonra üret
    const scriptUrl = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js';
    const s = document.createElement('script');
    s.src = scriptUrl;
    s.onload = generatePDF;
    s.onerror = function(){ alert('PDF kütüphanesi yüklenemedi. İnternet bağlantınızı veya CDN erişimini kontrol edin.'); };
    document.head.appendChild(s);
  }
}
updatePreview();
</script>
{% endblock %}