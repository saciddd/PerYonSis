{% extends "base.html" %}
{% load static %}
{% block title %}657 Çizelge İşlemleri{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cizelge.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
<form id="filterForm" method="get" class="row g-2 align-items-end mb-3">
    <!-- Dönem Seçimi -->
    <div class="col-auto">
        <label for="selectDonem" class="form-label small fw-bold">Dönem</label>
        <select name="donem" id="selectDonem" class="form-select form-select-sm" style="width: 120px;" required>
            <option value="">Seçiniz</option>
            {% for donem in donemler %}
                <option value="{{ donem.value }}" {% if donem.value == selected_donem %}selected{% endif %}>
                    {{ donem.label }}
                </option>
            {% endfor %}
        </select>
    </div>

    <!-- Birim ve Personel Seçimi -->
    <div class="col-auto">
        <label for="selectBirim" class="form-label small fw-bold">Birim</label>
        <div class="input-group input-group-sm">
            <select name="birim_id" id="selectBirim" class="form-select" style="width: 180px;" required>
                <option value="">Seçiniz</option>
                {% with birim_found=False %}
                {% for user_birim in user_birimler %}
                    {% if user_birim.birim.BirimID == selected_birim_id|add:0 %}
                        {% with birim_found=True %}{% endwith %}
                    {% endif %}
                {% endfor %}
                {% if selected_birim_id and not birim_found %}
                    <option value="{{ selected_birim_id }}" selected>{{ birim.BirimAdi }}</option>
                {% endif %}
                {% endwith %}
                {% for user_birim in user_birimler %}
                    <option value="{{ user_birim.birim.BirimID }}" {% if user_birim.birim.BirimID == selected_birim_id|add:0 %}selected{% endif %}>
                        {{ user_birim.birim.BirimAdi }}
                    </option>
                {% endfor %}
            </select>
            <button class="btn btn-outline-secondary" type="button" title="Birim Yönetimi" data-bs-toggle="modal" data-bs-target="#birimYonetimModal">
                <i class="bi bi-gear"></i>
            </button>
            <button class="btn btn-success" type="button" id="btnPersonelEkle" title="Personel Ekle">
                <i class="bi bi-person-plus"></i> Personel Ekle
            </button>
        </div>
    </div>

    <!-- Personel Arama -->
    <div class="col-auto" id="editControls1">
        <label for="personelAramaSelect" class="form-label small fw-bold">Personel Ara</label>
        <div>
        <select id="personelAramaSelect" name="personel_id" class="form-select" style="width: 200px;" required>
            <option value="">Ara...</option>
        </select>
        </div>
    </div>

    <!-- Mesai/İzin Kontrolleri -->
    <div class="col-auto" id="editControls2">
        <div class="d-flex align-items-center gap-2 mb-2">
            <label class="form-label small fw-bold mb-0">İşlemler</label>
            <button class="btn btn-outline-warning btn-sm" onclick="openFavoriMesaiModal()">
                <i class="bi bi-star"></i> Favori Mesailer
            </button>
        </div>
        <div class="input-group input-group-sm">
            <select id="mesaiSelection" class="form-select" style="width: 110px;">
                <option value="">Mesai</option>
                {% for mesai in mesai_options %}
                <option value="mesai_{{ mesai.id }}">{{ mesai.Saat }}</option>
                {% endfor %}
            </select>
            <select id="izinSelection" class="form-select" style="width: 100px;">
                <option value="">İzin</option>
                {% for izin in izinler %}
                <option value="izin_{{ izin.id }}">{{ izin.ad }}</option>
                {% endfor %}
            </select>
            <select id="mesaiNotuSelection" class="form-select" style="width: 90px;">
                <option value="">Not</option>
                <option value="★">★</option>
                <option value="★★">★★</option>
                <option value="★★★">★★★</option>
                <option value="TAK">TAK</option>
                <option value="TEMIZLE">Temizle</option>
            </select>
        </div>
    </div>

    <!-- Alan Boşalt Switch -->
    <div class="col-auto" id="editControls3">
        <div class="form-check form-switch mt-1">
            <input class="form-check-input" type="checkbox" id="alanBosaltSwitch">
            <label class="form-check-label small" for="alanBosaltSwitch">Alanı Boşalt</label>
        </div>
            <div class="form-check form-switch mt-1">
                <input class="form-check-input" type="checkbox" id="stopModeSwitch">
                <label class="form-check-label small" for="stopModeSwitch">Stoplama Modu</label>
            </div>
    </div>

    <!-- Aksiyon Butonları -->
    <div class="col-auto ms-auto">
        <div class="btn-group btn-group-sm mt-3">
            <button type="button" class="btn btn-outline-primary" id="btnYazdir" title="Yazdır">
                <i class="bi bi-printer"></i>
            </button>
            <button type="button" class="btn btn-success" id="saveButton" title="Kaydet">Kaydet</button>
            <button type="button" class="btn btn-outline-secondary" id="topluIslemButton" title="Toplu İşlemler">
                <i class="bi bi-gear"></i>
            </button>
        </div>
        <button type="button" class="btn btn-primary btn-sm d-none mt-3" id="approveAllButton">Tümünü Onayla</button>
    </div>
</form>

    {% if personeller %}
    <!-- Personel Sıralama Butonu -->
    <div class="mb-2">
        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#personelSiralaModal">
            <i class="bi bi-list-ul"></i> Personelleri Sırala
        </button>
    <!-- İlk Liste Bildirimi Butonu -->
    <button class="btn btn-outline-primary btn-sm"
        onclick="olusturIlkListe('{{ liste|default:0 }}')">
            {% if ilk_liste %}
                <i class="bi bi-check-circle-fill text-success"></i> İlk Liste Bildirimi Oluşturuldu
            {% else %}
                <i class="bi bi-exclamation-circle-fill text-warning"></i> İlk Liste Bildirimi Oluştur
            {% endif %}
    </button>
    <button class="btn btn-outline-success btn-sm" type="button" id="showFazlaMesaiBtn" title="Fazla Mesaileri Hesapla">
        <i class="bi bi-clock-history"></i> Fazla Mesaileri Göster
    </button>
    <button type="button" class="btn btn-outline-secondary btn-sm" id="imzaCizelgeleriBtn" title="İmza Çizelgeleri Yazdır">
        <i class="bi bi-printer"></i> İmza Çizelgeleri
    </button>
    </div>

    <div class="table-responsive" style="max-height: calc(100vh - 250px); overflow: auto; padding-bottom: 10px;">
    <table id="cizelgeTable" class="table table-sm table-bordered table-hover">
        <colgroup>
            <col style="width: 12px;">
            <col style="width: 120px;">
            <col style="width: 100px;">
            <col style="width: 80px;">
            {% for day in days %}
            <col style="width: 32px;">
            {% endfor %}
        </colgroup>
        <thead class="table-light sticky-header">
            <tr>
                <th class="sticky-col-1">S/N</th>
                <th class="sticky-col-2">Personel Adı Soyadı</th>
                <th class="sticky-col-3">Unvanı</th>
                <th>Fazla Mesai</th>
                {% for day in days %}
                <th class="{% if day.is_weekend %}weekend{% elif day.is_resmi_tatil %}resmi-tatil{% endif %}">{{ day.day_num }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody id="tableBody">
            {% for personel in personeller %}
            <tr id="personel-{{ personel.PersonelID }}">
                <!-- Satır Numarası -->
                <td class="sticky-col sticky-col-1">{{ forloop.counter }}</td>
                <td class="sticky-col sticky-col-2">
                    {{ personel.PersonelName }} {{ personel.PersonelSurname }}
                    <i class="bi bi-person-circle text-primary ms-1 person-profile-btn" 
                       style="cursor: pointer; font-size: 0.9em;" 
                       data-personel-id="{{ personel.PersonelID }}"
                       data-liste-id="{{ liste.id|default:0 }}"
                       data-year="{{ current_year }}"
                       data-month="{{ current_month }}"
                       title="Personel Profili" role="button"></i>
                </td>
                <td class="sticky-col sticky-col-3">{{ personel.PersonelTitle }}</td>
                <td class="fazla-mesai-cell">-</td>
                {% for mesai in personel.mesai_data %}
                <td contenteditable="true"
                    class="mesai-cell {% if mesai.Saat or mesai.IzinAd %}has-value{% endif %} {% if mesai.is_weekend %}weekend{% elif mesai.is_resmi_tatil %}resmi-tatil{% endif %} {% if mesai.SistemdekiIzin %}sistemdeki-izin{% endif %}"
                    data-personel-id="{{ personel.PersonelID }}"
                    data-date="{{ mesai.MesaiDate }}"
                    data-mesai-pk="{{ mesai.MesaiID|default:'' }}"
                    data-mesai-id="{{ mesai.MesaiTanimID|default:'' }}"
                    data-izin-id="{{ mesai.IzinID|default:'' }}"
                    data-mesai-notu="{{ mesai.MesaiNotu|default:'' }}"
                    data-degisiklik="{{ mesai.Degisiklik|yesno:'1,0' }}"
                    data-prev-saat="{{ mesai.PrevSaat }}"
                    data-prev-izin="{{ mesai.PrevIzinAd }}"
                    {% if mesai.MesaiTanimRenk %} style="color: {{ mesai.MesaiTanimRenk }}; font-weight: bold;"{% endif %}>
                    <span class="mesai-notu-badge" {% if not mesai.MesaiNotu %}style="display:none"{% endif %}>{{ mesai.MesaiNotu }}</span>
                    <span class="mesai-main-value">
                        {{ mesai.Saat|default:mesai.IzinAd }}
                    </span>
                    {% if mesai.Degisiklik %}
                      <i class="bi bi-check-circle text-danger float-end" title="Onay bekleyen mesai. Önceki: {{ mesai.PrevSaat|default:mesai.PrevIzinAd }} | Talep edilen: {{ mesai.Saat|default:mesai.IzinAd }}"></i>
                    {% endif %}
                    {% if mesai.StopKaydi %}
                        <i class="bi bi-pause-circle text-warning float-end ms-1" title="Stop kaydı: {{ mesai.StopKaydi.StopBaslangic }} - {{ mesai.StopKaydi.StopBitis }} | Süre: {{ mesai.StopKaydi.Sure }} saat | Oluşturan: {{ mesai.StopKaydi.created_by }}"></i>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="alert alert-warning">Lütfen bir birim ve dönem seçiniz.</div>
    {% endif %}
</div>

<script>
    window.saveUrl = "{% url 'mercis657:personel_listesi_sira_kaydet' liste|default:0 %}";
</script>
<script src="{% static 'mercis657/js/personel_sirala.js' %}"></script>
<!-- Personel Ekleme Modal ve Birim Yönetimi Modal -->
{% include "mercis657/cizelge_birim_yonetim_modal.html" %}
{% include "mercis657/cizelge_personel_ekle_modal.html" %}
{% include "mercis657/personel_sirala_modal.html" %}
{% include 'mercis657/partials/birim_yetkili_kullanicilar_modal.html' %}

<!-- Personel Profil Modal -->
<div id="personelProfilContainer"></div>

<!-- Toplu İşlem Modal -->
<div id="topluIslemContainer"></div>

<!-- Yazdır Modal -->
<div class="modal fade" id="yazdirModal" tabindex="-1" aria-labelledby="yazdirModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="yazdirModalLabel">Çalışma Listesi Yazdır</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        <label for="yazdirAciklama" class="form-label">Açıklama</label>
        <textarea id="yazdirAciklama" class="form-control" rows="4">{{ aciklama }}</textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="yazdirModalBtn">Yazdır</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'mercis657/js/birim_kullanici_yetkileri.js' %}"></script>
<script>
    // Fazla mesai hesaplama
    document.addEventListener('DOMContentLoaded', function() {
        var showFazlaMesaiBtn = document.getElementById("showFazlaMesaiBtn");
        if (showFazlaMesaiBtn) {
            showFazlaMesaiBtn.addEventListener("click", function() {
                const donem = document.getElementById('selectDonem').value; // YYYY/MM
                const [year, month] = donem.split('/');
                // Prefer the rendered PersonelListesi id ("liste") if available, otherwise fall back to selected birim
                const renderedListeId = {{ liste|default:0 }};
                const listeId = renderedListeId && renderedListeId !== 0 ? renderedListeId : document.getElementById('selectBirim').value;

                // Show loading state
                Swal.fire({
                    title: 'Hesaplanıyor...',
                    html: 'Fazla mesailer hesaplanıyor, lütfen bekleyin.',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                fetch(`/mercis657/fazla-mesai-hesapla?year=${year}&month=${month}&liste_id=${listeId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === "success") {
                            data.data.forEach(item => {
                                try {
                                    const rowId = `personel-${item.personel_id}`;
                                    const cell = document.querySelector(`#${rowId} .fazla-mesai-cell`);
                                    if (cell) {
                                        const fm = Number(item.fazla_mesai);
                                        cell.textContent = `${fm > 0 ? '+' : ''}${fm}`;
                                        cell.classList.remove('fm-pos', 'fm-neg');
                                        if (fm > 0) cell.classList.add('fm-pos');
                                        else if (fm < 0) cell.classList.add('fm-neg');
                                    } else {
                                        console.warn('Fazla mesai hücresi bulunamadı', item.personel_id);
                                    }
                                } catch (e) {
                                    console.error('Error while updating badge for', item.personel_id, e);
                                }
                            });
                            Swal.fire({
                                title: "Tamamlandı",
                                text: "Fazla mesailer hesaplandı.",
                                icon: "success"
                            });
                        } else {
                            throw new Error(data.message || 'Hesaplama hatası');
                        }
                    })
                    .catch(error => {
                        console.error('Fazla mesai hesaplama hatası:', error);
                        Swal.fire({
                            title: "Hata",
                            text: error.message || "Fazla mesailer hesaplanırken bir hata oluştu.",
                            icon: "error"
                        });
                    });
            });
        }

        // İmza Çizelgeleri Yazdır
        const imzaBtn = document.getElementById("imzaCizelgeleriBtn");
        if (imzaBtn && window.Swal) {
            imzaBtn.addEventListener("click", function() {
                Swal.fire({
                    title: "İmza Çizelgeleri Hazırlansın mı?",
                    text: "İlgili döneme ait İmza Çizelgeleri hazırlanacak. Mesai verileri olsun mu?",
                    icon: "question",
                    showCancelButton: true,
                    confirmButtonText: "Evet, mesai verileriyle",
                    cancelButtonText: "İptal",
                    showDenyButton: true,
                    denyButtonText: "Hayır, boş çizelge",
                }).then((result) => {
                    if (result.isConfirmed || result.isDenied) {
                        const includeMesai = result.isConfirmed;
                        const donem = document.getElementById('selectDonem').value; // YYYY/MM
                        const [year, month] = donem.split('/');
                        const birimId = document.getElementById('selectBirim').value;
                        if (!year || !month || !birimId) {
                            Swal.fire('Uyarı', 'Lütfen dönem ve birim seçiniz.', 'warning');
                            return;
                        }
                        fetch(`/mercis657/imza_cizelgeleri_yazdir/?mesai=${includeMesai}&year=${year}&month=${month}&birim=${birimId}`)
                            .then(res => res.blob())
                            .then(blob => {
                                const url = window.URL.createObjectURL(blob);
                                window.open(url, "_blank");
                            })
                            .catch(() => Swal.fire('Hata', 'PDF oluşturulamadı.', 'error'));
                    }
                });
            });
        }

        var selectDonem = document.getElementById('selectDonem');
        if (selectDonem) {
            selectDonem.addEventListener('change', function() {
                document.getElementById('filterForm').submit();
            });
        }
        var selectBirim = document.getElementById('selectBirim');
        if (selectBirim) {
            selectBirim.addEventListener('change', function() {
                document.getElementById('filterForm').submit();
            });
        }
    });

    // Dönem veya birim değiştiğinde sorgula (sayfayı yenile)
    document.getElementById('selectDonem').addEventListener('change', function() {
        document.getElementById('filterForm').submit();
    });
    document.getElementById('selectBirim').addEventListener('change', function() {
        document.getElementById('filterForm').submit();
    });

    // Approval mod kontrolü: URL'de approval=1 ise edit kontrolleri gizle, Tümünü Onayla göster
    const params = new URLSearchParams(window.location.search);
    const isApproval = params.get('approval') === '1';
    const editControls1 = document.getElementById('editControls1');
    const editControls2 = document.getElementById('editControls2');
    const editControls3 = document.getElementById('editControls3');
    const saveButton = document.getElementById('saveButton');
    const approveAllButton = document.getElementById('approveAllButton');
    const topluIslemButton = document.getElementById('topluIslemButton');
    
    if (isApproval) {
        editControls1.classList.add('d-none');
        editControls2.classList.add('d-none');
        editControls3.classList.add('d-none');
        saveButton.classList.add('d-none');
        topluIslemButton.classList.add('d-none');
        approveAllButton.classList.remove('d-none');
        // Yönetim butonlarını gizle
        const btnYonetim = document.getElementById('btnBirimYonetim');
        const btnPerEkle = document.getElementById('btnPersonelEkle');
        if (btnYonetim) btnYonetim.classList.add('d-none');
        if (btnPerEkle) btnPerEkle.classList.add('d-none');

        // approval parametresini forma ekle ki değişince de kalsın
        const form = document.getElementById('filterForm');
        if (form && !form.querySelector('input[name="approval"]')) {
            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = 'approval';
            hidden.value = '1';
            form.appendChild(hidden);
        }
    }

    // Mesai/İzin/Alanı Boşalt davranışı
    const mesaiSelect = document.getElementById('mesaiSelection');
    const izinSelect = document.getElementById('izinSelection');
    const alanBosalt = document.getElementById('alanBosaltSwitch');
    const mesaiNotuSelect = document.getElementById('mesaiNotuSelection');
    const stopModeSwitch = document.getElementById('stopModeSwitch');

    // Alanlar arası ilişki: biri seçilince diğerleri temizlenir
    mesaiSelect.addEventListener('change', function() {
        if (mesaiSelect.value) {
            izinSelect.value = "";
            mesaiNotuSelect.value = "";
            alanBosalt.checked = false;
        }
    });
    izinSelect.addEventListener('change', function() {
        if (izinSelect.value) {
            mesaiSelect.value = "";
            mesaiNotuSelect.value = "";
            alanBosalt.checked = false;
        }
    });
    mesaiNotuSelect.addEventListener('change', function() {
        if (mesaiNotuSelect.value) {
            mesaiSelect.value = "";
            izinSelect.value = "";
            alanBosalt.checked = false;
        }
    });
    alanBosalt.addEventListener('change', function() {
        if (alanBosalt.checked) {
            mesaiSelect.value = "";
            izinSelect.value = "";
            mesaiNotuSelect.value = "";
        }
    });
    // Stoplama modu etkinleştirildiğinde diğer seçimleri temizle
    stopModeSwitch.addEventListener('change', function() {
        if (stopModeSwitch.checked) {
            mesaiSelect.value = "";
            izinSelect.value = "";
            mesaiNotuSelect.value = "";
            alanBosalt.checked = false;
        }
    });

    // Hücreye tıklama: Mesai Notu seçiliyse notu ata, diğerlerinde eski davranış
    document.querySelectorAll('.mesai-cell').forEach(function (cell) {
        cell.addEventListener('click', function (e) {
            if (isApproval) {
                const deg = cell.dataset.degisiklik === '1';
                const mesaiPk = cell.dataset.mesaiPk;
                if (!deg || !mesaiPk) { return; }
                const prev = (cell.dataset.prevSaat && cell.dataset.prevSaat.trim()!=='') ? cell.dataset.prevSaat : (cell.dataset.prevIzin || '');
                const curr = (cell.innerText && cell.innerText.trim()!=='') ? cell.innerText.trim() : '';
                if (window.Swal) {
                    Swal.fire({
                        title: 'Mesai Değişikliği',
                        html: `Önceki: <b>${prev||'-'}</b><br/>Talep edilen: <b>${curr||'-'}</b>`,
                        icon: 'question',
                        showCancelButton: true,
                        showDenyButton: true,
                        confirmButtonText: 'Onayla',
                        denyButtonText: 'Reddet',
                        cancelButtonText: 'Vazgeç'
                    }).then((res)=>{
                        if (res.isConfirmed) {
                            fetch(`{% url 'mercis657:mesai_onayla' 0 %}`.replace('/0/','/'+mesaiPk+'/'), { method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}})
                              .then(r=>r.json()).then(d=>{ if(d.status==='success'){ location.reload(); } else { Swal.fire('Hata', d.message||'İşlem başarısız', 'error'); }})
                              .catch(err=>Swal.fire('Hata', err.toString(),'error'));
                        } else if (res.isDenied) {
                            fetch(`{% url 'mercis657:mesai_reddet' 0 %}`.replace('/0/','/'+mesaiPk+'/'), { method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}})
                              .then(r=>r.json()).then(d=>{ if(d.status==='success'){ location.reload(); } else { Swal.fire('Hata', d.message||'İşlem başarısız', 'error'); }})
                              .catch(err=>Swal.fire('Hata', err.toString(),'error'));
                        }
                    });
                }
                return;
            }

            // Eğer Stoplama modu açıksa, ilgili mesai için stop modalını aç
            if (stopModeSwitch && stopModeSwitch.checked) {
                const mesaiPk = cell.dataset.mesaiPk;
                if (!mesaiPk) {
                    if (window.Swal) Swal.fire('Uyarı', 'Bu hücre için stop eklenemez.', 'warning');
                    else alert('Bu hücre için stop eklenemez.');
                    return;
                }
                // openStopModal fonksiyonu stop_modal.html içinde tanımlı
                if (typeof openStopModal === 'function') {
                    openStopModal(mesaiPk);
                } else {
                    // Fallback: fetch modal HTML endpoint
                    fetch(`/mercis657/stop-ekle/${mesaiPk}/`)
                        .then(r => r.text())
                        .then(html => {
                            const container = document.createElement('div');
                            container.innerHTML = html;
                            document.body.appendChild(container);
                            // execute scripts in fetched modal
                            Array.from(container.querySelectorAll('script')).forEach(oldScript => {
                                const newScript = document.createElement('script');
                                if (oldScript.src) {
                                    newScript.src = oldScript.src; newScript.async = false; document.head.appendChild(newScript);
                                } else {
                                    newScript.text = oldScript.innerHTML; document.body.appendChild(newScript);
                                }
                                oldScript.parentNode.removeChild(oldScript);
                            });
                            const modalEl = container.querySelector('#stopModal');
                            if (modalEl) new bootstrap.Modal(modalEl).show();
                        })
                        .catch(err => { if (window.Swal) Swal.fire('Hata', err.toString(), 'error'); else alert(err); });
                }
                return;
            }
            let mesaiVal = mesaiSelect.value;
            let izinVal = izinSelect.value;
            let bosalt = alanBosalt.checked;
            let notVal = mesaiNotuSelect.value;

            cell.classList.add('modified');

            if (bosalt) {
                cell.querySelector('.mesai-main-value').innerText = "";
                cell.setAttribute('data-mesai-id', "");
                cell.setAttribute('data-izin-id', "");
                cell.setAttribute('data-mesai-notu', "");
                cell.querySelector('.mesai-notu-badge').style.display = "none";
                cell.classList.remove('has-value');
            } else if (notVal) {
                if (notVal === "TEMIZLE") {
                    cell.setAttribute('data-mesai-notu', "");
                    cell.querySelector('.mesai-notu-badge').style.display = "none";
                } else {
                    cell.setAttribute('data-mesai-notu', notVal);
                    cell.querySelector('.mesai-notu-badge').innerText = notVal;
                    cell.querySelector('.mesai-notu-badge').style.display = "";
                }
                // Mesai/İzin verilerini değiştirme!
                cell.classList.add('has-value');
            } else if (mesaiVal) {
                let text = mesaiSelect.options[mesaiSelect.selectedIndex].text;
                cell.querySelector('.mesai-main-value').innerText = text;
                cell.setAttribute('data-mesai-id', mesaiVal.replace('mesai_', ''));
                cell.setAttribute('data-izin-id', "");
                cell.setAttribute('data-mesai-notu', "");
                cell.querySelector('.mesai-notu-badge').style.display = "none";
                cell.classList.add('has-value');
            } else if (izinVal) {
                let text = izinSelect.options[izinSelect.selectedIndex].text;
                cell.querySelector('.mesai-main-value').innerText = text;
                cell.setAttribute('data-izin-id', izinVal.replace('izin_', ''));
                cell.setAttribute('data-mesai-id', "");
                cell.setAttribute('data-mesai-notu', "");
                cell.querySelector('.mesai-notu-badge').style.display = "none";
                cell.classList.add('has-value');
            }
            cell.blur();
        });
    });

    // Yazdır butonu: modal aç
    document.getElementById('btnYazdir').addEventListener('click', function() {
        var aciklama = document.getElementById('yazdirAciklama');
        // aciklama.value = "{{ aciklama|escapejs }}";
        var yazdirModal = new bootstrap.Modal(document.getElementById('yazdirModal'));
        yazdirModal.show();
    });


    // Yazdır modalındaki Yazdır butonu
    document.getElementById('yazdirModalBtn').addEventListener('click', function() {
        const donem = document.getElementById('selectDonem').value;
        const birimId = document.getElementById('selectBirim').value;
        const aciklama = document.getElementById('yazdirAciklama').value;
        if (!donem || !birimId) {
            alert('Lütfen dönem ve birim seçiniz.');
            return;
        }
        // PersonelListesi.aciklama güncelle
        fetch('/mercis657/liste_aciklama_kaydet/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                donem: donem,
                birim_id: birimId,
                aciklama: aciklama
            })
        })
        .then(resp => resp.json())
        .then(data => {
            if (data.status === 'success') {
                // Yazdırma sayfasını aç
                window.open(`/mercis657/cizelge/yazdir/?donem=${donem}&birim_id=${birimId}&aciklama=${encodeURIComponent(aciklama)}`, '_blank');
                bootstrap.Modal.getInstance(document.getElementById('yazdirModal')).hide();
            } else {
                alert(data.message || 'Açıklama kaydedilemedi.');
            }
        })
        .catch(() => alert('Açıklama kaydedilirken bir hata oluştu.'));
    });

    // Tümünü Onayla (approval modu)
    document.getElementById('approveAllButton').addEventListener('click', function() {
        const birimId = document.getElementById('selectBirim').value;
        const donem = document.getElementById('selectDonem').value; // YYYY/MM
        if (!birimId || !donem) return;
        const [year, month] = donem.split('/');
        if (window.Swal) {
            Swal.fire({
                title: 'Tümünü onayla?',
                text: 'Bu dönem için bekleyen tüm değişiklikler onaylanacak.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Evet, onayla',
                cancelButtonText: 'Vazgeç'
            }).then((result)=>{
                if (result.isConfirmed) {
                    fetch(`{% url 'mercis657:toplu_onay' 0 0 0 %}`.replace('/0/0/0/','/'+birimId+'/'+year+'/'+month+'/'),{
                        method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}
                    }).then(r=>r.json()).then(d=>{
                        if (d.status==='success') {
                            Swal.fire('Onaylandı','Tüm bekleyenler onaylandı.','success').then(()=>location.reload());
                        } else {
                            Swal.fire('Hata', d.message||'İşlem başarısız', 'error');
                        }
                    }).catch(e=>Swal.fire('Hata', e.toString(), 'error'));
                }
            });
        }
    });

    // Kaydet butonu (örnek, backend ile uyarlayın)
    // Başlangıç durumunu kaydet (sayfa yüklendiğinde)
    const initialMap = {};
    document.querySelectorAll('.mesai-cell').forEach(cell => {
        const pid = cell.dataset.personelId;
        const date = cell.dataset.date;
        if (!pid || !date) return;
        const key = `${pid}_${date}`;
        const mesaiId = cell.dataset.mesaiId || null;
        const izinId = cell.dataset.izinId || null;
        const mesaiNotu = cell.dataset.mesaiNotu || null;
        initialMap[key] = JSON.stringify({
            mesaiId: mesaiId ? String(mesaiId) : null,
            izinId: izinId ? String(izinId) : null,
            mesaiNotu: mesaiNotu ? String(mesaiNotu) : null
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.getElementById('saveButton').addEventListener('click', function () {
        const saveBtn = document.getElementById('saveButton');
        // Prevent double-clicks: if already disabled, ignore
        if (!saveBtn || saveBtn.disabled) return;

        // Preserve original content to restore later
        if (!saveBtn.dataset.origHtml) saveBtn.dataset.origHtml = saveBtn.innerHTML;
        // Show spinner and set disabled
        saveBtn.disabled = true;
        saveBtn.setAttribute('aria-disabled', 'true');
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Kaydediliyor...';

        const changes = {};
        document.querySelectorAll('.mesai-cell').forEach(cell => {
            const pid = cell.dataset.personelId;
            const date = cell.dataset.date;
            if (!pid || !date) return;
            const key = `${pid}_${date}`;
            const currentMesaiId = cell.dataset.mesaiId || null;
            const currentIzinId = cell.dataset.izinId || null;
            const currentMesaiNotu = cell.dataset.mesaiNotu || null;
            const origData = initialMap[key] ? JSON.parse(initialMap[key]) : {mesaiId: null, izinId: null, mesaiNotu: null};
            const mesaiChanged = currentMesaiId !== origData.mesaiId;
            const izinChanged = currentIzinId !== origData.izinId;
            const notChanged = currentMesaiNotu !== origData.mesaiNotu;
            if (mesaiChanged || izinChanged || notChanged) {
                changes[key] = {
                    mesaiId: currentMesaiId ? Number(currentMesaiId) : null,
                    izinId: currentIzinId ? Number(currentIzinId) : null,
                    mesaiNotu: currentMesaiNotu ? currentMesaiNotu : null
                };
            }
        });

        if (Object.keys(changes).length === 0) {
            if (window.Swal) {
                Swal.fire({ icon: 'info', title: 'Değişiklik yok', text: 'Kaydetmek için değişiklik bulunamadı.' });
            } else {
                alert('Kaydetmek için değişiklik bulunamadı.');
            };
            // Restore button state
            saveBtn.disabled = false;
            saveBtn.setAttribute('aria-disabled', 'false');
            saveBtn.innerHTML = saveBtn.dataset.origHtml || 'Kaydet';
            return;
        }

        const url = "{% url 'mercis657:cizelge_kaydet' %}";
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(changes)
        })
        .then(response => response.json().then(data => ({status: response.status, body: data})))
        .then(({status, body}) => {
            if (body.status === 'success') {
                // Başarılıysa başlangıç durumunu güncelle
                Object.keys(changes).forEach(k => {
                    initialMap[k] = JSON.stringify({
                        mesaiId: changes[k].mesaiId ? String(changes[k].mesaiId) : null,
                        izinId: changes[k].izinId ? String(changes[k].izinId) : null
                    });
                });
                // Modified sınıfını temizle
                document.querySelectorAll('.mesai-cell.modified').forEach(cell => {
                    cell.classList.remove('modified');
                });
                if (window.Swal) {
                    Swal.fire({ 
                        icon: 'success', 
                        title: 'Kaydedildi', 
                        text: 'Çizelge başarıyla kaydedildi.' 
                    }).then(() => {
                        window.location.reload();
                    });
                } else {
                    alert('Çizelge başarıyla kaydedildi.').then(() => {
                        window.location.reload();
                    });
                }
            } else if (body.status === 'partial') {
                const errors = body.errors || [];
                if (window.Swal) {
                    Swal.fire({ icon: 'warning', title: 'Kısmi Başarı', html: errors.join('<br>') });
                } else {
                    alert('Kısmi başarı:\n' + errors.join('\n'));
                }
                // Başarılı olanları yine güncelle (sunucu kısmi hata döndüğünde detay yok; güvenli tarafsız davranış)
                Object.keys(changes).forEach(k => {
                    if (!errors.find(e => e.includes(String(k.split('_')[0])))) {
                        initialMap[k] = changes[k] !== null ? String(changes[k]) : null;
                    }
                });
            } else {
                const msg = body.errors ? body.errors.join('\n') : 'Sunucu hatası.';
                if (window.Swal) {
                    Swal.fire({ icon: 'error', title: 'Hata', text: msg });
                } else {
                    alert('Hata: ' + msg);
                }
            }
        })
        .catch(err => {
            if (window.Swal) {
                Swal.fire({ icon: 'error', title: 'İstek hatası', text: err.toString() });
            } else {
                alert('İstek hatası: ' + err);
            }
        });
    });

    // Personel profil modalını aç
    function openPersonelProfil(personelId, listeId, year, month) {
        fetch(`{% url 'mercis657:personel_profil' 0 0 0 0 %}`.replace('/0/0/0/0/', `/${personelId}/${listeId}/${year}/${month}/`))
            .then(response => response.text())
            .then(html => {
                document.getElementById('personelProfilContainer').innerHTML = html;
                // Execute any inline scripts that came with the fetched HTML so widgets (mesai_atama_widget) initialize
                const container = document.getElementById('personelProfilContainer');
                Array.from(container.querySelectorAll('script')).forEach(oldScript => {
                    const newScript = document.createElement('script');
                    if (oldScript.src) {
                        newScript.src = oldScript.src;
                        newScript.async = false;
                        document.head.appendChild(newScript);
                    } else {
                        newScript.text = oldScript.innerHTML;
                        document.body.appendChild(newScript);
                    }
                    // Remove the old script tag to avoid duplication
                    oldScript.parentNode.removeChild(oldScript);
                });
                const modal = new bootstrap.Modal(document.getElementById('personelProfilModal'));
                modal.show();
            })
            .catch(err => alert('Hata: ' + err));
    }

    // Attach click handlers for person profile buttons (use data-attributes to avoid inline JS errors)
    document.querySelectorAll('.person-profile-btn').forEach(function(btn){
        btn.addEventListener('click', function(){
            const pid = this.dataset.personelId;
            const lid = {{ liste|default:0 }};
            const y = this.dataset.year;
            const m = this.dataset.month;
            if (!pid) return;
            openPersonelProfil(pid, lid, y, m);
        });
    });

    // Toplu işlem modalını aç
    document.getElementById('topluIslemButton').addEventListener('click', function() {
        const birimId = document.getElementById('selectBirim').value;
        const listeId = {{ liste|default:0 }};
        const donem = document.getElementById('selectDonem').value;
        if (!birimId || !donem) {
            alert('Lütfen birim ve dönem seçiniz.');
            return;
        }
        const [year, month] = donem.split('/');
        
        fetch(`{% url 'mercis657:toplu_islem' 0 0 0 %}`.replace('/0/0/0/', `/${listeId}/${year}/${month}/`))
            .then(response => response.text())
            .then(html => {
                const container = document.getElementById('topluIslemContainer');
                container.innerHTML = html;
                // Execute any inline scripts that came with the fetched HTML so functions are available globally
                Array.from(container.querySelectorAll('script')).forEach(oldScript => {
                    const newScript = document.createElement('script');
                    if (oldScript.src) {
                        newScript.src = oldScript.src;
                        newScript.async = false;
                        document.head.appendChild(newScript);
                    } else {
                        newScript.text = oldScript.innerHTML;
                        document.body.appendChild(newScript);
                    }
                    // Remove the old script tag to avoid duplication
                    oldScript.parentNode.removeChild(oldScript);
                });
                const modal = new bootstrap.Modal(document.getElementById('topluIslemModal'));
                modal.show();
            })
            .catch(err => alert('Hata: ' + err));
    });

    // Personel Ekle butonu: modalı aç ve önceki dönem personellerini getir
    document.getElementById('btnPersonelEkle').addEventListener('click', function() {
        let donem = document.getElementById('selectDonem').value;
        const birimId = document.getElementById('selectBirim').value;
        if (!donem || !birimId) {
            alert('Lütfen dönem ve birim seçiniz.');
            return;
        }
        // Dönem formatını "YYYY-MM" yap
        donem = donem.replace('/', '-');
        // Doğrudan parametre olarak gönder (args), kwargs değil!
        fetch(`/mercis657/onceki-donem-personel/${donem}/${birimId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'error') {
                    alert(data.message || 'Veriler alınırken bir hata oluştu');
                    return;
                }
                const personeller = Array.isArray(data) ? data : (data.data || []);
                const tbody = document.querySelector('#oncekiDonemTable tbody');
                tbody.innerHTML = personeller.map(p => `
                    <tr>
                        <td><input type="checkbox" value="${p.personel_id}"></td>
                        <td>${p.tc_kimlik || ''}</td>
                        <td>${p.adi || ''}</td>
                        <td>${p.soyadi || ''}</td>
                        <td>${p.unvan || ''}</td>
                    </tr>
                `).join('');
            })
            .catch(error => {
                console.error('Veri getirme hatası:', error);
                alert('Veriler alınırken bir hata oluştu');
            });
        new bootstrap.Modal(document.getElementById('personelEkleModal')).show();
    });

    // Personel aktarma işlemleri
    document.getElementById('btnPersonelAktar').addEventListener('click', function() {
        const checkedRows = document.querySelectorAll('#oncekiDonemTable tbody input[type="checkbox"]:checked');
        const personelTable = document.getElementById('yeniPersonelTable').querySelector('tbody');

        checkedRows.forEach(checkbox => {
            const row = checkbox.closest('tr');
            // İlk satır boşsa onu doldur, değilse yeni satır ekle
            let firstRow = personelTable.children[0];
            if (firstRow && Array.from(firstRow.cells).every(cell => cell.textContent.trim() === "")) {
                firstRow.innerHTML = `
                    <td>1</td>
                    <td contenteditable="true">${row.cells[1].textContent}</td>
                    <td contenteditable="true">${row.cells[2].textContent}</td>
                    <td contenteditable="true">${row.cells[3].textContent}</td>
                    <td contenteditable="true">${row.cells[4].textContent}</td>
                `;
            } else {
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td>${personelTable.children.length + 1}</td>
                    <td contenteditable="true">${row.cells[1].textContent}</td>
                    <td contenteditable="true">${row.cells[2].textContent}</td>
                    <td contenteditable="true">${row.cells[3].textContent}</td>
                    <td contenteditable="true">${row.cells[4].textContent}</td>
                `;
                personelTable.appendChild(newRow);
            }
        });
    });

    // Personel Arama Select2
    $('#personelAramaSelect').select2({
        theme: 'bootstrap-5',
        placeholder: 'TC Kimlik No veya Ad/Soyad ile arayın...',
        minimumInputLength: 2,
        ajax: {
            url: "{% url 'mutemet_app:personel_ara' %}",
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                    q: params.term // Arama terimi
                };
            },
            processResults: function (data) {
                return {
                    results: data.results
                };
            },
            cache: true
        }
    }).on('select2:select', function (e) {
        var data = e.params.data;
        const donem = document.getElementById('selectDonem').value;
        const birimId = document.getElementById('selectBirim').value;
        if (!donem || !birimId) {
            Swal.fire('Uyarı', 'Lütfen dönem ve birim seçiniz.', 'warning');
            return;
        }
        // Ad ve soyadı ayır
        var ad = '';
        var soyad = '';
        if (data.ad_soyad) {
            var parts = data.ad_soyad.trim().split(' ');
            if (parts.length > 1) {
                soyad = parts.pop();
                ad = parts.join(' ');
            } else {
                ad = data.ad_soyad;
            }
        }
        var unvan = data.unvan || '';
        const csrfToken = getCookie('csrftoken');
        Swal.fire({
            title: 'Personel Ekle',
            text: ad + ' ' + soyad + ' isimli personeli listeye eklemek istiyor musunuz?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Evet, ekle',
            cancelButtonText: 'Vazgeç'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('/mercis657/personel/kaydet/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        donem: donem,
                        birim_id: birimId,
                        personeller: [{
                            PersonelTCKN: data.id,
                            PersonelName: ad,
                            PersonelSurname: soyad,
                            PersonelTitle: unvan
                        }]
                    })
                })
                .then(resp => resp.json())
                .then(data => {
                    if (data.status === 'success') {
                        Swal.fire('Başarılı', 'Personel başarıyla eklendi.', 'success').then(() => location.reload());
                    } else {
                        Swal.fire('Hata', data.message || 'Kayıt sırasında hata oluştu.', 'error');
                    }
                })
                .catch(() => Swal.fire('Hata', 'Kayıt sırasında bir hata oluştu.', 'error'));
            }
            // Seçimi temizle
            $('#personelAramaSelect').val(null).trigger('change');
        });
    });
</script>
<script>
    function olusturIlkListe(listeId) {
      Swal.fire({
        title: "İlk Liste Bildirimi Oluşturulsun mu?",
        text: "Bu işlem yalnızca bir kez yapılabilir.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Evet, oluştur",
        cancelButtonText: "Vazgeç"
      }).then(result => {
        if (result.isConfirmed) {
          fetch(`/mercis657/ilk-liste-olustur/${listeId}/`, {
            method: "POST",
            headers: {"X-CSRFToken": getCookie("csrftoken")}
          })
          .then(r => r.json())
          .then(data => {
            Swal.fire({
              icon: data.status === "success" ? "success" : "error",
              text: data.message
            });
            if (data.status === "success") location.reload();
          });
        }
      });
    }
</script>
<style>
    body, .container-fluid { font-size: 0.95rem; }
    .form-label, label { font-size: 0.95rem; }
    .form-select-sm, .form-control-sm { font-size: 0.95rem; }
    #cizelgeTable .weekend { background-color: #f5d2d2; color: #222; }
    #cizelgeTable .resmi-tatil { background-color: #ffe6cc; color: #222; }
    #cizelgeTable td, #cizelgeTable th { padding: 2px 4px; }
    #cizelgeTable td.mesai-cell:hover { background-color: #bbe9f7; cursor: pointer; }
    #cizelgeTable tbody tr:hover { background-color: #f0f8ff; }
    #cizelgeTable td.mesai-cell.modified { background-color: #b3d9ff !important; }
    /* Green background for system-registered leaves/permissions */
    #cizelgeTable td.sistemdeki-izin { background-color: #aeefb3 !important; }
    .input-group > .form-select, .input-group > .btn { margin-right: 4px; }
    .mesai-notu-badge {
        position: absolute;
        top: 2px;
        right: 4px;
        font-size: 0.75em;
        font-weight: bold;
        background: rgba(180,180,180,0.35);
        color: #000000;
        padding: 1px 5px;
        border-radius: 6px;
        z-index: 1;
        pointer-events: none;
    }
    .mesai-cell {
        position: relative;
    }
    .mesai-main-value {
        display: inline;
    }
    .fm-pos { color: #198754 !important; font-weight: 700; }
    .fm-neg { color: #dc3545 !important; font-weight: 700; }
</style>

<!-- Favori Mesai Modal -->
{% include 'mercis657/partials/favori_mesai_modal.html' %}

{% endblock %}
