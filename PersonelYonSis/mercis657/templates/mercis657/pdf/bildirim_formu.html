{% load static %}
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <title>{{ form_adi|default:"Çalışma Listesi" }}</title>
  <style>
    body { font-family: DejaVu Sans, Arial, Helvetica, sans-serif; font-size: 12px; color: #222; }
    .header { width: 100%; margin-bottom: 8px; padding-bottom: 6px; }
    table.grid { border-collapse: collapse; width: 100%; table-layout: fixed; }
    table.grid th, table.grid td { border: 1px solid #494949; padding: 2px; }
    table.grid th { background: #f3f3f3; height: 20px; }
    table.grid tr.header-row {
      height: 160px;
    }
    .vertical-text {
      width: 25px;
      vertical-align: bottom;
      padding-bottom: 5px;
      text-align: center;
      height: 160px; /* Ensure container has height */
    }
    .vertical-text-inner {
      -webkit-transform: rotate(-90deg); /* specific for wkhtmltopdf */
      -moz-transform: rotate(-90deg);
      -ms-transform: rotate(-90deg);
      -o-transform: rotate(-90deg);
      transform: rotate(-90deg);
      transform-origin: left bottom; /* Pivot point */
      white-space: nowrap;
      display: block;
      width: 10px; /* Width becomes height after rotation */
      height: 20px;
      margin-bottom: 0px; 
      margin-left: -2px; /* Push it to the right */
      text-align: left;
      position: relative;
      bottom: 0px;
      left: 10px;
    }
    .name-cell { text-align: left; font-size: 12px; }
    .weekend { background: #cdcdcd; }
    .holiday { background: #e6d49d; }
    .arife { background: #abd6f7; }
    .small { font-size: 10px; }
    .footer-note { margin-top: 8px; font-size: 10px; color: #666; }
    @media print { .page-break { page-break-after: always; } }
    .mesai-notu-badge {
        /* position: absolute;
        top: 2px;
        right: 4px; */
        font-size: 0.75em;
        font-weight: bold;
        background: rgba(180, 180, 180, 0.1);
        color: #000000;
        padding: 1px 5px;
        border-radius: 6px;
        z-index: 1;
        pointer-events: none;
    }
    .mesai-cell-pdf {
        text-align: center;
        font-size: 10px;
    }
  </style>
</head>
<body>
<!-- Header -->
<div class="header">
{% include "common/pdf_header.html" with kurum=kurum form_adi=form_adi dokuman_kodu=dokuman_kodu yayin_tarihi=yayin_tarihi revizyon_tarihi=revizyon_tarihi revizyon_no=revizyon_no sayfa_no="1 / 1" pdf_logo=pdf_logo %}
</div>

<!-- Birim adı alanı -->
<h2 style="text-align:center; margin-bottom:12px;">Birim: {{ birim_adi|default:"Birim Adı Yok" }}</h2>


{% if not personeller or not days %}
  <p>Bu döneme ait personel veya dönem bilgisi bulunamadı.</p>
{% else %}
  <table class="grid">
    <thead>
      <tr class="header-row" style="text-align:center">
        <th style="width:30px">Sıra</th>
        <th style="width:140px;">Ad Soyad</th>
        <th style="width:90px;">T.C. Kimlik No</th>
        <th style="width:80px;">Unvan</th>
        
        <th class="vertical-text"><div class="vertical-text-inner">Normal F.M.</div></th>
        <th class="vertical-text"><div class="vertical-text-inner">Gece F.M.</div></th>
        <th class="vertical-text"><div class="vertical-text-inner">Bayram F.M.</div></th>
        <th class="vertical-text"><div class="vertical-text-inner">Bayram Gece F.M.</div></th>
        <th class="vertical-text"><div class="vertical-text-inner">Riskli Normal F.M.</div></th>
        <th class="vertical-text"><div class="vertical-text-inner">Riskli Gece F.M.</div></th>
        <th class="vertical-text"><div class="vertical-text-inner">Riskli Bayram F.M.</div></th>
        <th class="vertical-text"><div class="vertical-text-inner">Riskli Bayram Gece F.M.</div></th>
        
        {% for d in days %}
          {% comment %} Determine header class for weekend/holiday {% endcomment %}
          {% with c='' %}
            {% if d.day_num in resmi_tatil_gunleri %}{% with c='holiday' %}{% endwith %}{% endif %}
            {% if d.day_num in arefe_gunleri %}{% with c='arife' %}{% endwith %}{% endif %}
            {% if d.is_weekend %}{% with c='weekend' %}{% endwith %}{% endif %}
          {% endwith %}
          <th class="{{ c }}" style="width:34px;">{{ d.day_num }}</th>
        {% endfor %}
        <th style="width:80px">Sistem Onayı</th>
      </tr>
    </thead>
    <tbody>
      {% for person in personeller %}
        <tr>
          <td style="text-align:center">{{ forloop.counter }}</td>
          <td style="text-align:left; font-weight: bold">{{ person.PersonelName }} {{ person.PersonelSurname }}</td>
          <td style="text-align:left; font-weight: bold; text-align:center">{{ person.PersonelTCKN }}</td>
          <td style="text-align:left; font-weight: bold">{{ person.PersonelTitle|default:'-' }}</td>
          
            <td style="text-align:center">{{ person.normal_fazla_mesai|floatformat:0 }}</td>
            <td style="text-align:center">{{ person.gece_normal_fazla_mesai|floatformat:0 }}</td>
            <td style="text-align:center">{{ person.bayram_fazla_mesai|floatformat:0 }}</td>
            <td style="text-align:center">{{ person.gece_bayram_fazla_mesai|floatformat:0 }}</td>
            <td style="text-align:center">{{ person.riskli_normal|floatformat:0 }}</td>
            <td style="text-align:center">{{ person.gece_riskli_normal|floatformat:0 }}</td>
            <td style="text-align:center">{{ person.riskli_bayram|floatformat:0 }}</td>
            <td style="text-align:center">{{ person.gece_riskli_bayram|floatformat:0 }}</td>
            
          {% comment %} Expect person.mesai_data as list aligned with days; each item can be dict with Saat or IzinAd or empty {% endcomment %}
          {% for md in person.mesai_data %}
            <td class="small mesai-cell-pdf {% if md.is_weekend %}weekend{% endif %} {% if md.is_holiday %}holiday{% endif %} {% if md.is_arife %}arife{% endif %}">
              <span class="mesai-notu-badge" {% if not md.MesaiNotu %}style="display:none"{% endif %}>{{ md.MesaiNotu }}</span>
              <span>
                {% if md.MesaiTanimID or md.Saat or md.IzinAd %}
                  {% if md.IzinAd %}
                    {{ md.IzinAd }}
                  {% else %}
                    {{ md.Saat|default:'' }}
                  {% endif %}
                {% else %}
                  -
                {% endif %}
              </span>
            </td>
          {% endfor %}
          <td>
            {{ person.onay_durumu }}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="footer-note">
    <small>* Sarı: Resmi tatil, Açık mavi: Arefe, Gri: Hafta sonu</small>
  </div>
  
  {% if aciklama %}
    <div style="margin-bottom:8px; font-size:11px; color:#444;">
      <strong>Açıklama:</strong> {{ aciklama|linebreaksbr }}
    </div>
  {% endif %}
{% endif %}

</body>
</html>