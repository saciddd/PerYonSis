<!-- Riskli Bildirim Yönetimi Modal -->
<div class="modal fade" id="riskliBildirimModal" tabindex="-1" aria-labelledby="riskliBildirimModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="riskliBildirimModalLabel">Riskli Çalışma Bildirimleri Yönetimi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Kontrol Butonları -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <button class="btn btn-warning" id="convertAllToRiskyBtn">
                            <i class="bi bi-exclamation-triangle"></i> Tüm Bildirimleri Riskli Hale Çevir
                        </button>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-success" id="saveRiskyChangesBtn">
                            <i class="bi bi-check-circle"></i> Değişiklikleri Kaydet
                        </button>
                    </div>
                </div>

                <!-- Riskli Bildirimler Tablosu -->
                <div class="table-responsive">
                    <table class="table table-sm table-bordered table-hover" id="riskliBildirimTable">
                        <thead class="table-light">
                            <tr>
                                <th>Sıra No</th>
                                <th>Personel</th>
                                <th>Normal</th>
                                <th>Bayram</th>
                                <th>Riskli N.</th>
                                <th>Riskli B.</th>
                                <th>Gece N.</th>
                                <th>Gece B.</th>
                                <th>Riskli Gece N.</th>
                                <th>Riskli Gece B.</th>
                            </tr>
                        </thead>
                        <tbody id="riskliBildirimTableBody">
                            <!-- Veriler JavaScript ile doldurulacak -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let riskliBildirimData = [];
    let originalData = [];

    // Modal açıldığında verileri yükle
    document.getElementById('riskliBildirimModal').addEventListener('show.bs.modal', function() {
        loadRiskliBildirimData();
    });

    // Riskli bildirim verilerini yükle
    function loadRiskliBildirimData() {
        const donem = document.getElementById('selectDonem').value;
        const birimId = document.getElementById('selectBirim').value;
        
        if (!birimId) {
            alert('Lütfen bir birim seçin.');
            return;
        }

        fetch(`/mercis657/bildirimler/${birimId}/riskli-data/?donem=${donem}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    riskliBildirimData = data.bildirimler;
                    originalData = JSON.parse(JSON.stringify(data.bildirimler)); // Deep copy
                    renderRiskliBildirimTable();
                } else {
                    alert('Veri yüklenirken hata oluştu: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Veri yüklenirken hata oluştu.');
            });
    }

    // Riskli bildirim tablosunu render et
    function renderRiskliBildirimTable() {
        const tbody = document.getElementById('riskliBildirimTableBody');
        tbody.innerHTML = '';

        riskliBildirimData.forEach((bildirim, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${bildirim.personel_adi}</td>
                <td>${bildirim.normal_mesai.toFixed(1)}</td>
                <td>${bildirim.bayram_mesai.toFixed(1)}</td>
                <td>
                    <input type="number" class="form-control form-control-sm riskli-input riskli-normal-input" 
                           value="${bildirim.riskli_normal}" min="0" step="0.5"
                           data-type="normal" data-bildirim-id="${bildirim.bildirim_id}">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm riskli-input riskli-bayram-input" 
                           value="${bildirim.riskli_bayram}" min="0" step="0.5"
                           data-type="bayram" data-bildirim-id="${bildirim.bildirim_id}">
                </td>
                <td>${bildirim.gece_normal_mesai.toFixed(1)}</td>
                <td>${bildirim.gece_bayram_mesai.toFixed(1)}</td>
                <td>
                    <input type="number" class="form-control form-control-sm riskli-input riskli-gece-normal-input" 
                           value="${bildirim.gece_riskli_normal}" min="0" step="0.5"
                           data-type="gece-normal" data-bildirim-id="${bildirim.bildirim_id}">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm riskli-input riskli-gece-bayram-input" 
                           value="${bildirim.gece_riskli_bayram}" min="0" step="0.5"
                           data-type="gece-bayram" data-bildirim-id="${bildirim.bildirim_id}">
                </td>
            `;
            tbody.appendChild(row);
        });

        // Input event listener'ları ekle
        addInputEventListeners();
    }

    // Input event listener'larını ekle
    function addInputEventListeners() {
        document.querySelectorAll('.riskli-input').forEach(input => {
            input.addEventListener('input', function() {
                updateValues(this);
            });
        });
    }

    // Değerleri güncelle (Generic Function)
    function updateValues(input) {
        const bildirimId = input.dataset.bildirimId;
        const type = input.dataset.type; // normal, bayram, gece-normal, gece-bayram
        const riskliValue = parseFloat(input.value) || 0;
        
        const bildirim = riskliBildirimData.find(b => b.bildirim_id == bildirimId);
        // Orijinal veriden toplam kapasiteyi bul (Riskli + Normal = Orijinal Total)
        // Burada basitlik için: Current Value + Current Other Part = Total Constant?
        // Hayır, orijinal total veri yüklenirken originalData'da saklanabilir veya anlık hesaplanabilir.
        // Ancak en basiti: "Kalan Normal = Toplam Orijinal - Yeni Riskli"
        // Bu yapı için originalData'dan referans almalıyız.
        
        const original = originalData.find(b => b.bildirim_id == bildirimId);
        
        if (!bildirim || !original) return;
        
        let maxVal = 0;
        if (type === 'normal') maxVal = original.normal_mesai + original.riskli_normal;
        else if (type === 'bayram') maxVal = original.bayram_mesai + original.riskli_bayram;
        else if (type === 'gece-normal') maxVal = original.gece_normal_mesai + original.gece_riskli_normal;
        else if (type === 'gece-bayram') maxVal = original.gece_bayram_mesai + original.gece_riskli_bayram;
        
        if (riskliValue > maxVal) {
             input.value = maxVal; // Clamp
             // Recurse/Update with clamped value
             // But simple return here as value changed and event might re-trigger if we manually set value? No.
             // Just proceed with clamped value
             // Actually input.value assignment doesn't retrigger 'input' event usually.
             // Let's rely on logic flow.
        }
        
        const validRiskli = Math.min(Math.max(0, parseFloat(input.value) || 0), maxVal);
        const remaining = maxVal - validRiskli;
        
        // Update Data Model
        if (type === 'normal') {
            bildirim.riskli_normal = validRiskli;
            bildirim.normal_mesai = remaining;
        } else if (type === 'bayram') {
            bildirim.riskli_bayram = validRiskli;
            bildirim.bayram_mesai = remaining;
        } else if (type === 'gece-normal') {
            bildirim.gece_riskli_normal = validRiskli;
            bildirim.gece_normal_mesai = remaining;
        } else if (type === 'gece-bayram') {
            bildirim.gece_riskli_bayram = validRiskli;
            bildirim.gece_bayram_mesai = remaining;
        }
        
        // Update UI (Text Cells)
        const row = input.closest('tr');
        if (type === 'normal') row.children[2].textContent = bildirim.normal_mesai.toFixed(1);
        else if (type === 'bayram') row.children[3].textContent = bildirim.bayram_mesai.toFixed(1);
        else if (type === 'gece-normal') row.children[6].textContent = bildirim.gece_normal_mesai.toFixed(1);
        else if (type === 'gece-bayram') row.children[7].textContent = bildirim.gece_bayram_mesai.toFixed(1);
    }

    // Tüm bildirimleri riskli hale çevir
    document.getElementById('convertAllToRiskyBtn').addEventListener('click', function() {
        if (confirm('Tüm bildirimleri riskli hale çevirmek istediğinizden emin misiniz?')) {
            riskliBildirimData.forEach(bildirim => {
                // Normal -> Riskli
                bildirim.riskli_normal = bildirim.riskli_normal + bildirim.normal_mesai;
                bildirim.normal_mesai = 0;
                
                bildirim.riskli_bayram = bildirim.riskli_bayram + bildirim.bayram_mesai;
                bildirim.bayram_mesai = 0;
                
                // Gece -> Riskli
                bildirim.gece_riskli_normal = bildirim.gece_riskli_normal + bildirim.gece_normal_mesai;
                bildirim.gece_normal_mesai = 0;
                
                bildirim.gece_riskli_bayram = bildirim.gece_riskli_bayram + bildirim.gece_bayram_mesai;
                bildirim.gece_bayram_mesai = 0;
            });
            renderRiskliBildirimTable();
        }
    });

    // Değişiklikleri kaydet
    document.getElementById('saveRiskyChangesBtn').addEventListener('click', function() {
        const donem = document.getElementById('selectDonem').value;
        const birimId = document.getElementById('selectBirim').value;

        const changes = riskliBildirimData.map(bildirim => ({
            bildirim_id: bildirim.bildirim_id,
            riskli_normal: bildirim.riskli_normal,
            riskli_bayram: bildirim.riskli_bayram,
            normal_mesai: bildirim.normal_mesai,
            bayram_mesai: bildirim.bayram_mesai,
            // Gece 
            gece_riskli_normal: bildirim.gece_riskli_normal,
            gece_riskli_bayram: bildirim.gece_riskli_bayram,
            gece_normal_mesai: bildirim.gece_normal_mesai,
            gece_bayram_mesai: bildirim.gece_bayram_mesai
        }));

        // CSRF token'ı al
        const csrfToken = '{{ csrf_token }}';

        fetch(`/mercis657/bildirimler/${birimId}/update-risky/?donem=${donem}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ changes: changes })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const updatedCount = Array.isArray(data.not_updated) ? Math.max(0, changes.length - data.not_updated.length) : changes.length;
                let html = `<p>${updatedCount} bildirim başarıyla güncellendi.</p>`;
                if (data.not_updated && data.not_updated.length) {
                    html += '<p><strong>Güncellenemeyen bildirimler:</strong></p><ul>' + data.not_updated.map(i => `<li>${i}</li>`).join('') + '</ul>';
                }

                // show SweetAlert summary and reload on confirm
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        title: 'Güncelleme Özeti',
                        html: html,
                        icon: 'success',
                        confirmButtonText: 'Tamam'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.reload();
                        }
                    });
                } else {
                    // fallback
                    alert((updatedCount) + ' bildirim başarıyla güncellendi.\n' + (data.not_updated ? 'Güncellenemeyenler: ' + data.not_updated.join(', ') : ''));
                    window.location.reload();
                }
            } else {
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        title: 'Hata',
                        text: 'Kaydetme sırasında hata oluştu: ' + data.message,
                        icon: 'error',
                        confirmButtonText: 'Tamam'
                    });
                } else {
                    alert('Kaydetme sırasında hata oluştu: ' + data.message);
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Kaydetme sırasında hata oluştu.');
        });
    });
});
</script>
