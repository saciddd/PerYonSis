<div class="modal fade" id="stopModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title">
          <i class="bi bi-pause-circle me-2"></i> Stop Kaydı Ekle
          <br>
          {% if mesai and mesai.Personel %}
            <small class="text-muted ms-2">{{ mesai.Personel.PersonelName }} {{ mesai.Personel.PersonelSurname }} - {{ mesai.MesaiDate}} ({{ mesai.MesaiTanim.Saat|default:mesai.MesaiTanim.Saat }})</small>
          {% endif %}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="stopModalBody">
        {% comment %} If there are existing stops for this mesai, list them with delete buttons. Otherwise show the create form. {% endcomment %}
        {% with stops=mesai.mercis657_stoplar.all %}
          {% if stops and stops.count %}
            <div class="list-group mb-3" id="stopList">
              {% for s in stops %}
                <div class="list-group-item d-flex justify-content-between align-items-start align-items-center">
                  <div>
                    <div><strong>{{ s.StopBaslangic }} - {{ s.StopBitis }}</strong> ({{ s.Aciklama }})</div>
                    <div class="small text-muted">Süre: {{ s.Sure }} saat | Oluşturan: {{ s.created_by }}</div>
                  </div>
                  <div>
                    <button class="btn btn-sm btn-danger btn-stop-delete" data-stop-id="{{ s.id }}">
                      <i class="bi bi-trash"></i> Sil
                    </button>
                  </div>
                </div>
              {% endfor %}
            </div>
            <div class="text-end">
              <button class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
          {% else %}
            <form id="stopForm" method="post" action="{% url 'mercis657:stop_ekle' mesai.MesaiID %}">
              {% csrf_token %}
              <div class="mb-3">
                <label class="form-label">Stop Başlangıç</label>
                <input type="time" name="StopBaslangic" class="form-control" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Stop Bitiş</label>
                <input type="time" name="StopBitis" class="form-control" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Açıklama</label>
                <input type="text" name="StopAciklama" class="form-control">
              </div>
              <div class="alert alert-info d-none" id="stopSureAlert"></div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-success">
                  <i class="bi bi-save"></i> Kaydet
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
              </div>
            </form>
          {% endif %}
        {% endwith %}
      </div>
    </div>
  </div>
</div>

<script>
// helper to get csrftoken
function getCookieLocal(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// Attach submit handler if form exists (create form)
document.addEventListener('submit', function(ev){
  if (ev.target && ev.target.id === 'stopForm') {
    ev.preventDefault();
    const form = ev.target;
    fetch(form.action, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCookieLocal('csrftoken') },
      body: new FormData(form)
    })
    .then(r => r.json())
    .then(data => {
      if (data.status === 'success') {
        const alertEl = document.getElementById('stopSureAlert');
        if (alertEl) {
          alertEl.classList.remove('d-none');
          alertEl.innerText = 'Kaydedildi. Stop süresi: ' + data.sure + ' saat.';
        }
        // Optionally refresh modal contents by re-fetching endpoint
        // Close modal after short delay
        setTimeout(()=>{ location.reload(); }, 1000);
      } else {
        alert(data.message || 'Kaydetme hatası');
      }
    }).catch(err=>{
      alert('İstek hatası: ' + err);
    });
  }
});

// Delete handler for stop items
document.addEventListener('click', function(ev){
  if (ev.target && (ev.target.classList.contains('btn-stop-delete') || ev.target.closest('.btn-stop-delete'))) {
    const btn = ev.target.closest('.btn-stop-delete');
    const stopId = btn.dataset.stopId;
    if (!stopId) return;
    if (!confirm('Stop kaydını silmek istediğinizden emin misiniz?')) return;
    fetch(`/mercis657/stop-sil/${stopId}/`, {
      method: 'POST', headers: { 'X-CSRFToken': getCookieLocal('csrftoken') }
    }).then(r=>r.json()).then(data=>{
      if (data.status === 'deleted') {
        // remove item from list
        btn.closest('.list-group-item').remove();
      } else {
        alert(data.message || 'Silme başarısız');
      }
    }).catch(err=>alert(err));
  }
});
</script>