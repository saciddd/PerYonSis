{% extends 'base.html' %}
{% load static %}

{% block title %}İcra Takibi{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card card-primary card-outline">
        <div class="card-header">
            <h3 class="card-title">Yeni İcra Takibi Ekle</h3>
        </div>
        <div class="card-body">
            <form class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="personel_select" class="form-label">T.C. Kimlik No</label>
                    <select id="personel_select" class="form-control" required></select>
                </div>
                <div class="col-md-3">
                    <label for="ad_soyad" class="form-label">Ad Soyad</label>
                    <input type="text" id="ad_soyad" class="form-control" readonly>
                </div>
                <div class="col-md-3">
                    <label for="unvan" class="form-label">Unvan</label>
                    <input type="text" id="unvan" class="form-control" readonly>
                </div>
                <div class="col-md-3">
                    <button type="button" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#icraModal" id="btnIcraEkle" disabled>
                        İcra Takibi Ekle
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-header">
            <h3 class="card-title">İcra Takipleri</h3>
        </div>
        <div class="card-body">
            {% if personel_icra_data %}
            {% for personel, data_dict in personel_icra_data.items %}
            <div class="card mb-2">
                <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                    <a data-bs-toggle="collapse" href="#icra-{{ personel.id }}" role="button" aria-expanded="false" aria-controls="icra-{{ personel.id }}" class="text-decoration-none text-dark fw-bold">
                        {{ personel.ad_soyad }} ({{ personel.tc_kimlik_no }})
                    </a>
                    <div class="text-end">
                        {% with ek_bilgiler=data_dict.ek_bilgiler %}
                            {% if ek_bilgiler.kalan_borc_aktif is not None %}
                            <span class="badge bg-danger me-1 rounded-pill">Aktif Kalan: {{ ek_bilgiler.kalan_borc_aktif|floatformat:2 }} TL</span>
                            {% endif %}
                            {% if ek_bilgiler.en_son_kesinti_donemi %}
                            <span class="badge bg-info me-1 rounded-pill">Son Kesinti: {{ ek_bilgiler.en_son_kesinti_donemi|date:"N Y" }}</span>
                            {% endif %}
                            {% if ek_bilgiler.siradaki_icra_sayisi > 0 %}
                            <span class="badge bg-warning text-dark rounded-pill">Sırada: {{ ek_bilgiler.siradaki_icra_sayisi }}</span>
                            {% endif %}
                        {% endwith %}
                    </div>
                </div>
                <div class="collapse" id="icra-{{ personel.id }}">
                    <div class="card-body p-2">
                        <table class="table table-bordered table-sm table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>İcra Dairesi</th>
                                    <th>Dosya No</th>
                                    <th>Tutar</th>
                                    <th>Toplam Kesinti</th>
                                    <th>Kalan Borç</th>
                                    <th>Durum</th>
                                    <th>İşlem</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for icra in data_dict.icralar %}
                                <tr>
                                    <td>{{ icra.icra_dairesi }}</td>
                                    <td>{{ icra.dosya_no }}</td>
                                    <td>{{ icra.tutar|floatformat:2 }} TL</td>
                                    <td>{{ icra.hesaplanan_toplam_kesinti|floatformat:2 }} TL</td>
                                    <td>{{ icra.hesaplanan_kalan_borc|floatformat:2 }} TL</td>
                                    <td>
                                        {% if icra.durum == 'AKTIF' %}
                                            <span class="badge bg-success">Aktif</span>
                                        {% elif icra.durum == 'SIRADA' %}
                                            <span class="badge bg-warning text-dark">Sırada</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Kapandı</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if icra.durum == 'AKTIF' %} {# Sadece AKTIF olanlar için detay görülebilir #}
                                            <button class="btn btn-primary btn-sm btn-icra-detay" data-icra-id="{{ icra.pk }}">Detay</button>
                                        {% else %}
                                            <button class="btn btn-secondary btn-sm" disabled>Detay</button> {# SIRADA ve KAPANDI için pasif #}
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="alert alert-info">Kayıtlı icra takibi bulunamadı.</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal for Adding Icra Takibi -->
<div class="modal fade" id="icraModal" tabindex="-1" aria-labelledby="icraModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" action="{% url 'mutemet_app:icra_takibi_ekle' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="icraModalLabel">Yeni İcra Takibi Ekle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="modal_personel_id" name="personel_id">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="icra_vergi_dairesi_no" class="form-label">Vergi Dairesi No</label>
                            <input type="text" id="icra_vergi_dairesi_no" name="icra_vergi_dairesi_no" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label for="icra_dairesi" class="form-label">İcra Dairesi</label>
                            <input type="text" id="icra_dairesi" name="icra_dairesi" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label for="dosya_no" class="form-label">Dosya No</label>
                            <input type="text" id="dosya_no" name="dosya_no" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label for="tutar" class="form-label">Tutar</label>
                            <input type="number" id="tutar" name="tutar" class="form-control" step="0.01" required>
                        </div>
                        <div class="col-md-6">
                            <label for="alacakli" class="form-label">Alacaklı</label>
                            <input type="text" id="alacakli" name="alacakli" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label for="alacakli_vekili" class="form-label">Alacaklı Vekili</label>
                            <input type="text" id="alacakli_vekili" name="alacakli_vekili" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label for="tarihi" class="form-label">Tarih</label>
                            <input type="date" id="tarihi" name="tarihi" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label for="icra_dairesi_banka" class="form-label">Banka</label>
                            <input type="text" id="icra_dairesi_banka" name="icra_dairesi_banka" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label for="icra_dairesi_hesap_no" class="form-label">Hesap No</label>
                            <input type="text" id="icra_dairesi_hesap_no" name="icra_dairesi_hesap_no" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- İcra Hareketleri Modal -->
<div class="modal fade" id="icraHareketModal" tabindex="-1" aria-labelledby="icraHareketModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content" id="icraHareketModalContent">
            <!-- İçerik AJAX ile yüklenecek -->
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Yükleniyor...</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script>
$(document).ready(function() {
    // Select2 ile personel arama
    $('#personel_select').select2({
        theme: 'bootstrap4',
        placeholder: 'TC Kimlik No veya Ad/Soyad ile arayın...',
        minimumInputLength: 2,
        ajax: {
            url: "{% url 'mutemet_app:personel_ara' %}",
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return { q: params.term };
            },
            processResults: function (data) {
                return { results: data.results };
            },
            cache: true
        }
    }).on('select2:select', function (e) {
        var data = e.params.data;
        $('#ad_soyad').val(data.ad_soyad);
        $('#unvan').val(data.unvan);
        $('#modal_personel_id').val(data.id);
        $('#btnIcraEkle').prop('disabled', false);
    });
    
    // DataTables başlatma kodunu kaldırdık çünkü genel bir tablo yok.
    // Gerekirse, her bir personel kartındaki tabloya ayrı ayrı uygulanabilir.

    // Detay butonuna tıklanınca modalı aç ve AJAX ile içeriği yükle
    // Event delegation kullanarak dinamik olarak eklenen butonlar için de çalışmasını sağlıyoruz.
    $(document).on('click', '.btn-icra-detay', function() {
        var icraId = $(this).data('icra-id');
        var modal = $('#icraHareketModal');
        var modalContent = $('#icraHareketModalContent');

        modalContent.html('<div class="modal-body text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Yükleniyor...</span></div></div>');
        modal.modal('show');
        
        var url = "{% url 'mutemet_app:icra_hareketleri_list' 0 %}".replace('0', icraId);
        $.get(url, function(data) {
            modalContent.html(data);
        }).fail(function() {
            modalContent.html('<div class="modal-body text-center text-danger">İçerik yüklenirken bir hata oluştu.</div>');
        });
    });

    // Modal submit işlemi için (delegated event)
    $(document).on('submit', '#icraHareketForm', function(e) {
        e.preventDefault();
        var form = $(this);
        var kalan_borc_str = form.find('input[name="kalan_borc"]').val(); // Bu alan _icra_hareket_modal_content.html'de olmalı
        var kesilen_tutar_str = form.find('input[name="kesilen_tutar"]').val();

        // Kalan borç ve kesilen tutar değerlerinin varlığını ve formatını kontrol et
        if (kalan_borc_str === undefined || kesilen_tutar_str === undefined) {
            alert('Formda eksik alanlar var (kalan_borc veya kesilen_tutar). Lütfen _icra_hareket_modal_content.html dosyasını kontrol edin.');
            return false;
        }
        
        var kalan_borc = parseFloat(kalan_borc_str.replace(',', '.')); // Virgülü noktaya çevir
        var kesilen_tutar = parseFloat(kesilen_tutar_str.replace(',', '.')); // Virgülü noktaya çevir

        if (isNaN(kalan_borc) || isNaN(kesilen_tutar)) {
            alert('Kalan borç veya kesilen tutar geçerli bir sayı değil.');
            return false;
        }

        if (kesilen_tutar > kalan_borc) {
            alert('Kesilen tutar kalan borçtan fazla olamaz!');
            return false;
        }
        $.ajax({
            url: form.attr('action'),
            method: 'POST',
            data: form.serialize(),
            success: function(response) {
                if(response.success) {
                    var icraId = form.find('input[name="icra_id"]').val();
                    // Modalı tekrar yükle
                    var url = "{% url 'mutemet_app:icra_hareketleri_list' 0 %}".replace('0', icraId);
                    $.get(url, function(data) {
                        $('#icraHareketModalContent').html(data);
                        // Ana sayfadaki ilgili personelin bilgilerini de güncellemek gerekebilir (opsiyonel)
                        // Bu daha karmaşık bir işlem olacağı için şimdilik sadece modal güncelleniyor.
                    });
                } else {
                    alert('Hata: ' + response.message);
                }
            },
            error: function() {
                alert('Bir hata oluştu. Lütfen tekrar deneyin.');
            }
        });
    });
});
</script>
{% endblock %}
