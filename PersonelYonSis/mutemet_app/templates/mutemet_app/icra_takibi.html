{% extends 'base.html' %}
{% load static %}

{% block title %}İcra Takibi{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@x.x.x/dist/select2-bootstrap4.min.css">
<style>
    .accordion-button:not(.collapsed) {
        background-color: #e7f1ff;
    }
    .accordion-button:focus {
        box-shadow: none;
        border-color: rgba(0,0,0,.125);
    }
    .btn-icon {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    .modal-xl {
        max-width: 90%;
    }
    .table-responsive {
        max-height: 400px;
        overflow-y: auto;
    }
    .select2-container .select2-selection--single {
        height: calc(1.5em + .75rem + 2px);
        padding: .375rem .75rem;
        border: 1px solid #ced4da;
    }
    .select2-container--bootstrap4 .select2-selection--single .select2-selection__rendered {
        line-height: 1.5;
    }
    .select2-container--bootstrap4 .select2-selection--single .select2-selection__arrow {
        height: calc(1.5em + .75rem);
    }
    #odeme_turu.select2-hidden-accessible + .select2-container {
        z-index: 1600 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card card-primary card-outline">
        <div class="card-header">
            <h3 class="card-title">Yeni İcra Takibi Ekle</h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-9">
                    <form class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label for="personel_select" class="form-label">T.C. Kimlik No</label>
                            <select id="personel_select" class="form-control" required></select>
                        </div>
                        <div class="col-md-3">
                            <label for="ad_soyad" class="form-label">Ad Soyad</label>
                            <input type="text" id="ad_soyad" class="form-control" readonly>
                        </div>
                        <div class="col-md-3">
                            <label for="unvan" class="form-label">Unvan</label>
                            <input type="text" id="unvan" class="form-control" readonly>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#icraModal" id="btnIcraEkle" disabled>
                                İcra Takibi Ekle
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-header">
            <h3 class="card-title">İcra Takipleri</h3>
            <div class="card-tools">
                <form method="get" class="d-inline-block ms-2">
                    <select name="teskilat" class="form-select form-select-sm d-inline-block w-auto me-2" onchange="this.form.submit()">
                        <option value="" {% if not selected_teskilat %}selected{% endif %}>Tüm Teşkilatlar</option>
                        {% for t_val, t_disp in teskilat_choices %}
                            <option value="{{ t_val }}" {% if selected_teskilat == t_val %}selected{% endif %}>
                                {{ t_disp }}
                            </option>
                        {% endfor %}
                    </select>
                </form>
                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#raporlamaModal">
                    <i class="bi bi-file-earmark-text"></i> Raporlama
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="accordion" id="icraAccordion">
                {% for personel, data in personel_icra_data.items %}
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ personel.id }}">
                            {{ personel.ad_soyad }} ({{ personel.tc_kimlik_no }})
                            {% if data.ek_bilgiler.kalan_borc_aktif is not None %}
                            <span class="badge bg-danger me-1">Aktif Kalan: {{ data.ek_bilgiler.kalan_borc_aktif|floatformat:2 }} TL</span>
                            {% endif %}
                            {% if data.ek_bilgiler.en_son_kesinti_donemi %}
                            <span class="badge bg-secondary">Son Kesinti: {{ data.ek_bilgiler.en_son_kesinti_donemi|date:"N Y" }}</span>
                            {% endif %}
                            {% if data.ek_bilgiler.siradaki_icra_sayisi > 0 %}
                            <span class="badge bg-warning ms-2">{{ data.ek_bilgiler.siradaki_icra_sayisi }} Sırada</span>
                            {% endif %}
                        </button>
                    </h2>
                    <div id="collapse{{ personel.id }}" class="accordion-collapse collapse" data-bs-parent="#icraAccordion">
                        <div class="accordion-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-striped">
                                    <thead>
                                        <tr>
                                            <th>İcra Dairesi</th>
                                            <th>Dosya No</th>
                                            <th>Tarih</th>
                                            <th>Tutar</th>
                                            <th>Durum</th>
                                            <th>Toplam Kesinti</th>
                                            <th>Kalan Borç</th>
                                            <th>İşlemler</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for icra in data.icralar %}
                                        <tr>
                                            <td>{{ icra.icra_dairesi }}</td>
                                            <td>{{ icra.dosya_no }}</td>
                                            <td>{{ icra.tarihi|date:"d.m.Y" }}</td>
                                            <td>{{ icra.tutar|floatformat:2 }}</td>
                                            <td>
                                                {% if icra.durum == 'AKTIF' %}
                                                <span class="badge bg-success">Aktif</span>
                                                {% elif icra.durum == 'SIRADA' %}
                                                <span class="badge bg-warning">Sırada</span>
                                                {% elif icra.durum == 'KAPANDI' %}
                                                <span class="badge bg-danger">Kapandı</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ icra.hesaplanan_toplam_kesinti|floatformat:2 }}</td>
                                            <td>{{ icra.hesaplanan_kalan_borc|floatformat:2 }}</td>
                                            <td>
                                                <button type="button" class="btn btn-primary btn-sm btn-icon" data-icra-id="{{ icra.pk }}" onclick="hareketGoster(this)" {% if icra.durum == 'SIRADA' %}disabled{% endif %}>
                                                    <i class="bi bi-clock-history"></i> İşlemler
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- İcra Ekleme Modal -->
<div class="modal fade" id="icraModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" action="{% url 'mutemet_app:icra_takibi_ekle' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Yeni İcra Takibi Ekle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="modal_personel_id" name="personel_id">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="icra_vergi_dairesi_no" class="form-label">Vergi Dairesi No</label>
                            <input type="text" id="icra_vergi_dairesi_no" name="icra_vergi_dairesi_no" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label for="icra_dairesi" class="form-label">İcra Dairesi</label>
                            <input type="text" id="icra_dairesi" name="icra_dairesi" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label for="dosya_no" class="form-label">Dosya No</label>
                            <input type="text" id="dosya_no" name="dosya_no" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label for="tutar" class="form-label">Tutar</label>
                            <input type="number" id="tutar" name="tutar" class="form-control" step="0.01" required>
                        </div>
                        <div class="col-md-6">
                            <label for="alacakli" class="form-label">Alacaklı</label>
                            <input type="text" id="alacakli" name="alacakli" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label for="alacakli_vekili" class="form-label">Alacaklı Vekili</label>
                            <input type="text" id="alacakli_vekili" name="alacakli_vekili" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label for="tarihi" class="form-label">Tarih</label>
                            <input type="date" id="tarihi" name="tarihi" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label for="icra_dairesi_banka" class="form-label">Banka</label>
                            <input type="text" id="icra_dairesi_banka" name="icra_dairesi_banka" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label for="icra_dairesi_hesap_no" class="form-label">Hesap No</label>
                            <input type="text" id="icra_dairesi_hesap_no" name="icra_dairesi_hesap_no" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label for="icra_turu" class="form-label">İcra Türü</label>
                            <select id="icra_turu" name="icra_turu" class="form-select">
                                <option value="ICRA">İcra</option>
                                <option value="TAAHHUT">Taahhüt</option>
                                <option value="NAFAKA">Nafaka</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Raporlama Modal -->
<div class="modal fade" id="raporlamaModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">İcra Kesinti Raporu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="raporlamaForm" method="get" action="{% url 'mutemet_app:aylik_icra_kesinti' %}">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Kesildiği Dönem</label>
                            <select id="donem" name="donem" class="form-select" required>
                                {% for donem in donem_secenekleri %}
                                <option value="{{ donem|date:'Y-m-d' }}">{{ donem|date:"F Y" }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <!-- <div class="col-md-4">
                            <label for="odeme_turu" class="form-label">Ödeme Türü</label>
                            <select id="odeme_turu" name="odeme_turu" class="form-select select2" multiple>
                                <option value="DENGE">Denge</option>
                                <option value="DENGE FARK">Denge Fark</option>
                                <option value="EK ÖDEME">Ek Ödeme</option>
                                <option value="ELDEN">Elden</option>
                                <option value="İKRAMİYE">İkramiye</option>
                                <option value="MAAŞ">Maaş</option>
                                <option value="NAFAKA">Nafaka</option>
                                <option value="SABİT">Sabit</option>
                                <option value="SABİT FARK">Sabit Fark</option>
                                <option value="TEMEL">Temel</option>
                                <option value="TEŞVİK">Teşvik</option>
                                <option value="TOPLU GİRİŞ">Toplu Giriş</option>
                            </select>
                        </div> -->
                        <div class="col-md-4">
                            <label class="form-label">Teşkilat</label>
                            <select id="teskilat" name="teskilat" class="form-select">
                                <option value="">Tümü</option>
                                {% for t_val, t_disp in teskilat_choices %}
                                <option value="{{ t_val }}">{{ t_disp }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <button type="button" class="btn btn-secondary btn-sm" id="tumunuSec">
                                <i class="bi bi-check-all"></i> Tümünü Seç
                            </button>
                            <button type="submit" class="btn btn-primary btn-sm float-end" id="raporOlustur">
                                <i class="bi bi-file-earmark-pdf"></i> Rapor Oluştur
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped" id="raporlamaTable">
                            <thead>
                                <tr>
                                    <th width="30">
                                        <input type="checkbox" class="form-check-input" id="tumunuSecCheckbox">
                                    </th>
                                    <th>Ad Soyad</th>
                                    <th>İcra Türü</th>
                                    <th>Kesildiği Dönem</th>
                                    <th>Kesilen Tutar</th>
                                    <th>Ödeme Türü</th>
                                    <th>Teşkilat</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- AJAX ile doldurulacak -->
                            </tbody>
                        </table>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- İcra Hareketleri Modal -->
<div class="modal fade" id="icraHareketModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <!-- AJAX ile doldurulacak -->
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
function hareketGoster(buttonElement) {
    const icraId = buttonElement.dataset.icraId;
    if (!icraId) {
        Swal.fire('Hata!', 'İcra ID bulunamadı.', 'error');
        return;
    }
    $.ajax({
        url: `/mutemet/icra-takibi/${icraId}/hareketler/`,
        type: 'GET',
        success: function(response) {
            $('#icraHareketModal .modal-content').html(response);
            $('#icraHareketModal').modal('show');
        },
        error: function() {
            Swal.fire('Hata!', 'Hareketler yüklenirken bir hata oluştu.', 'error');
        }
    });
}

function hareketEkle(icraId) {
    if (!icraId) {
        Swal.fire('Hata!', 'İcra ID bulunamadı.', 'error');
        return;
    }
    $.ajax({
        url: `/mutemet/icra-takibi/${icraId}/modal/`,
        type: 'GET',
        success: function(response) {
            $('#icraHareketEkleModal .modal-content').html(response);
            $('#icraHareketEkleModal').modal('show');
        },
        error: function() {
            Swal.fire('Hata!', 'Hareket ekleme formu yüklenirken bir hata oluştu.', 'error');
        }
    });
}

// İcra hareket ekleme formu submit edildiğinde
$(document).on('submit', '#icraHareketForm', function(e) {
    e.preventDefault();
    const form = $(this);
    const icraId = form.find('input[name="icra_id"]').val();
    
    $.ajax({
        url: `/mutemet/icra-takibi/${icraId}/hareket-ekle/`,
        type: 'POST',
        data: form.serialize(),
        success: function(response) {
            if (response.success) {
                $('#icraHareketEkleModal').modal('hide');
                Swal.fire({
                    title: 'Başarılı!',
                    text: 'İcra hareketi başarıyla eklendi.',
                    icon: 'success'
                }).then(() => {
                    window.location.href = "{% url 'mutemet_app:icra_takibi' %}";
                });
            } else {
                Swal.fire('Hata!', response.message || 'Hareket eklenirken bir hata oluştu.', 'error');
            }
        },
        error: function() {
            Swal.fire('Hata!', 'Hareket eklenirken bir hata oluştu.', 'error');
        }
    });
});

$(document).ready(function() {
    // Personel Arama Select2
    $('#personel_select').select2({
        theme: 'bootstrap4',
        placeholder: 'TC Kimlik No veya Ad/Soyad ile arayın...',
        minimumInputLength: 2,
        ajax: {
            url: "{% url 'mutemet_app:personel_ara' %}",
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                    q: params.term
                };
            },
            processResults: function (data) {
                return {
                    results: data.results
                };
            },
            cache: true
        }
    }).on('select2:select', function (e) {
        var data = e.params.data;
        $('#ad_soyad').val(data.ad_soyad);
        $('#unvan').val(data.unvan);
        $('#modal_personel_id').val(data.id);
        $('#btnIcraEkle').prop('disabled', false);
    });

    // İcra Ekleme Modalı açıldığında formu sıfırla
    $('#icraModal').on('show.bs.modal', function () {
        $('#icra_vergi_dairesi_no').val('');
        $('#icra_dairesi').val('');
        $('#dosya_no').val('');
        $('#tutar').val('');
        $('#alacakli').val('');
        $('#alacakli_vekili').val('');
        $('#tarihi').val('');
        $('#icra_dairesi_banka').val('');
        $('#icra_dairesi_hesap_no').val('');
        $('#icra_turu').val('ICRA');
    });

    // İcra Ekleme Modalı kapandığında formu sıfırla
    $('#icraModal').on('hidden.bs.modal', function () {
        $('#personel_select').val(null).trigger('change');
        $('#ad_soyad').val('');
        $('#unvan').val('');
        $('#modal_personel_id').val('');
        $('#btnIcraEkle').prop('disabled', true);
    });

    // Ödeme Türü Select2 (çoklu seçim)
    $('#odeme_turu').select2({
        theme: 'bootstrap4',
        placeholder: 'Ödeme türü seçin...',
        allowClear: true,
        multiple: true
    });

    // Raporlama Modalı
    $('#raporlamaModal').on('show.bs.modal', function () {
        // Varsayılan olarak bu ayı seç
        var today = new Date();
        var firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        var formattedDate = firstDay.toISOString().split('T')[0];
        $('#donem').val(formattedDate);
        // Modal açıldığında otomatik sorgu yapma
        $('#raporlamaTable tbody').empty();
    });

    // Kesinti listesi yükleme
    function loadKesintiListesi() {
        var donem = $('#donem').val();
        var odemeTuru = $('#odeme_turu').val();
        var teskilat = $('#teskilat').val();

        if (!donem) {
            return; // Dönem seçilmemişse sessizce çık
        }

        $.ajax({
            url: "{% url 'mutemet_app:icra_kesinti_listesi' %}",
            type: 'GET',
            data: {
                donem: donem,
                odeme_turu: odemeTuru,
                teskilat: teskilat
            },
            success: function(response) {
                var tbody = $('#raporlamaTable tbody');
                tbody.empty();
                
                if (response.data && response.data.length > 0) {
                    response.data.forEach(function(item) {
                        tbody.append(`
                            <tr>
                                <td>
                                    <div class="form-check">
                                        <input class="form-check-input kesinti-checkbox" type="checkbox" value="${item.id}">
                                    </div>
                                </td>
                                <td>${item.ad_soyad}</td>
                                <td>${item.icra_turu}</td>
                                <td>${item.kesildigi_donem || ''}</td>
                                <td>${item.kesilen_tutar}</td>
                                <td>${item.odeme_turu}</td>
                                <td>${item.teskilat || ''}</td>
                            </tr>
                        `);
                    });
                } else {
                    tbody.append(`
                        <tr>
                            <td colspan="7" class="text-center">Seçili kriterlere uygun kayıt bulunamadı.</td>
                        </tr>
                    `);
                }
            },
            error: function() {
                Swal.fire('Hata!', 'Kesinti listesi yüklenirken bir hata oluştu.', 'error');
            }
        });
    }

    // Filtre değişikliklerinde listeyi güncelle
    $('#donem').on('change', function() {
        loadKesintiListesi();
    });

    $('#odeme_turu, #teskilat').on('change', function() {
        if ($('#donem').val()) {
            loadKesintiListesi();
        }
    });

    // Tümünü seç/kaldır
    $('#tumunuSecCheckbox').change(function() {
        $('.kesinti-checkbox').prop('checked', $(this).prop('checked'));
    });

    // Tümünü seç butonu
    $('#tumunuSec').click(function() {
        $('.kesinti-checkbox').prop('checked', true);
        $('#tumunuSecCheckbox').prop('checked', true);
    });

    // Rapor oluştur butonunun submitini engelle, sadece seçili kayıtlarla çalışsın
    $('#raporlamaForm').on('submit', function(e) {
        e.preventDefault();
        $('#raporOlustur').trigger('click');
    });

    $('#raporOlustur').on('click', function(e) {
        e.preventDefault();
        var seciliKesintiler = $('.kesinti-checkbox:checked').map(function() {
            return $(this).val();
        }).get();

        if (seciliKesintiler.length === 0) {
            Swal.fire('Uyarı!', 'Lütfen en az bir kesinti seçiniz.', 'warning');
            return;
        }

        var donem = $('#donem').val();
        var odemeTuru = $('#odeme_turu').val();
        var teskilat = $('#teskilat').val();

        var url = `{% url 'mutemet_app:aylik_icra_kesinti' %}?donem=${donem}&secili_kesintiler=${seciliKesintiler.join(',')}`;
        if (odemeTuru) url += `&odeme_turu=${odemeTuru}`;
        if (teskilat) url += `&teskilat=${teskilat}`;

        window.location.href = url;
    });
});
</script>
{% endblock %}
