{% extends "base.html" %}
{% load crispy_forms_tags %}
{% block title %}Nöbet Defteri Detayı{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row align-items-center mb-3">
        <div class="col">
            <h4>
                Nöbet Defteri: {{ defter.tarih|date:"d.m.Y" }} - {{ defter.nobet_turu }}
            </h4>
        </div>
        <div class="col-auto text-end">
            <a href="{% url 'nobet_defteri:liste' %}" class="btn btn-secondary">Geri Dön</a>
        </div>
    </div>

    {% if defter.onayli %}
        <div class="alert alert-success">
            Bu defter <strong>{{ defter.onaylayan.get_full_name }}</strong> tarafından {{ defter.onay_tarihi|date:"d.m.Y H:i" }} tarihinde onaylanmıştır.
        </div>
    {% endif %}

    <div class="row">
        <div class="col-md-4">
            {% if not defter.onayli %}
            <h5>Yeni Olay Kaydı</h5>
            <form method="POST" class="mb-4">
                {% csrf_token %}
                <div class="mb-2">
                    {{ form.saat|as_crispy_field }}
                </div>
                <div class="mb-2">
                    {{ form.konu|as_crispy_field }}
                    <datalist id="konu_datalist">
                        <option value="Devriye 1"></option>
                        <option value="Devriye 2"></option>
                        <option value="Devriye 3"></option>
                        <option value="Devriye 4"></option>
                    </datalist>
                </div>
                <div class="mb-2" style="color: red;">
                    {{ form.onemli|as_crispy_field }}
                </div>
                <div class="mb-2">
                    {{ form.detay|as_crispy_field }}
                    <div class="mt-2">
                        <span class="badge bg-light text-dark border pointer" onclick="setDetay('Herhangi bir problem yok')">Herhangi bir problem yok</span>
                        <span class="badge bg-light text-dark border pointer" onclick="setDetay('Devriye tamamlandı')">Devriye tamamlandı</span>
                        <span class="badge bg-light text-dark border pointer" onclick="setDetay('Olay yok')">Olay yok</span>
                        <!-- İstediğiniz kadar ekleyebilirsiniz -->
                    </div>
                </div>
                <div class="mt-2">
                    <button type="submit" name="olay_ekle" class="btn btn-success">Olayı Kaydet</button>
                </div>
            </form>
            <style>
                .pointer { cursor: pointer; margin-right: 4px; margin-bottom: 2px; }
            </style>
            <script>
                function setDetay(text) {
                    var textarea = document.getElementById('id_detay');
                    if (textarea) {
                        textarea.value = text;
                    }
                }
            </script>
            {% else %}
            <div class="alert alert-info">Bu defter onaylandığı için yeni olay eklenemez.</div>
            {% endif %}
            <hr>
            <h5>Nobetçi Tekniker Ziyaret Kaydı</h5>
            {% if tekniker_hata %}
            <div class="alert alert-danger">{{ tekniker_hata }}</div>
            {% endif %}
            <form method="POST" class="mb-3">
                {% csrf_token %}
                {{ tekniker_form|crispy }}
                <button type="submit" name="tekniker_ekle" class="btn btn-primary">Tekniker Kaydet</button>
            </form>
            <table class="table table-sm table-bordered">
                <thead>
                    <tr>
                        <th>Tekniker Adı</th>
                        <th>Geliş Saati</th>
                        <th>Ayrılış Saati</th>
                        <th>İşlem</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tekniker in teknikerler %}
                    <tr>
                        <td>{{ tekniker.tekniker_adi }}</td>
                        <td>{{ tekniker.gelis_saati }}</td>
                        <td>{{ tekniker.ayrilis_saati }}</td>
                        <td>
                            {% if is_defter_creator and not defter.onayli %}
                            <form method="POST" action="{% url 'nobet_defteri:tekniker_sil' defter.id tekniker.id %}" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Silmek istediğinize emin misiniz?')">Sil</button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center">Kayıt yok.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="col-md-8">
            <h5>Olay Kayıtları</h5>
            <table class="table table-sm table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Saat</th>
                        <th>Konu</th>
                        <th>Detay</th>
                        <th>Önemli</th>
                        <th>Ekleyen</th>
                        <th>Eklenme Zamanı</th>
                    </tr>
                </thead>
                <tbody>
                    {% for olay in olaylar %}
                    <tr>
                        <td>{{ olay.saat }}</td>
                        <td>{{ olay.konu }}</td>
                        <td>{{ olay.detay }}</td>
                        <td>{% if olay.onemli %}<span class="text-danger fw-bold">Evet</span>{% else %}-{% endif %}</td>
                        <td>{{ olay.ekleyen.FullName }}</td>
                        <td>{{ olay.eklenme_zamani|date:"d.m.Y H:i" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center">Kayıt bulunamadı.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <br>
            <h3>Nöbetçi Memur Kontrol Formu</h3>
            <style>
                /* Cevap radio'larının yatay (yan yana) görünmesi için */
                .kontrol-cevap-field { display: flex; gap: 12px; align-items: center; justify-content: center; }
                /* Eğer widget'lar bootstrap .form-check ile sarılıysa alt boşlukları kaldır */
                .kontrol-cevap-field .form-check { margin-bottom: 0; }
                /* Radio inputları ve etiket aralığı */
                .kontrol-cevap-field input[type="radio"] { margin-right: 4px; }
            </style>
            <form method="post">
            {% csrf_token %}
            <table class="table table-bordered">
                <thead>
                <tr>
                    <th>SORULAR</th>
                    <th class="text-center">EVET/HAYIR</th>
                    <th>AÇIKLAMALAR</th>
                </tr>
                </thead>
                <tbody>
                {% for item in kontrol_items %}
                <tr>
                    <td>{{ item.soru.soru_metni }}</td>
                    <td class="text-center">
                        <div class="kontrol-cevap-field">
                            {% if item.cevap_field %}
                                {% for val,label in item.cevap_field.field.choices %}
                                    {# radio id: base id + index #}
                                    {% with id=item.cevap_field.auto_id|default:''|add:'_'|add:forloop.counter|stringformat:"s" %}
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio"
                                                   name="{{ item.cevap_field.html_name }}"
                                                   id="{{ id }}"
                                                   value="{{ val }}"
                                                   {% if item.cevap_field.value|stringformat:"s" == val|stringformat:"s" %}checked{% endif %}>
                                            <label class="form-check-label" for="{{ id }}">{{ label }}</label>
                                        </div>
                                    {% endwith %}
                                {% endfor %}
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        {% if item.aciklama_field %}
                            {{ item.aciklama_field }}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
            <button type="submit" name="kontrol_formu_kaydet" class="btn btn-success">
                Kontrol Formunu Kaydet
            </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}
